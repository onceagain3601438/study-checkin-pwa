<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‰∏ì‰∏öÁöÑÂ≠¶‰π†ÊâìÂç°ÁÆ°ÁêÜÂ∑•ÂÖ∑ÔºåÊîØÊåÅËØ≠Èü≥ÊèêÈÜí„ÄÅÊó•ÂéÜËßÜÂõæ„ÄÅÂ≠¶‰π†ËÆ°ÂàíÁÆ°ÁêÜ„ÄÅÁßØÂàÜÂ•ñÂä±Á≥ªÁªü">
    <meta name="keywords" content="Â≠¶‰π†ÊâìÂç°,Â≠¶‰π†ËÆ°Âàí,ÁßØÂàÜÂ•ñÂä±,ËØ≠Èü≥ÊèêÈÜí,Â≠¶‰π†ÁÆ°ÁêÜ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Â≠¶‰π†ÊâìÂç°">
    
    <title>Â≠¶‰π†ÊâìÂç° - ‰∏ì‰∏öÁöÑÂ≠¶‰π†ÁÆ°ÁêÜÂ∑•ÂÖ∑ (Âê´ËØ≠Èü≥ÊèêÈÜí)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- ÂõæÊ†á -->
    <link rel="icon" href="/icon-72.png" sizes="72x72">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- ÂºïÂÖ•ËØ≠Èü≥ÊèêÈÜíÊ®°Âùó -->
    <script src="voice-reminder.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 60px;
        }
        
        /* ËØ≠Èü≥ÊèêÈÜíÊåáÁ§∫Âô® */
        .voice-indicator {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            animation: pulse 2s infinite;
        }
        
        .voice-indicator.disabled {
            background: #999;
            animation: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            height: 60px;
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        .nav-text {
            font-size: 10px;
            font-weight: bold;
        }
        
        /* È°µÈù¢ÂÆπÂô® */
        .page {
            display: none;
            padding: 10px;
            min-height: calc(100vh - 60px);
        }
        
        .page.active {
            display: block;
        }
        
        /* Â§¥ÈÉ®Ê†∑Âºè */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .page-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .total-points {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 5px 10px;
        }
        
        .points-value {
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
            margin: 0 3px;
        }
        
        /* È°µÈù¢Âà∑Êñ∞ÊåâÈíÆÊ†∑Âºè */
        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        /* üÜï ËØ≠Èü≥ÂàùÂßãÂåñÈÄöÁü•Âä®ÁîªÊ†∑Âºè */
        @keyframes slideInStay {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0); 
            }
        }

        @keyframes fadeInOut {
            0%, 100% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-10px); 
            }
            15%, 85% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0); 
            }
        }

        /* ËØ≠Èü≥ÈîôËØØÈÄöÁü•Ê†∑Âºè */
        .voice-init-error {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            max-width: 90%;
            text-align: center;
            animation: slideInStay 0.5s ease-out;
        }

        .voice-init-error button {
            margin-top: 8px;
            padding: 4px 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .voice-init-error button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }
        
        .refresh-btn.testing {
            background: rgba(255, 193, 7, 0.8);
            border-color: rgba(255, 193, 7, 1);
            animation: pulse-test 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse-test {
            from { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            to { 
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
        }
        
        /* Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫ */
        .refresh-success {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
            z-index: 3000;
            animation: slideInOut 2s ease-in-out;
        }
        
        @keyframes slideInOut {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-20px); 
            }
            15%, 85% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0); 
            }
            100% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-20px); 
            }
        }
        
        /* Êó•ÂéÜÊ†∑Âºè */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .month-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .current-month {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .quick-today {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .calendar-main {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .week-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 10px;
        }
        
        .week-day {
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            padding: 5px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            position: relative;
            background: #f8f9fa;
        }
        
        .calendar-day.current-month {
            background: white;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        
        .calendar-day.has-record {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border: 1px solid #667eea;
        }
        
        .day-points {
            font-size: 8px;
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 1px 3px;
            border-radius: 3px;
            margin-top: 2px;
        }
        
        /* Â≠¶‰π†ËÆ°ÂàíÊ†∑Âºè */
        .plan-item {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .plan-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plan-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .plan-actions {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            cursor: pointer;
            font-size: 12px;
        }
        
        /* ‰ªªÂä°Ë°®Ê†º */
        .tasks-table {
            padding: 15px;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 1fr 1.5fr 0.5fr 0.5fr 0.8fr 0.8fr;
            gap: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 1.5fr 0.5fr 0.5fr 0.8fr 0.8fr;
            gap: 5px;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 11px;
        }
        
        .time-slot-btn {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            text-align: center;
            min-width: 50px;
            position: relative;
        }
        
        .time-slot-btn.has-time {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .time-slot-btn.no-time {
            background: #f8f9fa;
            color: #666;
            border: 1px dashed #ddd;
        }
        
        .time-slot-btn.has-reminder::after {
            content: "üîä";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 8px;
            background: #51cf66;
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .points-btn {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            text-align: center;
            min-width: 50px;
        }
        
        .points-btn.has-points {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: white;
        }
        
        .points-btn.no-points {
            background: #f8f9fa;
            color: #666;
            border: 1px dashed #ddd;
        }
        
        .task-text {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .task-text:hover {
            background: #f8f9ff;
        }
        
        .delete-task-btn {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            margin: 0 auto;
        }
        
        .delete-task-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: scale(1.1);
        }
        
        .delete-task-btn:active {
            transform: scale(0.95);
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid #ddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .checkbox.checked {
            background: linear-gradient(135deg, #51cf66, #69db7c);
            border-color: #51cf66;
        }
        
        .check-mark {
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: white;
        }
        
        .add-plan-btn {
            width: 100%;
            height: 40px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            margin: 20% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .form-textarea {
            height: 60px;
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
        }
        
        @media (max-width: 480px) {
            .table-header, .table-row {
                font-size: 10px;
                grid-template-columns: 0.8fr 1.2fr 0.4fr 0.4fr 0.6fr 0.6fr;
            }
            
            .time-slot-btn, .points-btn {
                font-size: 9px;
                min-width: 35px;
                padding: 2px 4px;
            }
            
            .delete-task-btn {
                width: 18px;
                height: 18px;
                font-size: 9px;
            }
            
            .move-task-btn {
                width: 18px;
                height: 18px;
                font-size: 8px;
            }
            
            .checkbox {
                width: 15px;
                height: 15px;
            }
            
            .task-text {
                font-size: 10px;
            }
        }
        
        /* Âø´ÈÄüÊìç‰ΩúÊåâÈíÆÊ†∑Âºè */
        .quick-action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quick-action-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .quick-action-btn:active {
            transform: translateY(0);
        }
        
        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .quick-action-btn:hover::before {
            left: 100%;
        }
        
        .btn-copy {
            background: linear-gradient(135deg, #ff9a56, #ff6b35);
            color: white;
        }
        
        .btn-template {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-default {
            background: linear-gradient(135deg, #51cf66, #69db7c);
            color: white;
        }
        
        /* üÜï ‰ªªÂä°ÁßªÂä®ÊåâÈíÆÊ†∑Âºè */
        .move-task-btn {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .move-task-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #4c6ef5;
            transform: scale(1.1);
        }
        
        .move-task-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- ËØ≠Èü≥ÊèêÈÜíÁä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div id="voiceIndicator" class="voice-indicator">
        üîä ËØ≠Èü≥ÊèêÈÜíÂ∑≤ÂêØÁî®
    </div>

    <!-- Êó•ÂéÜÈ°µÈù¢ -->
    <div class="page active" id="calendarPage">
        <div class="header">
            <!-- È°µÈù¢Âà∑Êñ∞ÊåâÈíÆ -->
            <div class="refresh-btn" 
                 onclick="refreshPage('calendar')" 
                 oncontextmenu="return handleRefreshTest(event, 'calendar')"
                 title="ÁÇπÂáªÂà∑Êñ∞È°µÈù¢ÔºåÂè≥ÈîÆÊàñÈïøÊåâËøõË°åÂäüËÉΩÊµãËØï">
                üîÑ
            </div>
            <div class="header-content">
                <span class="page-title">Â≠¶‰π†ÊâìÂç°Êó•ÂéÜ</span>
                <div class="total-points">
                    <span>üèÜ</span>
                    <span class="points-value" id="totalPointsCalendar">0</span>
                    <span>ÊÄªÁßØÂàÜ</span>
                </div>
            </div>
            <div style="text-align: center; font-size: 12px; opacity: 0.9;">
                üìÖ ÊØè‰∏ÄÂ§©ÈÉΩÊòØÊñ∞ÁöÑÂºÄÂßã ÂùöÊåÅÂ≠¶‰π†ÔºåËÆ©Êó∂Èó¥ËßÅËØÅÊàêÈïøÁöÑÂäõÈáè ‚ú®
            </div>
        </div>

        <div class="calendar-header">
            <div class="month-navigation">
                <div class="nav-btn" onclick="changeMonth(-1)">‚Äπ</div>
                <span class="current-month" id="currentMonth">2025Âπ¥01Êúà</span>
                <div class="nav-btn" onclick="changeMonth(1)">‚Ä∫</div>
            </div>
            <div class="quick-today" onclick="goToToday()">üìç ‰ªäÊó•</div>
        </div>

        <div class="calendar-main">
            <div class="week-header">
                <div class="week-day">Êó•</div>
                <div class="week-day">‰∏Ä</div>
                <div class="week-day">‰∫å</div>
                <div class="week-day">‰∏â</div>
                <div class="week-day">Âõõ</div>
                <div class="week-day">‰∫î</div>
                <div class="week-day">ÂÖ≠</div>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Êó•ÂéÜÊó•ÊúüÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-number" id="monthStudyDays">0</span>
                <span class="stat-label">Â≠¶‰π†Â§©Êï∞</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="monthTasks">0</span>
                <span class="stat-label">ÂÆåÊàê‰ªªÂä°</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="monthPoints">0</span>
                <span class="stat-label">ÊúàÂ∫¶ÁßØÂàÜ</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="monthCompletion">0%</span>
                <span class="stat-label">Âπ≥ÂùáÂÆåÊàêÁéá</span>
            </div>
        </div>
    </div>

    <!-- Â≠¶‰π†ËÆ°ÂàíÈ°µÈù¢ -->
    <div class="page" id="studyPage">
        <div class="header">
            <!-- È°µÈù¢Âà∑Êñ∞ÊåâÈíÆ -->
            <div class="refresh-btn" 
                 onclick="refreshPage('study')" 
                 oncontextmenu="return handleRefreshTest(event, 'study')"
                 title="ÁÇπÂáªÂà∑Êñ∞È°µÈù¢ÔºåÂè≥ÈîÆÊàñÈïøÊåâËøõË°åÂäüËÉΩÊµãËØï">
                üîÑ
            </div>
            <div class="header-content">
                <span class="page-title">Â≠¶‰π†ËÆ°Âàí</span>
                <div class="total-points">
                    <span>üèÜ</span>
                    <span class="points-value" id="totalPointsStudy">0</span>
                    <span>ÊÄªÁßØÂàÜ</span>
                </div>
            </div>
            <div style="text-align: center; font-size: 12px; opacity: 0.9;">
                üí™ ÂùöÊåÅÊØè‰∏ÄÂ§©ÔºåÊàêÂ∞±Êõ¥Â•ΩÁöÑËá™Â∑±ÔºÅ
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 10px;">
            <button class="btn btn-primary" onclick="changeDate(-1)">‚Äπ Ââç‰∏ÄÂ§©</button>
            <span id="currentStudyDate" style="margin: 0 10px; font-weight: bold;">2025Âπ¥01Êúà07Êó•</span>
            <button class="btn btn-primary" onclick="changeDate(1)">Âêé‰∏ÄÂ§© ‚Ä∫</button>
        </div>

        <div id="studyPlans"></div>

        <div class="empty-state" id="emptyState">
            <div style="font-size: 30px; margin-bottom: 10px;">üìö</div>
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">ËøòÊ≤°ÊúâÂ≠¶‰π†ËÆ°Âàí</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 20px;">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Â≠¶‰π†ËÆ°Âàí</div>
            
            <!-- Âø´ÈÄüÊìç‰ΩúÊåâÈíÆÁªÑ -->
            <div class="quick-action-buttons">
                <button class="quick-action-btn btn-copy" onclick="copyYesterday()" style="font-size: 11px; padding: 8px 4px;">
                    üìã Â§çÂà∂Êò®Â§©
                </button>
                <button class="quick-action-btn btn-template" onclick="loadTemplate()" style="font-size: 11px; padding: 8px 4px;">
                    üìÅ Âä†ËΩΩÊ®°Êùø
                </button>
                <button class="quick-action-btn btn-default" onclick="loadDefaultPlan()" style="font-size: 11px; padding: 8px 4px;">
                    ‚≠ê ÈªòËÆ§ËÆ°Âàí
                </button>
            </div>
        </div>

        <button class="add-plan-btn" onclick="showAddPlanModal()">+ Ê∑ªÂä†Â≠¶‰π†ËÆ°Âàí</button>
    </div>

    <!-- ÁßØÂàÜÈ°µÈù¢ -->
    <div class="page" id="pointsPage">
        <div class="header">
            <!-- È°µÈù¢Âà∑Êñ∞ÊåâÈíÆ -->
            <div class="refresh-btn" 
                 onclick="refreshPage('points')" 
                 oncontextmenu="return handleRefreshTest(event, 'points')"
                 title="ÁÇπÂáªÂà∑Êñ∞È°µÈù¢ÔºåÂè≥ÈîÆÊàñÈïøÊåâËøõË°åÂäüËÉΩÊµãËØï">
                üîÑ
            </div>
            <div class="header-content">
                <span class="page-title">ÁßØÂàÜ‰∏≠ÂøÉ</span>
                <div class="total-points">
                    <span>üèÜ</span>
                    <span class="points-value" id="totalPointsCenter">0</span>
                    <span>ÊÄªÁßØÂàÜ</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-number" id="todayPoints">0</span>
                <span class="stat-label">‰ªäÊó•ÁßØÂàÜ</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="weekPoints">0</span>
                <span class="stat-label">Êú¨Âë®ÁßØÂàÜ</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="monthPointsCenter">0</span>
                <span class="stat-label">Êú¨ÊúàÁßØÂàÜ</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalPointsDisplay">0</span>
                <span class="stat-label">Á¥ØËÆ°ÁßØÂàÜ</span>
            </div>
        </div>

        <div id="pointsHistory" style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);">
            <h3 style="margin-bottom: 10px; font-size: 14px;">ÁßØÂàÜÂéÜÂè≤</h3>
            <div id="pointsHistoryList"></div>
        </div>

        <!-- üÜï Â•ñÂä±Á≥ªÁªüÂå∫Âüü -->
        <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 16px; color: #333;">üéÅ ÁßØÂàÜÂ•ñÂä±</h3>
                <button onclick="showRewardSettings()" style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 8px;
                    font-weight: bold;
                    cursor: pointer;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                ">
                    ‚öôÔ∏è ËÆæÁΩÆÂ•ñÂä±
                </button>
            </div>
            
            <!-- Â•ñÂä±ËøõÂ∫¶Ê¶ÇËßà -->
            <div id="nextRewardPreview" style="margin-bottom: 15px; padding: 12px; background: #f8f9ff; border-radius: 10px; font-size: 13px; color: #666;">
                Ê≠£Âú®Âä†ËΩΩÂ•ñÂä±‰ø°ÊÅØ...
            </div>
            
            <!-- ÂÆåÊï¥Â•ñÂä±ÂàóË°® -->
            <div id="rewardListInPoints">
                <!-- Â•ñÂä±ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- Ê®°ÊùøÈ°µÈù¢ -->
    <div class="page" id="templatePage">
        <div class="header">
            <!-- È°µÈù¢Âà∑Êñ∞ÊåâÈíÆ -->
            <div class="refresh-btn" 
                 onclick="refreshPage('template')" 
                 oncontextmenu="return handleRefreshTest(event, 'template')"
                 title="ÁÇπÂáªÂà∑Êñ∞È°µÈù¢ÔºåÂè≥ÈîÆÊàñÈïøÊåâËøõË°åÂäüËÉΩÊµãËØï">
                üîÑ
            </div>
            <div class="header-content">
                <span class="page-title">Â≠¶‰π†Ê®°Êùø</span>
            </div>
        </div>

        <div class="empty-state">
            <div style="font-size: 30px; margin-bottom: 10px;">üìù</div>
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">Ê®°ÊùøÂäüËÉΩÂºÄÂèë‰∏≠</div>
            <div style="font-size: 12px; color: #666;">Êï¨ËØ∑ÊúüÂæÖÔºÅ</div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('calendar')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-text">Êó•ÂéÜ</div>
        </div>
        <div class="nav-item" onclick="switchPage('study')">
            <div class="nav-icon">üìö</div>
            <div class="nav-text">Â≠¶‰π†</div>
        </div>
        <div class="nav-item" onclick="switchPage('points')">
            <div class="nav-icon">üèÜ</div>
            <div class="nav-text">ÁßØÂàÜ</div>
        </div>
        <div class="nav-item" onclick="switchPage('template')">
            <div class="nav-icon">üìù</div>
            <div class="nav-text">Ê®°Êùø</div>
        </div>
    </div>

    <!-- Ê∑ªÂä†ËÆ°ÂàíÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="addPlanModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Ê∑ªÂä†Â≠¶‰π†ËÆ°Âàí</span>
                <button class="close-btn" onclick="hideAddPlanModal()">&times;</button>
            </div>
            <form id="addPlanForm">
                <div class="form-group">
                    <label class="form-label">ËÆ°ÂàíÂêçÁß∞</label>
                    <input type="text" class="form-input" id="planName" placeholder="ËØ∑ËæìÂÖ•ËÆ°ÂàíÂêçÁß∞" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Â≠¶‰π†‰ªªÂä°ÔºàÊØèË°å‰∏Ä‰∏™Ôºâ</label>
                    <textarea class="form-textarea" id="planTasks" placeholder="‰ªªÂä°ÂêçÁß∞|ÁßØÂàÜ&#10;‰æãÂ¶ÇÔºöÈòÖËØª30ÂàÜÈíü|10&#10;ËÉåÂçïËØç50‰∏™|15" required></textarea>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="hideAddPlanModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">Ê∑ªÂä†</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáèÂÆö‰πâ
        let studyData = {};
        let currentStudyDate = new Date();
        let currentPage = 'calendar';
        let voiceReminder = null; // üÜï ËØ≠Èü≥ÊèêÈÜíÂØπË±°ÂÖ®Â±ÄÂèòÈáè
        
        // üÜï Â•ñÂä±Á≥ªÁªüÂèòÈáè
        let rewardSettings = []; // Â•ñÂä±ËÆæÁΩÆÊï∞ÁªÑ
        let claimedRewards = []; // Â∑≤È¢ÜÂèñÁöÑÂ•ñÂä±ËÆ∞ÂΩï
        let lastTotalPoints = 0; // ‰∏äÊ¨°Ê£ÄÊü•Êó∂ÁöÑÊÄªÁßØÂàÜÔºåÁî®‰∫éÊ£ÄÊµãÁßØÂàÜÂ¢ûÈïø
        
        // Êó•ÊúüÊ†ºÂºèÂåñ
        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // È°µÈù¢ÂàáÊç¢
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(page + 'Page').classList.add('active');
            document.querySelector(`[onclick="switchPage('${page}')"]`).classList.add('active');
            
            if (page === 'study') {
                updateStudyDisplay();
            } else if (page === 'calendar') {
                updateCalendarDisplay();
            } else if (page === 'points') {
                updatePointsDisplay();
            }
        }

        // ÂàùÂßãÂåñ
        function init() {
            loadData();
            updateTotalPoints();
            updateCalendarDisplay();
            updateStudyDisplay();
            updatePointsDisplay();
            
            // üÜï ÂàùÂßãÂåñÂ•ñÂä±Á≥ªÁªü
            loadRewardData();
            updateRewardPreview();
            renderRewardListInPoints();
            
            console.log('ÂºÄÂßãÂàùÂßãÂåñËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü...');
            
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
            if (!('speechSynthesis' in window)) {
                console.error('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÂäüËÉΩ');
                alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂäüËÉΩÔºåÂª∫ËÆÆ‰ΩøÁî®Chrome„ÄÅFirefoxÊàñSafariÊµèËßàÂô®');
                return;
            }
            
            // üÜï ‰ΩøÁî®Â¢ûÂº∫ÁâàËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÂàùÂßãÂåñ
            if (typeof VoiceReminder !== 'undefined') {
                console.log('üé§ ÂºÄÂßãÂàùÂßãÂåñÂ¢ûÂº∫ÁâàËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü...');
                
                // ‰ΩøÁî®Êñ∞ÁöÑÂ¢ûÂº∫ÁâàÂàùÂßãÂåñÂáΩÊï∞
                initializeVoiceReminderWithRetry();
                
                // Âª∂ËøüËÆæÁΩÆÂÖ®Â±ÄÊï∞ÊçÆÂíåÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ª
                setTimeout(() => {
                    // Â∞ÜÊï∞ÊçÆÊö¥Èú≤ÁªôÂÖ®Â±Ä
                    window.studyData = studyData;
                    window.currentStudyDate = currentStudyDate;
                    
                    console.log('üìä ÂÖ®Â±ÄÊï∞ÊçÆÂ∑≤ËÆæÁΩÆ');
                    
                    // Â¶ÇÊûúËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäüÔºåËÆæÁΩÆÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ª
                    if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                        setupVoiceActivation();
                    } else {
                        console.warn('‚ö†Ô∏è ËØ≠Èü≥Á≥ªÁªüÊú™ÂÆåÂÖ®ÂàùÂßãÂåñÔºåË∑≥ËøáÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ªËÆæÁΩÆ');
                    }
                    
                }, 2000); // ÁªôËØ≠Èü≥ÂàùÂßãÂåñÊõ¥Â§öÊó∂Èó¥
                
            } else {
                console.error('‚ùå VoiceReminderÁ±ªÊú™ÊâæÂà∞ÔºåËØ∑Ê£ÄÊü•voice-reminder.jsÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ');
                showVoiceInitError('VoiceReminderÁ±ªÊú™ÊâæÂà∞ÔºåËØ≠Èü≥ÂäüËÉΩ‰∏çÂèØÁî®');
            }
            
            // ‰∏ªÂä®ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê
            requestNotificationPermissionNow();
            
            // Ê≥®ÂÜåService Worker
            registerServiceWorkerWithRetry();
        }

        /**
         * ËÆæÁΩÆËØ≠Èü≥ÊøÄÊ¥ªÊú∫Âà∂
         * Âú®Áî®Êà∑È¶ñÊ¨°‰∫§‰∫íÊó∂ÊøÄÊ¥ªËØ≠Èü≥ÂäüËÉΩ
         */
        function setupVoiceActivation() {
            let voiceActivated = false;
            let activationAttempts = 0;
            const maxAttempts = 10;
            
            // Ê£ÄÊµãÊµèËßàÂô®Á±ªÂûã
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isStrictBrowser = isChrome || isFirefox;
            
            console.log('üîç ÊµèËßàÂô®Ê£ÄÊµã:', { isChrome, isFirefox, isSafari, isStrictBrowser });
            
            const activateVoice = async (eventType = 'unknown') => {
                if (voiceActivated || !voiceReminder) return;
                
                activationAttempts++;
                console.log(`üéØ Áî®Êà∑‰∫§‰∫íÊ£ÄÊµãÂà∞ (${eventType})ÔºåÂ∞ùËØïÊøÄÊ¥ªËØ≠Èü≥ÂäüËÉΩ... (Á¨¨${activationAttempts}Ê¨°)`);
                
                try {
                    // ÈíàÂØπ‰∏•Ê†ºÊµèËßàÂô®‰ΩøÁî®Â¢ûÂº∫ÊøÄÊ¥ª
                    if (isStrictBrowser) {
                        console.log('üîí Ê£ÄÊµãÂà∞‰∏•Ê†ºÊµèËßàÂô®Ôºå‰ΩøÁî®Â¢ûÂº∫ÊøÄÊ¥ªÊú∫Âà∂...');
                        
                        // Â§öÈáçÊøÄÊ¥ªÁ≠ñÁï•
                        const activationPromises = [
                            // Á≠ñÁï•1ÔºöÂü∫Á°ÄÊøÄÊ¥ª
                            voiceReminder.activateSpeechSynthesis(),
                            // Á≠ñÁï•2ÔºöÂº∫Âà∂ÊøÄÊ¥ªÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                            voiceReminder.forceActivateForStrictBrowsers ? voiceReminder.forceActivateForStrictBrowsers() : Promise.resolve(true)
                        ];
                        
                        await Promise.all(activationPromises);
                        
                        // È¢ùÂ§ñÁöÑÊøÄÊ¥ªÂ∞ùËØï
                        setTimeout(() => {
                            try {
                                const testUtterance = new SpeechSynthesisUtterance('');
                                testUtterance.volume = 0.01;
                                testUtterance.rate = 10;
                                speechSynthesis.speak(testUtterance);
                            } catch (error) {
                                console.warn('È¢ùÂ§ñÊøÄÊ¥ªÂ∞ùËØïÂ§±Ë¥•:', error);
                            }
                        }, 100);
                        
                    } else {
                        // SafariÁ≠âÈùû‰∏•Ê†ºÊµèËßàÂô®‰ΩøÁî®Ê†áÂáÜÊøÄÊ¥ª
                        voiceReminder.engineActivated = false;
                        voiceReminder.activateSpeechSynthesis();
                    }
                    
                    // È™åËØÅÊøÄÊ¥ªÊòØÂê¶ÊàêÂäü
                    setTimeout(async () => {
                        const isReady = voiceReminder.checkVoiceEngineReady ? await voiceReminder.checkVoiceEngineReady() : true;
                        
                        if (isReady || activationAttempts >= maxAttempts) {
                            voiceActivated = true;
                            console.log('‚úÖ ËØ≠Èü≥ÂäüËÉΩÂ∑≤ÈÄöËøáÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ª');
                            
                            // Êí≠ÊîæÊøÄÊ¥ªÊàêÂäüÊèêÁ§∫Ôºà‰ªÖÈÄÇÁî®‰∫éÈùû‰∏•Ê†ºÊµèËßàÂô®ÊàñÂº∫Âà∂Ê®°ÂºèÔºâ
                            if (!isStrictBrowser || activationAttempts >= 3) {
                                try {
                                    const testUtterance = new SpeechSynthesisUtterance('ËØ≠Èü≥ÂäüËÉΩÂ∑≤ÊøÄÊ¥ª');
                                    testUtterance.volume = 0.1;
                                    testUtterance.rate = 2;
                                    speechSynthesis.speak(testUtterance);
                                } catch (error) {
                                    console.warn('ÊøÄÊ¥ªÊèêÁ§∫Êí≠ÊîæÂ§±Ë¥•:', error);
                                }
                            }
                            
                            // Êõ¥Êñ∞Áä∂ÊÄÅÊåáÁ§∫Âô®
                            updateVoiceIndicator();
                            
                            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
                            removeActivationListeners();
                            
                        } else if (activationAttempts < maxAttempts) {
                            console.log('üîÑ ËØ≠Èü≥ÂºïÊìé‰ªçÊú™ÂáÜÂ§áÂ∞±Áª™ÔºåÁªßÁª≠ÁõëÂê¨Áî®Êà∑‰∫§‰∫í...');
                        } else {
                            console.warn('‚ö†Ô∏è Â∑≤ËææÂà∞ÊúÄÂ§ßÊøÄÊ¥ªÂ∞ùËØïÊ¨°Êï∞ÔºåÂÅúÊ≠¢Â∞ùËØï');
                            removeActivationListeners();
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('üí• ËØ≠Èü≥ÊøÄÊ¥ªÂ§±Ë¥•:', error);
                    
                    if (activationAttempts < maxAttempts) {
                        console.log('üîÑ ÊøÄÊ¥ªÂ§±Ë¥•ÔºåÁªßÁª≠ÁõëÂê¨Áî®Êà∑‰∫§‰∫í...');
                    } else {
                        console.error('‚ùå Â∑≤ËææÂà∞ÊúÄÂ§ßÊøÄÊ¥ªÂ∞ùËØïÊ¨°Êï∞');
                        removeActivationListeners();
                    }
                }
            };
            
            // ÂàõÂª∫ÂåÖË£ÖÂáΩÊï∞Ôºå‰º†ÈÄí‰∫ã‰ª∂Á±ªÂûã
            const clickActivate = (e) => activateVoice('click');
            const touchActivate = (e) => activateVoice('touch');
            const scrollActivate = (e) => activateVoice('scroll');
            const keyActivate = (e) => activateVoice('keydown');
            const mouseActivate = (e) => activateVoice('mousemove');
            
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®ÁöÑÂáΩÊï∞
            const removeActivationListeners = () => {
                document.removeEventListener('click', clickActivate);
                document.removeEventListener('touchstart', touchActivate);
                document.removeEventListener('touchend', touchActivate);
                document.removeEventListener('scroll', scrollActivate);
                document.removeEventListener('keydown', keyActivate);
                document.removeEventListener('mousemove', mouseActivate);
                console.log('üö´ ÊøÄÊ¥ª‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁßªÈô§');
            };
            
            // ÁõëÂê¨Â§öÁßçÁî®Êà∑‰∫§‰∫í‰∫ã‰ª∂Ôºà‰∏•Ê†ºÊµèËßàÂô®ÈúÄË¶ÅÊõ¥Â§öËß¶ÂèëÁÇπÔºâ
            if (isStrictBrowser) {
                // ‰∏•Ê†ºÊµèËßàÂô®ÁõëÂê¨Êõ¥Â§ö‰∫ã‰ª∂
                document.addEventListener('click', clickActivate, { passive: true });
                document.addEventListener('touchstart', touchActivate, { passive: true });
                document.addEventListener('touchend', touchActivate, { passive: true });
                document.addEventListener('scroll', scrollActivate, { passive: true });
                document.addEventListener('keydown', keyActivate, { passive: true });
                document.addEventListener('mousemove', mouseActivate, { passive: true, once: true });
                
                console.log('üëÜ Â∑≤ËÆæÁΩÆÂ¢ûÂº∫Áî®Êà∑‰∫§‰∫íÊøÄÊ¥ªËØ≠Èü≥ÂäüËÉΩÔºà‰∏•Ê†ºÊ®°ÂºèÔºâ');
                
                // È¢ùÂ§ñÊèêÁ§∫Áî®Êà∑
                setTimeout(() => {
                    if (!voiceActivated && activationAttempts === 0) {
                        console.log('üí° ÊèêÁ§∫ÔºöËØ∑ÁÇπÂáªÈ°µÈù¢‰ªªÊÑè‰ΩçÁΩÆ‰ª•ÊøÄÊ¥ªËØ≠Èü≥ÂäüËÉΩ');
                        
                        // ÊòæÁ§∫ÊøÄÊ¥ªÊèêÁ§∫
                        showVoiceActivationTip();
                    }
                }, 3000);
                
            } else {
                // Èùû‰∏•Ê†ºÊµèËßàÂô®‰ΩøÁî®Ê†áÂáÜÁõëÂê¨
                document.addEventListener('click', clickActivate, { passive: true, once: false });
                document.addEventListener('touchstart', touchActivate, { passive: true, once: false });
                document.addEventListener('keydown', keyActivate, { passive: true, once: false });
                
                console.log('üëÜ Â∑≤ËÆæÁΩÆÊ†áÂáÜÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ªËØ≠Èü≥ÂäüËÉΩ');
            }
            
            // Ëá™Âä®Ê∏ÖÁêÜÊú∫Âà∂
            setTimeout(() => {
                if (!voiceActivated) {
                    console.warn('‚è∞ ËØ≠Èü≥ÊøÄÊ¥ªË∂ÖÊó∂ÔºåÊ∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®');
                    removeActivationListeners();
                }
            }, 30000); // 30ÁßíÂêéÊ∏ÖÁêÜ
        }

        /**
         * ÊòæÁ§∫ËØ≠Èü≥ÊøÄÊ¥ªÊèêÁ§∫
         */
        function showVoiceActivationTip() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòæÁ§∫ËøáÊèêÁ§∫
            if (document.querySelector('.voice-activation-tip')) return;
            
            const tip = document.createElement('div');
            tip.className = 'voice-activation-tip';
            tip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 3000;
                animation: tipFadeIn 0.5s ease-out;
                text-align: center;
                max-width: 300px;
                line-height: 1.4;
            `;
            
            tip.innerHTML = `
                üîä ËØ≠Èü≥ÂäüËÉΩÈúÄË¶ÅÊøÄÊ¥ª<br>
                <small style="opacity: 0.9;">ËØ∑ÁÇπÂáªÈ°µÈù¢‰ªªÊÑè‰ΩçÁΩÆ</small><br>
                <button onclick="this.parentElement.remove()" style="
                    background: rgba(255,255,255,0.2);
                    border: none;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 8px;
                    margin-top: 10px;
                    cursor: pointer;
                    font-size: 12px;
                ">Áü•ÈÅì‰∫Ü</button>
            `;
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            const style = document.createElement('style');
            style.textContent = `
                @keyframes tipFadeIn {
                    from { 
                        opacity: 0; 
                        transform: translate(-50%, -50%) scale(0.8); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translate(-50%, -50%) scale(1); 
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(tip);
            
            // 5ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (tip && tip.parentElement) {
                    tip.style.animation = 'tipFadeIn 0.3s ease-out reverse';
                    setTimeout(() => tip.remove(), 300);
                }
            }, 5000);
        }

        // ÊµãËØïËØ≠Èü≥Á≥ªÁªüÂèØÁî®ÊÄß
        function testVoiceSystemAvailability() {
            console.log('ÊµãËØïËØ≠Èü≥Á≥ªÁªüÂèØÁî®ÊÄß...');
            if (voiceReminder) {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÊµãËØïÂü∫Êú¨ËØ≠Èü≥ÂäüËÉΩ');
                try {
                    // Áõ¥Êé•Ë∞ÉÁî®ËØ≠Èü≥ÂêàÊàêAPIÊµãËØï
                    const utterance = new SpeechSynthesisUtterance('ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
                    utterance.volume = 0.1; // Èôç‰ΩéÈü≥ÈáèÈÅøÂÖçÊâìÊâ∞
                    utterance.rate = 1.5;   // Âä†Âø´ËØ≠ÈÄü
                    utterance.onstart = () => console.log('ËØ≠Èü≥ÊµãËØïÂºÄÂßã');
                    utterance.onend = () => console.log('ËØ≠Èü≥ÊµãËØïÂÆåÊàê');
                    utterance.onerror = (e) => console.error('ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•:', e);
                    
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('ËØ≠Èü≥ÊµãËØïÂºÇÂ∏∏:', error);
                }
            } else {
                console.error('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
            }
        }

        // ‰∏ªÂä®ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê
        function requestNotificationPermissionNow() {
            console.log('ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê...');
            if ('Notification' in window) {
                console.log('ÂΩìÂâçÈÄöÁü•ÊùÉÈôêÁä∂ÊÄÅ:', Notification.permission);
                
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then((permission) => {
                        console.log('ÈÄöÁü•ÊùÉÈôêËØ∑Ê±ÇÁªìÊûú:', permission);
                        updateVoiceIndicator();
                        
                        if (permission === 'granted') {
                            console.log('ÈÄöÁü•ÊùÉÈôêÂ∑≤Ëé∑Âæó');
                            // ÊòæÁ§∫ÊµãËØïÈÄöÁü•
                            new Notification('Â≠¶‰π†ÊâìÂç°PWA', {
                                body: 'ÈÄöÁü•ÂäüËÉΩÂ∑≤ÂêØÁî®ÔºÅ',
                                icon: '/icon-192.png'
                            });
                        } else {
                            console.log('ÈÄöÁü•ÊùÉÈôêË¢´ÊãíÁªù');
                        }
                    }).catch((error) => {
                        console.error('ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôêÂ§±Ë¥•:', error);
                    });
                } else {
                    console.log('ÈÄöÁü•ÊùÉÈôêÂ∑≤ËÆæÁΩÆ‰∏∫:', Notification.permission);
                    updateVoiceIndicator();
                }
            } else {
                console.warn('ÊµèËßàÂô®‰∏çÊîØÊåÅÈÄöÁü•API');
            }
        }

        // üÜï Êô∫ËÉΩ Service Worker Ê≥®ÂÜåÔºàÊîØÊåÅÊú¨Âú∞Êñá‰ª∂Ôºâ
        function registerServiceWorkerWithRetry() {
            // Ê£ÄÊü•ÂΩìÂâçÂçèËÆÆ
            const currentProtocol = window.location.protocol;
            const isLocalFile = currentProtocol === 'file:';
            const isHTTPS = currentProtocol === 'https:';
            const isHTTP = currentProtocol === 'http:';
            
            console.log('üåê ÂçèËÆÆÊ£ÄÊµã:', {
                protocol: currentProtocol,
                isLocalFile,
                isHTTPS,
                isHTTP,
                host: window.location.host
            });
            
            // Â¶ÇÊûúÊòØÊú¨Âú∞Êñá‰ª∂ÔºåË∑≥Ëøá Service Worker Ê≥®ÂÜå
            if (isLocalFile) {
                console.log('üìÅ Ê£ÄÊµãÂà∞Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÔºåË∑≥Ëøá Service Worker Ê≥®ÂÜå');
                showLocalFileNotice();
                return Promise.resolve(false);
            }
            
            // Ê£ÄÊü• Service Worker ÊîØÊåÅ
            if (!('serviceWorker' in navigator)) {
                console.warn('‚ö†Ô∏è ÊµèËßàÂô®‰∏çÊîØÊåÅ Service Worker');
                return Promise.resolve(false);
            }
            
            let retryCount = 0;
            const maxRetries = 3;
            
            const attemptRegistration = () => {
                retryCount++;
                console.log(`üîÑ Service Worker Ê≥®ÂÜåÂ∞ùËØï ${retryCount}/${maxRetries}`);
                
                return navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                }).then((registration) => {
                    console.log('‚úÖ Service Worker Ê≥®ÂÜåÊàêÂäü:', registration.scope);
                    return true;
                }).catch((error) => {
                    console.error(`üí• Service Worker Ê≥®ÂÜåÂ§±Ë¥• (Â∞ùËØï ${retryCount}):`, error);
                    
                    if (retryCount < maxRetries) {
                        console.log(`‚è≥ Á≠âÂæÖ ${retryCount * 1000}ms ÂêéÈáçËØï...`);
                        return new Promise(resolve => {
                            setTimeout(() => {
                                attemptRegistration().then(resolve);
                            }, retryCount * 1000);
                        });
                    } else {
                        console.error('‚ùå Service Worker Ê≥®ÂÜåÂ§±Ë¥•ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞');
                        return false;
                    }
                });
            };
            
            return attemptRegistration();
        }

        // üÜï ÊòæÁ§∫Êú¨Âú∞Êñá‰ª∂‰ΩøÁî®ÊèêÁ§∫
        function showLocalFileNotice() {
            console.log('üìã ÊòæÁ§∫Êú¨Âú∞Êñá‰ª∂‰ΩøÁî®ÊèêÁ§∫');
            
            const notice = document.createElement('div');
            notice.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #4ECDC4, #44A08D);
                color: white;
                padding: 12px 20px;
                border-radius: 20px;
                font-size: 13px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
                animation: slideInStay 0.5s ease-out;
            `;
            
            notice.innerHTML = `
                üìÅ Êú¨Âú∞Êñá‰ª∂Ê®°Âºè - Âü∫Á°ÄÂäüËÉΩÊ≠£Â∏∏<br>
                <span style="font-size: 11px; opacity: 0.9;">
                    ÈÉ®ÂàÜÈ´òÁ∫ßÂäüËÉΩÂèóÈôêÔºåÂª∫ËÆÆÈÄöËøáÁΩëÈ°µÊúçÂä°Âô®ËÆøÈóÆ
                </span>
            `;
            
            document.body.appendChild(notice);
            
            // 5ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (notice && notice.parentNode) {
                    notice.remove();
                }
            }, 5000);
        }

        // üÜï Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉËØ≠Èü≥ÊøÄÊ¥ª‰ºòÂåñ
        function activateVoiceForLocalFile() {
            console.log('üìÅ Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉËØ≠Èü≥ÊøÄÊ¥ª...');
            
            if (!window.voiceReminder) {
                console.warn('‚ö†Ô∏è ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™ÂàùÂßãÂåñ');
                return false;
            }
            
            try {
                // Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÁöÑËØ≠Èü≥ÊøÄÊ¥ªÁ≠ñÁï•
                const activationStrategies = [
                    // Á≠ñÁï•1ÔºöÁõ¥Êé•ÊøÄÊ¥ª
                    () => {
                        console.log('üîß Êú¨Âú∞Á≠ñÁï•1ÔºöÁõ¥Êé•ÊøÄÊ¥ª');
                        if (window.voiceReminder.activateSpeechSynthesis) {
                            window.voiceReminder.activateSpeechSynthesis();
                        }
                    },
                    
                    // Á≠ñÁï•2ÔºöiPhone 6‰∏ìÁî®ÊøÄÊ¥ª
                    () => {
                        console.log('üîß Êú¨Âú∞Á≠ñÁï•2ÔºöiPhone 6‰∏ìÁî®ÊøÄÊ¥ª');
                        const isIPhone6 = /iPhone OS 9_|iPhone OS 10_|iPhone OS 11_|iPhone OS 12_/.test(navigator.userAgent);
                        if (isIPhone6 && window.voiceReminder.activateForIPhone6) {
                            window.voiceReminder.activateForIPhone6();
                        }
                    },
                    
                    // Á≠ñÁï•3ÔºöÂº∫Âà∂ÊøÄÊ¥ª
                    () => {
                        console.log('üîß Êú¨Âú∞Á≠ñÁï•3ÔºöÂº∫Âà∂ÊøÄÊ¥ª');
                        if (window.voiceReminder.speechSynthesis) {
                            try {
                                const testUtterance = new SpeechSynthesisUtterance('test');
                                testUtterance.volume = 0.01;
                                testUtterance.rate = 10;
                                window.voiceReminder.speechSynthesis.speak(testUtterance);
                            } catch (error) {
                                console.warn('Âº∫Âà∂ÊøÄÊ¥ªÂ§±Ë¥•:', error);
                            }
                        }
                    }
                ];
                
                // ‰æùÊ¨°ÊâßË°åÊøÄÊ¥ªÁ≠ñÁï•
                activationStrategies.forEach((strategy, index) => {
                    setTimeout(() => {
                        try {
                            strategy();
                        } catch (error) {
                            console.warn(`Êú¨Âú∞ÊøÄÊ¥ªÁ≠ñÁï• ${index + 1} Â§±Ë¥•:`, error);
                        }
                    }, index * 100);
                });
                
                console.log('‚úÖ Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥ÊøÄÊ¥ªÁ≠ñÁï•ÊâßË°åÂÆåÊàê');
                return true;
                
            } catch (error) {
                console.error('üí• Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥ÊøÄÊ¥ªÂ§±Ë¥•:', error);
                return false;
            }
        }

        // üÜï ‰ºòÂåñÁöÑËØ≠Èü≥ÊøÄÊ¥ªÂ§ÑÁêÜÔºàÊîØÊåÅÊú¨Âú∞Êñá‰ª∂Ôºâ
        function handleVoiceActivation() {
            console.log('üéØ Â§ÑÁêÜËØ≠Èü≥ÊøÄÊ¥ª...');
            
            const isLocalFile = window.location.protocol === 'file:';
            
            if (isLocalFile) {
                console.log('üìÅ Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÔºå‰ΩøÁî®‰ºòÂåñÊøÄÊ¥ª');
                activateVoiceForLocalFile();
            } else {
                console.log('üåê ÁΩëÁªúÁéØÂ¢ÉÔºå‰ΩøÁî®Ê†áÂáÜÊøÄÊ¥ª');
                if (window.voiceReminder && window.voiceReminder.activateSpeechSynthesis) {
                    window.voiceReminder.activateSpeechSynthesis();
                }
            }
            
            // ÁßªÈô§ÊøÄÊ¥ªÊèêÁ§∫
            const activationTip = document.querySelector('.voice-activation-tip');
            if (activationTip) {
                activationTip.remove();
                console.log('üö´ ÊøÄÊ¥ªÊèêÁ§∫Â∑≤ÁßªÈô§');
            }
        }

        // üÜï ÁéØÂ¢ÉÊ£ÄÊµãÂíåÂàùÂßãÂåñ
        function detectEnvironmentAndInit() {
            const isLocalFile = window.location.protocol === 'file:';
            const isGitHubPages = window.location.hostname.includes('github.io');
            const isLocalHost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            console.log('üîç ÁéØÂ¢ÉÊ£ÄÊµãÁªìÊûú:', {
                isLocalFile,
                isGitHubPages,
                isLocalHost,
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                href: window.location.href
            });
            
            // Ê†πÊçÆÁéØÂ¢ÉÊèê‰æõ‰∏çÂêåÁöÑÂàùÂßãÂåñÁ≠ñÁï•
            if (isLocalFile) {
                console.log('üìÅ Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÂàùÂßãÂåñ');
                initializeForLocalFile();
            } else if (isGitHubPages) {
                console.log('üêô GitHub PagesÁéØÂ¢ÉÂàùÂßãÂåñ');
                initializeForGitHubPages();
            } else if (isLocalHost) {
                console.log('üè† Êú¨Âú∞ÊúçÂä°Âô®ÁéØÂ¢ÉÂàùÂßãÂåñ');
                initializeForLocalServer();
            } else {
                console.log('üåê Ê†áÂáÜÁΩëÁªúÁéØÂ¢ÉÂàùÂßãÂåñ');
                initializeStandard();
            }
        }

        // üÜï Êú¨Âú∞Êñá‰ª∂ÁéØÂ¢ÉÂàùÂßãÂåñ
        function initializeForLocalFile() {
            console.log('üìÅ ÊâßË°åÊú¨Âú∞Êñá‰ª∂‰∏ìÁî®ÂàùÂßãÂåñ...');
            
            // ÊòæÁ§∫Êú¨Âú∞Êñá‰ª∂ÊèêÁ§∫
            showLocalFileNotice();
            
            // Ë∑≥Ëøá Service Worker Ê≥®ÂÜå
            console.log('‚è≠Ô∏è Ë∑≥Ëøá Service Worker Ê≥®ÂÜå');
            
            // ‰ΩøÁî®Êú¨Âú∞Êñá‰ª∂‰ºòÂåñÁöÑËØ≠Èü≥ÂàùÂßãÂåñ
            setTimeout(() => {
                console.log('üîä ÂêØÂä®Êú¨Âú∞Êñá‰ª∂‰ºòÂåñËØ≠Èü≥Á≥ªÁªü...');
                initializeVoiceForLocalFile();
            }, 800);
        }

        // üÜï GitHub PagesÁéØÂ¢ÉÂàùÂßãÂåñ
        function initializeForGitHubPages() {
            console.log('üêô ÊâßË°åGitHub Pages‰∏ìÁî®ÂàùÂßãÂåñ...');
            
            // Ê≥®ÂÜå Service Worker
            registerServiceWorkerWithRetry().then((success) => {
                if (success) {
                    console.log('‚úÖ GitHub Pages Service Worker Ê≥®ÂÜåÊàêÂäü');
                } else {
                    console.warn('‚ö†Ô∏è GitHub Pages Service Worker Ê≥®ÂÜåÂ§±Ë¥•');
                }
            });
            
            // Ê†áÂáÜËØ≠Èü≥ÂàùÂßãÂåñ
            setTimeout(() => {
                console.log('üîä ÂêØÂä®GitHub PagesËØ≠Èü≥Á≥ªÁªü...');
                initializeVoiceReminderWithRetry();
            }, 500);
        }

        // üÜï Êú¨Âú∞ÊúçÂä°Âô®ÁéØÂ¢ÉÂàùÂßãÂåñ
        function initializeForLocalServer() {
            console.log('üè† ÊâßË°åÊú¨Âú∞ÊúçÂä°Âô®‰∏ìÁî®ÂàùÂßãÂåñ...');
            
            // Â∞ùËØïÊ≥®ÂÜå Service Worker
            registerServiceWorkerWithRetry();
            
            // Ê†áÂáÜËØ≠Èü≥ÂàùÂßãÂåñ
            setTimeout(() => {
                initializeVoiceReminderWithRetry();
            }, 500);
        }

        // üÜï Ê†áÂáÜÁΩëÁªúÁéØÂ¢ÉÂàùÂßãÂåñ
        function initializeStandard() {
            console.log('üåê ÊâßË°åÊ†áÂáÜÁΩëÁªúÁéØÂ¢ÉÂàùÂßãÂåñ...');
            
            // Ê≥®ÂÜå Service Worker
            registerServiceWorkerWithRetry();
            
            // Ê†áÂáÜËØ≠Èü≥ÂàùÂßãÂåñ
            setTimeout(() => {
                initializeVoiceReminderWithRetry();
            }, 500);
        }

        // üÜï Êú¨Âú∞Êñá‰ª∂‰∏ìÁî®ËØ≠Èü≥ÂàùÂßãÂåñ
        function initializeVoiceForLocalFile() {
            console.log('üìÅ Êú¨Âú∞Êñá‰ª∂‰∏ìÁî®ËØ≠Èü≥ÂàùÂßãÂåñ...');
            
            try {
                // ÂàõÂª∫ËØ≠Èü≥ÊèêÈÜíÂÆû‰æã
                window.voiceReminder = new VoiceReminder();
                
                // üÜï ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáèÂà´ÂêçÔºåÊñπ‰æøÂÖ∂‰ªñÂú∞ÊñπÂºïÁî®
                voiceReminder = window.voiceReminder;
                
                // Á≠âÂæÖÂàùÂßãÂåñÂÆåÊàê
                setTimeout(() => {
                    if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                        console.log('‚úÖ Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
                        
                        // Êõ¥Êñ∞ËØ≠Èü≥ÊåáÁ§∫Âô®
                        updateVoiceIndicator();
                        
                        // ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí
                        checkAndSetupVoiceReminders();
                        
                        // Êú¨Âú∞Êñá‰ª∂‰∏ìÁî®Ê¨¢ËøéËØ≠Èü≥
                        setTimeout(() => {
                            if (window.voiceReminder.isEnabled) {
                                window.voiceReminder.speak('Êú¨Âú∞Êñá‰ª∂Ê®°Âºè‰∏ãÔºåÂ≠¶‰π†ÊâìÂç°Á≥ªÁªüÂ∑≤ÂáÜÂ§áÂ∞±Áª™', 'encouragement', 1);
                            }
                        }, 1000);
                        
                    } else {
                        console.warn('‚ö†Ô∏è Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊú™ÂÆåÊàê');
                        
                        // ÈáçËØï‰∏ÄÊ¨°
                        setTimeout(() => {
                            if (!window.voiceReminder || !window.voiceReminder.speechSynthesis) {
                                console.log('üîÑ Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥Á≥ªÁªüÈáçËØïÂàùÂßãÂåñ...');
                                initializeVoiceReminderWithRetry();
                            }
                        }, 2000);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('üí• Êú¨Âú∞Êñá‰ª∂ËØ≠Èü≥ÂàùÂßãÂåñÂºÇÂ∏∏:', error);
                
                // ÈôçÁ∫ßÂà∞Ê†áÂáÜÂàùÂßãÂåñ
                setTimeout(() => {
                    initializeVoiceReminderWithRetry();
                }, 1000);
            }
        }

        /**
         * üÜï Ê£ÄÊü•ÁâàÊú¨‰∏ÄËá¥ÊÄß
         */
        async function checkVersionConsistency(registration) {
            try {
                console.log('üîç Ê£ÄÊü•ÁâàÊú¨‰∏ÄËá¥ÊÄß...');
                
                // Ëé∑ÂèñÂΩìÂâçService WorkerÁâàÊú¨
                if (registration.active) {
                    const messageChannel = new MessageChannel();
                    
                    messageChannel.port1.onmessage = (event) => {
                        const versionInfo = event.data;
                        console.log('üìã ÂΩìÂâçÁâàÊú¨‰ø°ÊÅØ:', versionInfo);
                        
                        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂº∫Âà∂Êõ¥Êñ∞
                        const expectedVersion = '2024-01-07-002';
                        if (versionInfo.cacheVersion !== expectedVersion) {
                            console.warn('‚ö†Ô∏è ÁâàÊú¨‰∏ç‰∏ÄËá¥ÔºåÈúÄË¶ÅÂº∫Âà∂Êõ¥Êñ∞');
                            handleForceUpdate({
                                version: expectedVersion,
                                currentVersion: versionInfo.cacheVersion,
                                message: 'Ê£ÄÊµãÂà∞ÁâàÊú¨‰∏ç‰∏ÄËá¥ÔºåÊ≠£Âú®Âº∫Âà∂Êõ¥Êñ∞...'
                            });
                        } else {
                            console.log('‚úÖ ÁâàÊú¨‰∏ÄËá¥ÔºåÊó†ÈúÄÊõ¥Êñ∞');
                        }
                    };
                    
                    registration.active.postMessage({
                        type: 'GET_VERSION'
                    }, [messageChannel.port2]);
                }
                
            } catch (error) {
                console.error('üí• ÁâàÊú¨Ê£ÄÊü•Â§±Ë¥•:', error);
            }
        }

        /**
         * üÜï Â§ÑÁêÜÂº∫Âà∂Êõ¥Êñ∞
         */
        function handleForceUpdate(updateInfo) {
            console.log('üöÄ ÂºÄÂßãÂ§ÑÁêÜÂº∫Âà∂Êõ¥Êñ∞:', updateInfo);
            
            // ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•
            showUpdateNotification(`Ê≠£Âú®Êõ¥Êñ∞Âà∞ÁâàÊú¨ ${updateInfo.version}...`, 'info');
            
            // Âª∂ËøüÊâßË°åÂº∫Âà∂Âà∑Êñ∞ÔºåÁªôÁî®Êà∑‰∏ÄÁÇπÊó∂Èó¥ÁúãÂà∞ÈÄöÁü•
            setTimeout(() => {
                console.log('üîÑ ÊâßË°åÂº∫Âà∂È°µÈù¢Âà∑Êñ∞...');
                
                // Ê∏ÖÈô§ÊâÄÊúâÊú¨Âú∞ÁºìÂ≠ò
                if ('caches' in window) {
                    caches.keys().then((cacheNames) => {
                        const deletePromises = cacheNames.map(cacheName => {
                            console.log('üóëÔ∏è Âà†Èô§Êú¨Âú∞ÁºìÂ≠ò:', cacheName);
                            return caches.delete(cacheName);
                        });
                        
                        return Promise.all(deletePromises);
                    }).then(() => {
                        console.log('‚úÖ Êú¨Âú∞ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§');
                        // Âº∫Âà∂Âà∑Êñ∞È°µÈù¢ÔºåÊ∑ªÂä†Êó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
                        window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();
                    }).catch((error) => {
                        console.error('üí• Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•:', error);
                        // Âç≥‰ΩøÊ∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•Ôºå‰πüË¶ÅÂà∑Êñ∞È°µÈù¢
                        window.location.reload(true);
                    });
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÁºìÂ≠òAPIÔºåÁõ¥Êé•Âº∫Âà∂Âà∑Êñ∞
                    window.location.reload(true);
                }
            }, 1500);
        }

        /**
         * üÜï ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•
         */
        function showUpdateNotification(message, type = 'success') {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÈÄöÁü•
            const existingNotification = document.querySelector('.update-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            
            const bgColor = type === 'info' ? 'linear-gradient(135deg, #667eea, #764ba2)' : 
                           type === 'warning' ? 'linear-gradient(135deg, #ff9a56, #ff6b35)' :
                           'linear-gradient(135deg, #51cf66, #69db7c)';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 13px;
                font-weight: bold;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                animation: slideInOut 3s ease-in-out;
                max-width: 90%;
                text-align: center;
            `;
            
            notification.innerHTML = message;
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            if (!document.querySelector('#updateNotificationStyle')) {
                const style = document.createElement('style');
                style.id = 'updateNotificationStyle';
                style.textContent = `
                    @keyframes slideInOut {
                        0% { 
                            opacity: 0; 
                            transform: translateX(-50%) translateY(-30px); 
                        }
                        15%, 85% { 
                            opacity: 1; 
                            transform: translateX(-50%) translateY(0); 
                        }
                        100% { 
                            opacity: 0; 
                            transform: translateX(-50%) translateY(-30px); 
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        /**
         * üÜï ÊâãÂä®Âº∫Âà∂Êõ¥Êñ∞ÂäüËÉΩ
         */
        function manualForceUpdate() {
            console.log('üîÑ Áî®Êà∑ÊâãÂä®Ëß¶ÂèëÂº∫Âà∂Êõ¥Êñ∞');
            
            const confirmUpdate = confirm('Á°ÆÂÆöË¶ÅÂº∫Âà∂Êõ¥Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨ÂêóÔºü\n\nËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÂπ∂ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢„ÄÇ');
            
            if (confirmUpdate) {
                // ÂêëService WorkerÂèëÈÄÅÂº∫Âà∂Ê∏ÖÈô§ÁºìÂ≠òÊ∂àÊÅØ
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FORCE_CACHE_CLEAR'
                    });
                }
                
                // ÊâßË°åÂº∫Âà∂Êõ¥Êñ∞
                handleForceUpdate({
                    version: 'ÊúÄÊñ∞ÁâàÊú¨',
                    message: 'ÊâãÂä®Âº∫Âà∂Êõ¥Êñ∞‰∏≠...'
                });
            }
        }

        // üÜï Âú®ÂÖ®Â±ÄÊö¥Èú≤ÊâãÂä®Êõ¥Êñ∞ÂáΩÊï∞
        window.manualForceUpdate = manualForceUpdate;

        /**
         * Âº∫Âà∂Ê£ÄÊü•Êõ¥Êñ∞ÔºàÁî®‰∫éËß£ÂÜ≥ÁºìÂ≠òÈóÆÈ¢òÔºâ
         */
        function forceCheckUpdate() {
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                console.log('ÊâãÂä®Ê£ÄÊü•Service WorkerÊõ¥Êñ∞...');
                
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration) {
                        // Âº∫Âà∂Ê£ÄÊü•Êõ¥Êñ∞
                        registration.update().then(() => {
                            console.log('Service WorkerÊõ¥Êñ∞Ê£ÄÊü•ÂÆåÊàê');
                        }).catch((error) => {
                            console.error('Service WorkerÊõ¥Êñ∞Ê£ÄÊü•Â§±Ë¥•:', error);
                        });
                    }
                });
            }
        }

        /**
         * Ê∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÂπ∂ÈáçÊñ∞Âä†ËΩΩÔºàÁªàÊûÅËß£ÂÜ≥ÊñπÊ°àÔºâ
         */
        function clearCacheAndReload() {
            if ('caches' in window) {
                console.log('Ê∏ÖÈô§ÊâÄÊúâÁºìÂ≠ò...');
                
                caches.keys().then((cacheNames) => {
                    return Promise.all(
                        cacheNames.map((cacheName) => {
                            console.log('Âà†Èô§ÁºìÂ≠ò:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    console.log('ÊâÄÊúâÁºìÂ≠òÂ∑≤Ê∏ÖÈô§ÔºåÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢...');
                    window.location.reload(true);
                }).catch((error) => {
                    console.error('Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•:', error);
                    // Âº∫Âà∂Âà∑Êñ∞
                    window.location.reload(true);
                });
            } else {
                // ÊµèËßàÂô®‰∏çÊîØÊåÅÁºìÂ≠òAPIÔºåÁõ¥Êé•Âº∫Âà∂Âà∑Êñ∞
                window.location.reload(true);
            }
        }

        // Êõ¥Êñ∞ËØ≠Èü≥ÊèêÈÜíÁä∂ÊÄÅÊåáÁ§∫Âô®
        function updateVoiceIndicator() {
            console.log('üîÑ Êõ¥Êñ∞ËØ≠Èü≥ÊåáÁ§∫Âô® - iPhone 6‰∏ìÁî®Áâà...');
            
            // ÁßªÈô§Áé∞ÊúâÁöÑËØ≠Èü≥ÊåáÁ§∫Âô®
            const existingIndicator = document.querySelector('#voiceReminderSettings');
            const originalIndicator = document.querySelector('#voiceIndicator');
            
            if (existingIndicator) {
                existingIndicator.remove();
                console.log('üóëÔ∏è ÁßªÈô§Áé∞ÊúâËØ≠Èü≥ÊåáÁ§∫Âô®');
            }
            
            if (originalIndicator) {
                originalIndicator.remove();
                console.log('üóëÔ∏è ÁßªÈô§ÂéüÂßãËØ≠Èü≥ÊåáÁ§∫Âô®');
            }
            
            // Ê£ÄÊü•ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÁä∂ÊÄÅ
            const hasVoiceReminder = window.voiceReminder && window.voiceReminder.speechSynthesis;
            const isEnabled = hasVoiceReminder ? window.voiceReminder.isEnabled : false;
            
            // Ê£ÄÊµãÊòØÂê¶‰∏∫iPhone 6
            const isIPhone6 = /iPhone OS 9_|iPhone OS 10_|iPhone OS 11_|iPhone OS 12_/.test(navigator.userAgent);
            
            console.log('üìä ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅ:', {
                hasVoiceReminder,
                isEnabled,
                isIPhone6,
                speechSynthesis: hasVoiceReminder ? 'ÂèØÁî®' : '‰∏çÂèØÁî®'
            });
            
            // ÂàõÂª∫ËØ≠Èü≥ÊåáÁ§∫Âô®ÂÆπÂô®
            const indicatorContainer = document.createElement('div');
            indicatorContainer.id = 'voiceReminderSettings';
            indicatorContainer.style.cssText = `
                position: fixed;
                bottom: 70px;
                left: 20px;
                z-index: 1001;
                display: flex;
                flex-direction: column;
                gap: 8px;
                pointer-events: none;
            `;
            
            // ÂàõÂª∫ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ
            const settingsButton = document.createElement('div');
            settingsButton.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 12px;
                border-radius: 50%;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                font-size: 18px;
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                pointer-events: auto;
                user-select: none;
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            `;
            
            // ËÆæÁΩÆÊåâÈíÆÂõæÊ†áÂíåÁä∂ÊÄÅ
            if (hasVoiceReminder && isEnabled) {
                settingsButton.innerHTML = 'üîä';
                settingsButton.title = 'ËØ≠Èü≥ÊèêÈÜíÂ∑≤ÂêØÁî®ÔºåÁÇπÂáªËÆæÁΩÆ';
            } else if (hasVoiceReminder && !isEnabled) {
                settingsButton.innerHTML = 'üîá';
                settingsButton.title = 'ËØ≠Èü≥ÊèêÈÜíÂ∑≤Á¶ÅÁî®ÔºåÁÇπÂáªËÆæÁΩÆ';
                settingsButton.style.opacity = '0.6';
            } else {
                settingsButton.innerHTML = 'üîá';
                settingsButton.title = 'ËØ≠Èü≥ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÁÇπÂáªÈáçËØï';
                settingsButton.style.opacity = '0.4';
                settingsButton.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
            }
            
            // üéØ iPhone 6‰∏ìÁî®ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
            settingsButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('üéØ iPhone 6ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª');
                console.log('üìä ‰∫ã‰ª∂ËØ¶ÊÉÖ:', {
                    type: e.type,
                    target: e.target,
                    currentTarget: e.currentTarget,
                    timestamp: Date.now()
                });
                
                // Ê∑ªÂä†ÁÇπÂáªÂèçÈ¶à
                settingsButton.style.transform = 'scale(0.95)';
                settingsButton.style.backgroundColor = 'rgba(102, 126, 234, 0.8)';
                
                setTimeout(() => {
                    settingsButton.style.transform = 'scale(1)';
                    settingsButton.style.backgroundColor = '';
                }, 150);
                
                // Êí≠ÊîæÁÇπÂáªÂèçÈ¶àÈü≥
                if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                    console.log('üîä Êí≠ÊîæÁÇπÂáªÂèçÈ¶àÈü≥');
                    try {
                        // üÜï Âè™Âú®ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ªÊó∂Êí≠ÊîæÂèçÈ¶àÈü≥
                        if (window.voiceReminder.engineActivated && window.voiceReminder.isEnabled) {
                            window.voiceReminder.speak('Ê≠£Âú®ÊâìÂºÄËØ≠Èü≥ËÆæÁΩÆ', null, 1);
                        } else {
                            console.log('‚ÑπÔ∏è ËØ≠Èü≥ÂºïÊìéÊú™ÊøÄÊ¥ªÔºåË∑≥ËøáÁÇπÂáªÂèçÈ¶àÈü≥');
                        }
                    } catch (error) {
                        console.error('Êí≠ÊîæÁÇπÂáªÂèçÈ¶àÈü≥Â§±Ë¥•:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è ËØ≠Èü≥Á≥ªÁªü‰∏çÂèØÁî®ÔºåË∑≥ËøáÁÇπÂáªÂèçÈ¶àÈü≥');
                }
                
                // Ë∞ÉÁî®ËÆæÁΩÆÁïåÈù¢
                setTimeout(() => {
                    console.log('üîß Ë∞ÉÁî®toggleVoiceSettingsÂáΩÊï∞');
                    try {
                        toggleVoiceSettings();
                    } catch (error) {
                        console.error('üí• Ë∞ÉÁî®toggleVoiceSettingsÂ§±Ë¥•:', error);
                        alert('ÊâìÂºÄËØ≠Èü≥ËÆæÁΩÆÂ§±Ë¥•: ' + error.message);
                    }
                }, 300);
            }, { passive: false });
            
            // Ê∑ªÂä†Âè≥ÈîÆ‰∫ã‰ª∂Áî®‰∫éË∞ÉËØï
            settingsButton.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                console.log('üñ±Ô∏è ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆÂè≥ÈîÆË¢´ÁÇπÂáª - ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØ');
                
                const debugInfo = `
üîä ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆË∞ÉËØï‰ø°ÊÅØ

üì± ËÆæÂ§áÁä∂ÊÄÅ:
‚Ä¢ ËØ≠Èü≥ÂºïÊìé: ${hasVoiceReminder ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}
‚Ä¢ ËØ≠Èü≥ÂêØÁî®: ${isEnabled ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}
‚Ä¢ iPhone 6: ${isIPhone6 ? '‚úÖ ÊòØ' : '‚ùå Âê¶'}

üéØ ÊåâÈíÆÁä∂ÊÄÅ:
‚Ä¢ ÂÖÉÁ¥†ID: voiceReminderSettings
‚Ä¢ ÊòæÁ§∫Áä∂ÊÄÅ: ${settingsButton.style.display || 'block'}
‚Ä¢ ÂèØËßÅÊÄß: ${settingsButton.style.visibility || 'visible'}
‚Ä¢ ÁÇπÂáª‰∫ã‰ª∂: Â∑≤ÁªëÂÆö

üîß ÂáΩÊï∞Ê£ÄÊü•:
‚Ä¢ toggleVoiceSettings: ${typeof toggleVoiceSettings === 'function' ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}
‚Ä¢ createVoiceSettingsModal: ${typeof createVoiceSettingsModal === 'function' ? '‚úÖ Â≠òÂú®' : '‚ùå ‰∏çÂ≠òÂú®'}

üí° Â¶ÇÊûúÁÇπÂáªÊ≤°ÊúâÂèçÂ∫îÔºåËØ∑Â∞ùËØïÔºö
1. Âà∑Êñ∞È°µÈù¢
2. Ê£ÄÊü•ÊµèËßàÂô®ÊéßÂà∂Âè∞
3. ‰ΩøÁî®‰∏çÂêåÊµèËßàÂô®
                `;
                
                alert(debugInfo);
            });
            
            // Ê∑ªÂä†Ëß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜÔºàiPhone 6‰∏ìÁî®Ôºâ
            if (isIPhone6) {
                settingsButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è iPhone 6 touchstart‰∫ã‰ª∂');
                    settingsButton.style.transform = 'scale(0.95)';
                    settingsButton.style.opacity = '0.8';
                });
                
                settingsButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è iPhone 6 touchend‰∫ã‰ª∂');
                    settingsButton.style.transform = 'scale(1)';
                    settingsButton.style.opacity = '1';
                    
                    // Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂
                    setTimeout(() => {
                        toggleVoiceSettings();
                    }, 100);
                });
            }
            
            // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
            settingsButton.addEventListener('mouseenter', () => {
                settingsButton.style.transform = 'scale(1.1)';
                settingsButton.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
            });
            
            settingsButton.addEventListener('mouseleave', () => {
                settingsButton.style.transform = 'scale(1)';
                settingsButton.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
            });
            
            indicatorContainer.appendChild(settingsButton);
            
            // ÂàõÂª∫Áä∂ÊÄÅÊåáÁ§∫Âô®
            if (hasVoiceReminder) {
                const stats = window.voiceReminder.getEnabledReminderStats();
                const serviceWorkerReady = window.voiceReminder.serviceWorkerReady;
                
                const statusIndicator = document.createElement('div');
                statusIndicator.style.cssText = `
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 10px;
                    text-align: center;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    pointer-events: auto;
                    cursor: pointer;
                    min-width: 60px;
                `;
                
                // Áä∂ÊÄÅÊñáÊú¨
                let statusText = '';
                if (isEnabled) {
                    statusText = `${stats.enabled}/${stats.total}`;
                } else {
                    statusText = 'Â∑≤ÂÖ≥Èó≠';
                }
                
                // iPhone 6 Ê†áËØÜ
                const iPhone6Status = isIPhone6 ? ' IP6' : '';
                
                // Service Worker Áä∂ÊÄÅ
                const swStatus = serviceWorkerReady ? '‚úìSW' : '‚ö†SW';
                
                statusIndicator.innerHTML = `${statusText}${iPhone6Status} ${swStatus}`;
                statusIndicator.title = `ÂêØÁî®ÊèêÈÜí: ${stats.enabled}/${stats.total}, iPhone 6: ${isIPhone6 ? 'ÊòØ' : 'Âê¶'}, Service Worker: ${serviceWorkerReady ? 'Â∞±Áª™' : 'Êú™Â∞±Áª™'}`;
                
                // ÁÇπÂáªÁä∂ÊÄÅÊåáÁ§∫Âô®ÊòæÁ§∫ËØ¶ÁªÜ‰ø°ÊÅØ
                statusIndicator.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîä ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊåâÈíÆË¢´ÁÇπÂáª');
                    showVoiceSystemStatusForIPhone6();
                });
                
                // üÜï Â¢ûÂº∫ÁßªÂä®Á´ØËß¶Êë∏‰∫ã‰ª∂Â§ÑÁêÜ
                statusIndicator.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    console.log('üì± ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊåâÈíÆ touchstart');
                    statusIndicator.style.opacity = '0.7';
                    statusIndicator.style.transform = 'scale(0.95)';
                });
                
                statusIndicator.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üì± ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊåâÈíÆ touchend');
                    statusIndicator.style.opacity = '1';
                    statusIndicator.style.transform = 'scale(1)';
                    
                    // Âª∂ËøüËß¶ÂèëÁÇπÂáª‰∫ã‰ª∂
                    setTimeout(() => {
                        console.log('üîä ÁßªÂä®Á´ØËß¶ÂèëËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊòæÁ§∫');
                        showVoiceSystemStatusForIPhone6();
                    }, 100);
                });
                
                // üÜï Âè≥ÈîÆÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑË∞ÉËØï‰ø°ÊÅØ
                statusIndicator.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    console.log('üñ±Ô∏è ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊåâÈíÆÂè≥ÈîÆË¢´ÁÇπÂáª');
                    showAdvancedVoiceDebugInfo();
                });
                
                indicatorContainer.appendChild(statusIndicator);
            }
            
            // Â∞ÜÊåáÁ§∫Âô®Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(indicatorContainer);
            
            console.log('‚úÖ iPhone 6‰∏ìÁî®ËØ≠Èü≥ÊåáÁ§∫Âô®Êõ¥Êñ∞ÂÆåÊàê');
        }

        // üÜï iPhone 6‰∏ìÁî®ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊòæÁ§∫
        function showVoiceSystemStatusForIPhone6() {
            const hasVoiceReminder = window.voiceReminder && window.voiceReminder.speechSynthesis;
            const isEnabled = hasVoiceReminder ? window.voiceReminder.isEnabled : false;
            const stats = hasVoiceReminder ? window.voiceReminder.getEnabledReminderStats() : { enabled: 0, total: 0 };
            const isIPhone6 = /iPhone OS 9_|iPhone OS 10_|iPhone OS 11_|iPhone OS 12_/.test(navigator.userAgent);
            
            const statusInfo = `
üîä iPhone 6 ËØ≠Èü≥Á≥ªÁªüÁä∂ÊÄÅÊä•Âëä

üì± ËÆæÂ§á‰ø°ÊÅØ:
‚Ä¢ ËÆæÂ§áÂûãÂè∑: ${isIPhone6 ? 'iPhone 6Á≥ªÂàó' : 'ÂÖ∂‰ªñËÆæÂ§á'}
‚Ä¢ ÊµèËßàÂô®: ${navigator.userAgent.includes('Safari') ? 'Safari' : 'Unknown'}
‚Ä¢ Áî®Êà∑‰ª£ÁêÜ: ${navigator.userAgent.substring(0, 100)}...

üéµ ËØ≠Èü≥ÂäüËÉΩ:
‚Ä¢ ËØ≠Èü≥ÂºïÊìé: ${hasVoiceReminder ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}
‚Ä¢ ‰∏ªÂºÄÂÖ≥: ${isEnabled ? '‚úÖ Â∑≤ÂêØÁî®' : '‚ùå Â∑≤Á¶ÅÁî®'}
‚Ä¢ ÊèêÈÜíÁ±ªÂûã: ${stats.enabled}/${stats.total} ‰∏™Â∑≤ÂêØÁî®
‚Ä¢ ËØ≠Èü≥ÂêàÊàê: ${('speechSynthesis' in window) ? '‚úÖ ÊîØÊåÅ' : '‚ùå ‰∏çÊîØÊåÅ'}

üîß Á≥ªÁªüÁä∂ÊÄÅ:
‚Ä¢ Service Worker: ${hasVoiceReminder && window.voiceReminder.serviceWorkerReady ? '‚úÖ Â∞±Áª™' : '‚ùå Êú™Â∞±Áª™'}
‚Ä¢ ÈÄöÁü•ÊùÉÈôê: ${Notification.permission}
‚Ä¢ Wake Lock: ${('wakeLock' in navigator) ? '‚úÖ ÊîØÊåÅ' : '‚ùå ‰∏çÊîØÊåÅ'}

${hasVoiceReminder ? '‚úÖ Á≥ªÁªüËøêË°åÊ≠£Â∏∏' : '‚ö†Ô∏è ËØ∑ÁÇπÂáªËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆÈáçÊñ∞ÂàùÂßãÂåñ'}
            `;
            
            alert(statusInfo);
        }

        // ÊòæÁ§∫ËØ≠Èü≥Á≥ªÁªüËØ¶ÁªÜÁä∂ÊÄÅ
        function showVoiceSystemStatus() {
            // Ê£ÄÊµãÊµèËßàÂô®Á±ªÂûã
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isStrictBrowser = isChrome || isFirefox;
            
            let statusInfo = 'üîä ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÁä∂ÊÄÅÊä•Âëä\n\n';
            
            // ÊµèËßàÂô®‰ø°ÊÅØ
            statusInfo += `üåê ÊµèËßàÂô®Ê£ÄÊµã:\n`;
            if (isChrome) {
                statusInfo += `‚úÖ ChromeÊµèËßàÂô® (‰∏•Ê†ºÊ®°Âºè)\n`;
            } else if (isFirefox) {
                statusInfo += `‚úÖ FirefoxÊµèËßàÂô® (‰∏•Ê†ºÊ®°Âºè)\n`;
            } else if (isSafari) {
                statusInfo += `‚úÖ SafariÊµèËßàÂô® (ÂÖºÂÆπÊ®°Âºè)\n`;
            } else {
                statusInfo += `‚ö†Ô∏è ÂÖ∂‰ªñÊµèËßàÂô®\n`;
            }
            
            // Âü∫Êú¨ÂäüËÉΩÊ£ÄÊü•
            const speechSupported = 'speechSynthesis' in window;
            statusInfo += `\nüîß Á≥ªÁªüÂäüËÉΩ:\n`;
            statusInfo += `ÊµèËßàÂô®ËØ≠Èü≥ÊîØÊåÅ: ${speechSupported ? '‚úÖ ÊîØÊåÅ' : '‚ùå ‰∏çÊîØÊåÅ'}\n`;
            statusInfo += `ËØ≠Èü≥ÂØπË±°Áä∂ÊÄÅ: ${voiceReminder ? '‚úÖ Â∑≤ÂàõÂª∫' : '‚ùå Êú™ÂàõÂª∫'}\n`;
            
            if (voiceReminder) {
                statusInfo += `‰∏ªÂºÄÂÖ≥Áä∂ÊÄÅ: ${voiceReminder.isEnabled ? '‚úÖ Â∑≤ÂêØÁî®' : '‚ùå Â∑≤Á¶ÅÁî®'}\n`;
                statusInfo += `ËØ≠Èü≥ÂºïÊìéÊøÄÊ¥ª: ${voiceReminder.engineActivated ? '‚úÖ Â∑≤ÊøÄÊ¥ª' : 'üîÑ Êú™ÊøÄÊ¥ª'}\n`;
                statusInfo += `Service Worker: ${voiceReminder.serviceWorkerReady ? '‚úÖ Â∑≤ÂáÜÂ§á' : '‚ùå Êú™ÂáÜÂ§á'}\n`;
                statusInfo += `Êí≠ÊîæÁä∂ÊÄÅ: ${voiceReminder.isPlaying ? 'üîä Êí≠Êîæ‰∏≠' : 'üîá Á©∫Èó≤'}\n`;
            }
            
            // ÈÄöÁü•ÊùÉÈôê
            if ('Notification' in window) {
                const permission = Notification.permission;
                statusInfo += `ÈÄöÁü•ÊùÉÈôê: ${permission === 'granted' ? '‚úÖ Â∑≤ÊéàÊùÉ' : permission === 'denied' ? '‚ùå Â∑≤ÊãíÁªù' : '‚ö†Ô∏è Êú™ËÆæÁΩÆ'}\n`;
            } else {
                statusInfo += `ÈÄöÁü•ÊùÉÈôê: ‚ùå ‰∏çÊîØÊåÅ\n`;
            }
            
            // PWAÁºìÂ≠òÁä∂ÊÄÅ
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            statusInfo += `PWAÊ®°Âºè: ${isStandalone ? '‚úÖ Áã¨Á´ãÂ∫îÁî®' : 'üì± ÊµèËßàÂô®‰∏≠'}\n`;
            
            // ËØ≠Èü≥ÂêàÊàêËØ¶ÁªÜÁä∂ÊÄÅ
            if (speechSupported) {
                try {
                    const voices = speechSynthesis.getVoices();
                    statusInfo += `\nüé§ ËØ≠Èü≥ËØ¶ÊÉÖ:\n`;
                    statusInfo += `ÂèØÁî®ËØ≠Èü≥Êï∞Èáè: ${voices.length}\n`;
                    statusInfo += `ËØ≠Èü≥ÂêàÊàêÁä∂ÊÄÅ: ${speechSynthesis.speaking ? 'üîä Êí≠Êîæ‰∏≠' : 'üîá Á©∫Èó≤'}\n`;
                    statusInfo += `ËØ≠Èü≥ÈòüÂàóÁä∂ÊÄÅ: ${speechSynthesis.pending ? 'üìã ÊúâÈòüÂàó' : 'üìã Êó†ÈòüÂàó'}\n`;
                    statusInfo += `ËØ≠Èü≥ÊöÇÂÅúÁä∂ÊÄÅ: ${speechSynthesis.paused ? '‚è∏Ô∏è Â∑≤ÊöÇÂÅú' : '‚ñ∂Ô∏è Ê≠£Â∏∏'}\n`;
                } catch (error) {
                    statusInfo += `ËØ≠Èü≥Áä∂ÊÄÅÊ£ÄÊü•: ‚ùå Ê£ÄÊü•Â§±Ë¥• (${error.message})\n`;
                }
            }
            
            // ÈíàÂØπ‰∏çÂêåÊµèËßàÂô®ÁöÑÊïÖÈöúÊéíÈô§ÊåáÂçó
            statusInfo += '\nüîß ÈíàÂØπÊÄßËß£ÂÜ≥ÊñπÊ°àÔºö\n';
            
            if (isChrome) {
                statusInfo += 'üì± ChromeÊµèËßàÂô®‰∏ìÁî®ÊåáÂçóÔºö\n';
                statusInfo += '‚Ä¢ Á°Æ‰øùÂ∑≤ÁÇπÂáªÈ°µÈù¢Â§öÊ¨°ÔºàChromeÈúÄË¶ÅË∂≥Â§üÁöÑÁî®Êà∑‰∫§‰∫íÔºâ\n';
                statusInfo += '‚Ä¢ Ê£ÄÊü•Âú∞ÂùÄÊ†èÂ∑¶‰æßÁöÑÂ£∞Èü≥ÂõæÊ†áÔºåÁ°Æ‰øùÊú™ÈùôÈü≥\n';
                statusInfo += '‚Ä¢ ËÆøÈóÆ chrome://settings/content/sound Ê£ÄÊü•Â£∞Èü≥ËÆæÁΩÆ\n';
                statusInfo += '‚Ä¢ Â∞ùËØïÊí≠Êîæ‰∏ÄÊÆµÈü≥‰πêÊàñËßÜÈ¢ëÊøÄÊ¥ªÈü≥È¢ë‰∏ä‰∏ãÊñá\n';
                statusInfo += '‚Ä¢ Â¶ÇÊûúÊòØÊâãÊú∫ÔºåÊ£ÄÊü•ÊòØÂê¶ÂºÄÂêØ‰∫ÜÈùôÈü≥Ê®°Âºè\n\n';
            } else if (isFirefox) {
                statusInfo += 'ü¶ä FirefoxÊµèËßàÂô®‰∏ìÁî®ÊåáÂçóÔºö\n';
                statusInfo += '‚Ä¢ Á°Æ‰øùÂ∑≤‰∏éÈ°µÈù¢ËøõË°å‰∫§‰∫íÔºàÁÇπÂáª„ÄÅÊªöÂä®Á≠âÔºâ\n';
                statusInfo += '‚Ä¢ Ê£ÄÊü•Âú∞ÂùÄÊ†èÁöÑÈü≥È¢ëÊí≠ÊîæÊùÉÈôêÂõæÊ†á\n';
                statusInfo += '‚Ä¢ ËÆøÈóÆ about:preferences#privacy Ê£ÄÊü•Èü≥È¢ëÊùÉÈôê\n';
                statusInfo += '‚Ä¢ Â∞ùËØïÂà∑Êñ∞È°µÈù¢Âπ∂Á´ãÂç≥ÁÇπÂáªÊåâÈíÆ\n';
                statusInfo += '‚Ä¢ Á°Æ‰øùÊµèËßàÂô®Èü≥ÈáèÊú™Ë¢´ÈùôÈü≥\n\n';
            } else if (isSafari) {
                statusInfo += 'üçé SafariÊµèËßàÂô®ÔºàÊé®ËçêÔºâÔºö\n';
                statusInfo += '‚Ä¢ SafariÂØπËØ≠Èü≥ÊîØÊåÅÊúÄÂ•ΩÔºåÈÄöÂ∏∏Êó†ÈúÄÁâπÊÆäËÆæÁΩÆ\n';
                statusInfo += '‚Ä¢ Â¶ÇÊúâÈóÆÈ¢òÔºåÊ£ÄÊü•Á≥ªÁªüÂÅèÂ•ΩËÆæÁΩÆ‰∏≠ÁöÑÈöêÁßÅÊùÉÈôê\n\n';
            } else {
                statusInfo += '‚Ä¢ Âª∫ËÆÆÊõ¥Êç¢‰∏∫Chrome„ÄÅFirefoxÊàñSafariÊµèËßàÂô®\n';
                statusInfo += '‚Ä¢ Á°Æ‰øùÊµèËßàÂô®ÁâàÊú¨ËæÉÊñ∞\n\n';
            }
            
            statusInfo += 'üí° ÈÄöÁî®Ëß£ÂÜ≥ÊñπÊ°àÔºö\n';
            if (!speechSupported) {
                statusInfo += '‚Ä¢ Êõ¥Êç¢ÊîØÊåÅËØ≠Èü≥ÁöÑÊµèËßàÂô®ÔºàÊé®ËçêChromeÊàñSafariÔºâ\n';
            } else if (!voiceReminder || !voiceReminder.engineActivated) {
                statusInfo += '‚Ä¢ Â§öÊ¨°ÁÇπÂáªÈ°µÈù¢‰∏äÁöÑÊåâÈíÆÂíåÈìæÊé•\n';
                statusInfo += '‚Ä¢ Á°Æ‰øùÊâãÊú∫Ê≤°ÊúâÈùôÈü≥\n';
                statusInfo += '‚Ä¢ Ê£ÄÊü•ÊµèËßàÂô®Èü≥È¢ëÊùÉÈôê\n';
                statusInfo += '‚Ä¢ Â∞ùËØïÊí≠ÊîæÂÖ∂‰ªñÈü≥È¢ëÂÜÖÂÆπ\n';
            } else {
                statusInfo += '‚Ä¢ ËØ≠Èü≥ÂäüËÉΩÊ≠£Â∏∏ÔºåÂèØ‰ª•‰ΩøÁî®ÊµãËØïÊåâÈíÆÈ™åËØÅ\n';
            }
            
            statusInfo += '\nüéØ Á´ãÂç≥Â∞ùËØïÔºö\n';
            if (isStrictBrowser) {
                statusInfo += '‚Ä¢ Á°ÆÂÆöÔºöÂº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÔºàÂ§öÊ¨°Â∞ùËØïÔºâ\n';
                statusInfo += '‚Ä¢ ÂèñÊ∂àÔºöÊü•ÁúãÁºìÂ≠òÂíåÊõ¥Êñ∞ÈÄâÈ°π\n';
            } else {
                statusInfo += '‚Ä¢ Á°ÆÂÆöÔºöÊí≠ÊîæÊµãËØïËØ≠Èü≥\n';
                statusInfo += '‚Ä¢ ÂèñÊ∂àÔºöÊ£ÄÊü•ÁºìÂ≠òÊõ¥Êñ∞\n';
            }
            
            const userChoice = confirm(statusInfo);
            
            if (userChoice) {
                // Áî®Êà∑ÁÇπÂáªÁ°ÆÂÆö
                if (isStrictBrowser) {
                    // ÂØπ‰∏•Ê†ºÊµèËßàÂô®ËøõË°åÂº∫Âà∂ÊøÄÊ¥ª
                    forceActivateVoiceForStrictBrowser();
                } else {
                    // ÂÖ∂‰ªñÊµèËßàÂô®Êí≠ÊîæÊµãËØïËØ≠Èü≥
                    if (voiceReminder && voiceReminder.testVoice) {
                        voiceReminder.testVoice();
                    } else {
                        forceVoiceTest();
                    }
                }
            } else {
                // Áî®Êà∑ÁÇπÂáªÂèñÊ∂àÔºöÊòæÁ§∫ÁºìÂ≠òËß£ÂÜ≥ÈÄâÈ°π
                showCacheFixOptions();
            }
        }

        /**
         * ÈíàÂØπ‰∏•Ê†ºÊµèËßàÂô®ÁöÑÂº∫Âà∂ÊøÄÊ¥ª
         */
        async function forceActivateVoiceForStrictBrowser() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            const browserName = isChrome ? 'Chrome' : isFirefox ? 'Firefox' : 'ÊµèËßàÂô®';
            
            console.log(`üí™ ÂºÄÂßãÂº∫Âà∂ÊøÄÊ¥ª${browserName}ËØ≠Èü≥ÂäüËÉΩ...`);
            
            try {
                // ÊòæÁ§∫ËøõÂ∫¶ÊèêÁ§∫
                const progressTip = document.createElement('div');
                progressTip.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    font-size: 12px;
                    z-index: 3000;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                `;
                progressTip.innerHTML = `üîÑ Ê≠£Âú®ÊøÄÊ¥ª${browserName}ËØ≠Èü≥ÂäüËÉΩÔºåËØ∑Á®çÂÄô...`;
                document.body.appendChild(progressTip);
                
                // ÊâßË°åÂ§öÈáçÊøÄÊ¥ªÁ≠ñÁï•
                const strategies = [
                    // Á≠ñÁï•1ÔºöÂü∫Á°ÄÊøÄÊ¥ª
                    () => {
                        if (voiceReminder) {
                            voiceReminder.engineActivated = false;
                            voiceReminder.activateSpeechSynthesis();
                        }
                    },
                    // Á≠ñÁï•2ÔºöÂº∫Âà∂ÊøÄÊ¥ª
                    () => {
                        if (voiceReminder && voiceReminder.forceActivateForStrictBrowsers) {
                            return voiceReminder.forceActivateForStrictBrowsers();
                        }
                    },
                    // Á≠ñÁï•3ÔºöÁõ¥Êé•ËØ≠Èü≥ÂêàÊàêÊøÄÊ¥ª
                    () => {
                        const utterance = new SpeechSynthesisUtterance('');
                        utterance.volume = 0.01;
                        utterance.rate = 10;
                        speechSynthesis.speak(utterance);
                    },
                    // Á≠ñÁï•4ÔºöÂ§öÊ¨°Â∞ùËØï
                    () => {
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => {
                                const u = new SpeechSynthesisUtterance(' ');
                                u.volume = 0.01;
                                speechSynthesis.speak(u);
                            }, i * 100);
                        }
                    }
                ];
                
                // ÊâßË°åÊâÄÊúâÁ≠ñÁï•
                for (let i = 0; i < strategies.length; i++) {
                    progressTip.innerHTML = `üîÑ Ê≠£Âú®ÊâßË°åÊøÄÊ¥ªÁ≠ñÁï• ${i + 1}/${strategies.length}...`;
                    await new Promise(resolve => {
                        setTimeout(() => {
                            try {
                                strategies[i]();
                            } catch (error) {
                                console.warn(`Á≠ñÁï• ${i + 1} Â§±Ë¥•:`, error);
                            }
                            resolve();
                        }, i * 200);
                    });
                }
                
                // Á≠âÂæÖÊøÄÊ¥ªÂÆåÊàê
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ÊµãËØïÊøÄÊ¥ªÁªìÊûú
                progressTip.innerHTML = `üß™ ÊµãËØï${browserName}ËØ≠Èü≥ÂäüËÉΩ...`;
                
                let testSuccessful = false;
                try {
                    if (voiceReminder && voiceReminder.testVoice) {
                        testSuccessful = await voiceReminder.testVoice();
                    } else {
                        // fallbackÊµãËØï
                        await new Promise((resolve, reject) => {
                            const testUtterance = new SpeechSynthesisUtterance('ËØ≠Èü≥ÊøÄÊ¥ªÊµãËØï');
                            testUtterance.volume = 0.7;
                            testUtterance.onstart = () => {
                                testSuccessful = true;
                                resolve(true);
                            };
                            testUtterance.onerror = reject;
                            speechSynthesis.speak(testUtterance);
                            
                            setTimeout(() => {
                                if (!testSuccessful) reject(new Error('ÊµãËØïË∂ÖÊó∂'));
                            }, 3000);
                        });
                    }
                } catch (error) {
                    console.error('ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•:', error);
                }
                
                // ÁßªÈô§ËøõÂ∫¶ÊèêÁ§∫
                progressTip.remove();
                
                // ÊòæÁ§∫ÁªìÊûú
                if (testSuccessful) {
                    alert(`üéâ ${browserName}ËØ≠Èü≥ÂäüËÉΩÊøÄÊ¥ªÊàêÂäüÔºÅ\n\nÊÇ®ÂàöÊâçÂ∫îËØ•Âê¨Âà∞‰∫ÜÊµãËØïËØ≠Èü≥„ÄÇ\nÂ¶ÇÊûúÊ≤°ÊúâÂê¨Âà∞ÔºåËØ∑Ê£ÄÊü•ËÆæÂ§áÈü≥ÈáèËÆæÁΩÆ„ÄÇ`);
                    updateVoiceIndicator();
                } else {
                    const advancedHelp = `‚ùå ${browserName}ËØ≠Èü≥ÊøÄÊ¥ªÂ§±Ë¥•\n\nÈ´òÁ∫ßËß£ÂÜ≥ÊñπÊ°àÔºö\n\n1. üì± ${browserName}ÁâπÂÆöËÆæÁΩÆÔºö\n`;
                    if (isChrome) {
                        alert(advancedHelp + `   ‚Ä¢ Âú®Âú∞ÂùÄÊ†èËæìÂÖ•Ôºöchrome://flags/#autoplay-policy\n   ‚Ä¢ Â∞ÜÁ≠ñÁï•ËÆæÁΩÆ‰∏∫"No user gesture is required"\n   ‚Ä¢ ÈáçÂêØÊµèËßàÂô®ÂêéÈáçËØï\n\n2. üîä Èü≥È¢ëÊøÄÊ¥ªÔºö\n   ‚Ä¢ ÂÖàÊí≠Êîæ‰∏ÄÊÆµÈü≥‰πêÊàñËßÜÈ¢ë\n   ‚Ä¢ ÁÑ∂ÂêéÁ´ãÂç≥ÊµãËØïËØ≠Èü≥ÂäüËÉΩ\n\n3. üîÑ ÈáçÁΩÆÊñπÊ°àÔºö\n   ‚Ä¢ Âà∑Êñ∞È°µÈù¢\n   ‚Ä¢ Á´ãÂç≥Â§öÊ¨°ÁÇπÂáªÊåâÈíÆ\n   ‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®SafariÊµèËßàÂô®`);
                    } else if (isFirefox) {
                        alert(advancedHelp + `   ‚Ä¢ Âú®Âú∞ÂùÄÊ†èËæìÂÖ•Ôºöabout:config\n   ‚Ä¢ ÊêúÁ¥¢Ôºömedia.autoplay.default\n   ‚Ä¢ ËÆæÁΩÆÂÄº‰∏∫Ôºö0\n   ‚Ä¢ ÈáçÂêØÊµèËßàÂô®ÂêéÈáçËØï\n\n2. üîä ÊùÉÈôêÊ£ÄÊü•Ôºö\n   ‚Ä¢ ÁÇπÂáªÂú∞ÂùÄÊ†èÁöÑÁõæÁâåÂõæÊ†á\n   ‚Ä¢ ÂÖÅËÆ∏Èü≥È¢ëÊí≠ÊîæÊùÉÈôê\n\n3. üîÑ ÈáçÁΩÆÊñπÊ°àÔºö\n   ‚Ä¢ Âà∑Êñ∞È°µÈù¢\n   ‚Ä¢ Á´ãÂç≥Â§öÊ¨°ÁÇπÂáªÊåâÈíÆ\n   ‚Ä¢ Âª∫ËÆÆ‰ΩøÁî®SafariÊµèËßàÂô®`);
                    }
                }
                
            } catch (error) {
                console.error('Âº∫Âà∂ÊøÄÊ¥ªËøáÁ®ãÂ§±Ë¥•:', error);
                alert(`üí• ${browserName}ËØ≠Èü≥Âº∫Âà∂ÊøÄÊ¥ªÂ§±Ë¥•\n\nÈîôËØØÔºö${error.message}\n\nÂª∫ËÆÆÔºö\n1. Âà∑Êñ∞È°µÈù¢ÈáçËØï\n2. Êõ¥Êç¢‰∏∫SafariÊµèËßàÂô®\n3. Ê£ÄÊü•ËÆæÂ§áÈü≥È¢ëËÆæÁΩÆ`);
            }
        }

        /**
         * ÊòæÁ§∫ÁºìÂ≠ò‰øÆÂ§çÈÄâÈ°π
         */
        function showCacheFixOptions() {
            const options = 'üîß ÁºìÂ≠òÈóÆÈ¢ò‰øÆÂ§çÈÄâÈ°π\n\n' +
                          'Â¶ÇÊûúÊÇ®ÁöÑÂäüËÉΩ‰∏çÂÆåÊï¥ÔºàÂ¶ÇÁº∫Â∞ëËØ≠Èü≥ÂõæÊ†áüîäÔºâÔºå\n' +
                          'ÂèØËÉΩÊòØÁºìÂ≠ò‰∫ÜÊóßÁâàÊú¨ÔºåËØ∑ÈÄâÊã©Ôºö\n\n' +
                          'üîÑ Á°ÆÂÆöÔºöÂº∫Âà∂Ê£ÄÊü•Êõ¥Êñ∞\n' +
                          'üóëÔ∏è ÂèñÊ∂àÔºöÊ∏ÖÈô§ÊâÄÊúâÁºìÂ≠òÂπ∂ÈáçÊñ∞Âä†ËΩΩ\n\n' +
                          '‚ö†Ô∏è Ê∏ÖÈô§ÁºìÂ≠ò‰ºöÈáçÊñ∞‰∏ãËΩΩÊâÄÊúâÊñá‰ª∂';
            
            const choice = confirm(options);
            
            if (choice) {
                // Âº∫Âà∂Ê£ÄÊü•Êõ¥Êñ∞
                console.log('Áî®Êà∑ÈÄâÊã©Âº∫Âà∂Ê£ÄÊü•Êõ¥Êñ∞');
                forceCheckUpdate();
                setTimeout(() => {
                    alert('‚úÖ Êõ¥Êñ∞Ê£ÄÊü•ÂÆåÊàêÔºÅ\n\nÂ¶ÇÊûú‰ªçÊúâÈóÆÈ¢òÔºåËØ∑ÈÄâÊã©Ê∏ÖÈô§ÁºìÂ≠òÈÄâÈ°π„ÄÇ');
                }, 2000);
            } else {
                // ÊòæÁ§∫Êõ¥Âº∫ÁöÑÊ∏ÖÈô§ÈÄâÈ°π
                const clearOptions = 'üóëÔ∏è ÁºìÂ≠òÊ∏ÖÈô§ÈÄâÈ°π\n\n' +
                                   'ÈÄâÊã©Ê∏ÖÈô§ÊñπÂºèÔºö\n\n' +
                                   '‚úÖ Á°ÆÂÆöÔºöÊô∫ËÉΩÊ∏ÖÈô§ÔºàÊé®ËçêÔºâ\n' +
                                   'üî• ÂèñÊ∂àÔºöÂº∫Âà∂Êõ¥Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨\n\n' +
                                   'üí° Âº∫Âà∂Êõ¥Êñ∞‰ºöÁ°Æ‰øùÊâÄÊúâËÆæÂ§áËé∑ÂæóÁõ∏ÂêåÁâàÊú¨';
                
                const clearChoice = confirm(clearOptions);
                
                if (clearChoice) {
                    // Êô∫ËÉΩÊ∏ÖÈô§
                    clearCacheAndReload();
                } else {
                    // Âº∫Âà∂Êõ¥Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨
                    manualForceUpdate();
                }
            }
        }

        // Âº∫Âà∂ËØ≠Èü≥ÊµãËØïÔºàÁªïËøáÊâÄÊúâÊ£ÄÊü•Ôºâ
        function forceVoiceTest() {
            console.log('ÊâßË°åÂº∫Âà∂ËØ≠Èü≥ÊµãËØï...');
            
            try {
                // ÂÅúÊ≠¢ÂΩìÂâçÊí≠Êîæ
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance('ËØ≠Èü≥ÊµãËØïÊàêÂäüÔºÅÁ≥ªÁªüÊ≠£Â∏∏Â∑•‰ΩúÔºÅ');
                utterance.volume = 0.8;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.lang = 'zh-CN';
                
                utterance.onstart = () => {
                    console.log('Âº∫Âà∂ËØ≠Èü≥ÊµãËØïÂºÄÂßãÊí≠Êîæ');
                };
                
                utterance.onend = () => {
                    console.log('Âº∫Âà∂ËØ≠Èü≥ÊµãËØïÊí≠ÊîæÂÆåÊàê');
                };
                
                utterance.onerror = (e) => {
                    console.error('Âº∫Âà∂ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•:', e);
                    alert('ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ôºö\n1. ÊâãÊú∫ÊòØÂê¶ÈùôÈü≥\n2. ÊµèËßàÂô®ÊòØÂê¶ÂÖÅËÆ∏Èü≥È¢ëÊí≠Êîæ\n3. ÊòØÂê¶ÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÊøÄÊ¥ªÈü≥È¢ë');
                };
                
                console.log('ÂºÄÂßãÊí≠ÊîæÂº∫Âà∂ËØ≠Èü≥ÊµãËØï');
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Âº∫Âà∂ËØ≠Èü≥ÊµãËØïÂºÇÂ∏∏:', error);
                alert('ËØ≠Èü≥ÊµãËØïÂºÇÂ∏∏: ' + error.message);
            }
        }

        // Âú®ËØ≠Èü≥ÊåáÁ§∫Âô®‰∏äÊ∑ªÂä†ÂèåÂáª‰∫ã‰ª∂ËøõË°åÂº∫Âà∂ÊµãËØï
        // document.addEventListener('DOMContentLoaded', function() {
        //     const indicator = document.getElementById('voiceIndicator');
        //     if (indicator) {
        //         indicator.addEventListener('dblclick', forceVoiceTest);
        //     }
        // });

        // Âä†ËΩΩÊï∞ÊçÆ
        function loadData() {
            const saved = localStorage.getItem('studyCheckIn');
            if (saved) {
                studyData = JSON.parse(saved);
            }
            
            // ËÆ°ÁÆóÊÄªÁßØÂàÜ
            totalPoints = parseInt(localStorage.getItem('totalPoints')) || 0;
        }

        // ‰øùÂ≠òÊï∞ÊçÆ
        function saveData() {
            localStorage.setItem('studyCheckIn', JSON.stringify(studyData));
            localStorage.setItem('totalPoints', totalPoints.toString());
        }

        // Êõ¥Êñ∞ÊÄªÁßØÂàÜ
        function updateTotalPoints() {
            // ËÆ°ÁÆóÊâÄÊúâÊó•ÊúüÁöÑÁßØÂàÜÊÄªÂíå
            let calculatedTotal = 0;
            for (const dateKey in studyData) {
                const plans = studyData[dateKey] || [];
                for (const plan of plans) {
                    calculatedTotal += plan.earnedPoints || 0;
                }
            }
            
            // ‰øùÂ≠ò‰πãÂâçÁöÑÁßØÂàÜ
            const previousTotalPoints = totalPoints;
            totalPoints = calculatedTotal;
            
            // Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
            document.getElementById('totalPointsCalendar').textContent = totalPoints;
            document.getElementById('totalPointsStudy').textContent = totalPoints;
            document.getElementById('totalPointsCenter').textContent = totalPoints;
            document.getElementById('totalPointsDisplay').textContent = totalPoints;
            
            // üÜï Ê£ÄÊü•Â•ñÂä±ËææÊàêÊÉÖÂÜµÔºàÂè™ÊúâÁßØÂàÜÂ¢ûÈïøÊó∂ÊâçÊ£ÄÊü•Ôºâ
            if (totalPoints > previousTotalPoints) {
                checkAndTriggerRewards(previousTotalPoints, totalPoints);
            }
            
            // üÜï Êí≠ÊîæÁßØÂàÜÂèòÂåñËØ≠Èü≥ÊèêÈÜí
            if (voiceReminder && voiceReminder.isEnabled && totalPoints !== previousTotalPoints) {
                const pointsDiff = totalPoints - previousTotalPoints;
                if (pointsDiff > 0) {
                    voiceReminder.speak(`ÁßØÂàÜÂ¢ûÂä†${pointsDiff}ÂàÜÔºåÂΩìÂâçÊÄªÁßØÂàÜ${totalPoints}ÂàÜ`, 'encouragement', 1);
                }
            }
        }

        // Ëé∑ÂèñÊó•ÊúüÈîÆ
        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}Âπ¥${month}Êúà${day}Êó•`;
        }

        // Êó•ÂéÜÁõ∏ÂÖ≥ÂáΩÊï∞
        function updateCalendarDisplay() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}Âπ¥${String(month + 1).padStart(2, '0')}Êúà`;
            
            // ÁîüÊàêÊó•ÂéÜ
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            let monthStudyDays = 0;
            let monthTasks = 0;
            let monthPoints = 0;
            let monthTotalTasks = 0;
            
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dateKey = getDateKey(currentDate);
                const dayData = studyData[dateKey] || [];
                
                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = currentDate.toDateString() === new Date().toDateString();
                const hasRecord = dayData.length > 0;
                
                let dayPoints = 0;
                let dayCompletedTasks = 0;
                let dayTotalTasks = 0;
                
                for (const plan of dayData) {
                    dayPoints += plan.earnedPoints || 0;
                    dayCompletedTasks += plan.completedTasks || 0;
                    dayTotalTasks += plan.totalTasks || 0;
                }
                
                if (isCurrentMonth && hasRecord) {
                    monthStudyDays++;
                    monthTasks += dayCompletedTasks;
                    monthPoints += dayPoints;
                    monthTotalTasks += dayTotalTasks;
                }
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day ${isCurrentMonth ? 'current-month' : 'other-month'} ${isToday ? 'today' : ''} ${hasRecord ? 'has-record' : ''}`;
                dayElement.innerHTML = `
                    <div>${currentDate.getDate()}</div>
                    ${dayPoints > 0 ? `<div class="day-points">${dayPoints}</div>` : ''}
                `;
                dayElement.onclick = () => goToDate(currentDate);
                calendarGrid.appendChild(dayElement);
            }
            
            // Êõ¥Êñ∞ÊúàÂ∫¶ÁªüËÆ°
            document.getElementById('monthStudyDays').textContent = monthStudyDays;
            document.getElementById('monthTasks').textContent = monthTasks;
            document.getElementById('monthPoints').textContent = monthPoints;
            document.getElementById('monthCompletion').textContent = monthTotalTasks > 0 ? Math.round((monthTasks / monthTotalTasks) * 100) : 0;
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            updateCalendarDisplay();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            currentStudyDate = new Date();
            updateCalendarDisplay();
        }

        function goToDate(date) {
            currentStudyDate = new Date(date);
            switchPage('study');
        }

        // Â≠¶‰π†ËÆ°ÂàíÁõ∏ÂÖ≥ÂáΩÊï∞
        function updateStudyDisplay() {
            document.getElementById('currentStudyDate').textContent = formatDate(currentStudyDate);
            
            const dateKey = getDateKey(currentStudyDate);
            const plans = studyData[dateKey] || [];
            
            const studyPlansContainer = document.getElementById('studyPlans');
            const emptyState = document.getElementById('emptyState');
            
            if (plans.length === 0) {
                studyPlansContainer.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                
                studyPlansContainer.innerHTML = plans.map(plan => `
                    <div class="plan-item">
                        <div class="plan-header">
                            <span class="plan-name">${plan.name}</span>
                            <div class="plan-actions">
                                <div class="action-btn" onclick="deletePlan(${plan.id})">üóëÔ∏è</div>
                            </div>
                        </div>
                        
                        <div class="tasks-table">
                            <div class="table-header">
                                <div>Êó∂Èó¥ÊÆµ</div>
                                <div>‰ªªÂä°</div>
                                <div>Â≠¶‰π†</div>
                                <div>ÊéåÊè°</div>
                                <div>ÁßØÂàÜ</div>
                                <div>Êìç‰Ωú</div>
                            </div>
                            
                            ${plan.tasks.map((task, taskIndex) => `
                                <div class="table-row">
                                    <div>
                                        <div class="time-slot-btn ${task.timeSlot ? 'has-time' : 'no-time'} ${task.timeSlot && voiceReminder?.isEnabled ? 'has-reminder' : ''}" 
                                             onclick="setTimeSlot(${plan.id}, ${task.id})">
                                            ${task.timeSlot || 'ËÆæÁΩÆ'}
                                        </div>
                                    </div>
                                    <div>
                                        <span class="task-text" onclick="editTask(${plan.id}, ${task.id})">${task.name}</span>
                                    </div>
                                    <div>
                                        <div class="checkbox ${task.studyCompleted ? 'checked' : ''}" 
                                             onclick="toggleTaskCompleted(${plan.id}, ${task.id})">
                                            ${task.studyCompleted ? '<span class="check-mark">‚úì</span>' : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="checkbox ${task.masteredCompleted ? 'checked' : ''}" 
                                             onclick="toggleTaskMastered(${plan.id}, ${task.id})">
                                            ${task.masteredCompleted ? '<span class="check-mark">‚úì</span>' : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="points-btn ${task.points > 0 ? 'has-points' : 'no-points'}" 
                                             onclick="setPoints(${plan.id}, ${task.id})">
                                            ${task.points > 0 ? `${task.earnedPoints}/${task.points}` : 'ËÆæÁΩÆ'}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 2px; justify-content: center; align-items: center;">
                                        ${taskIndex > 0 ? `
                                            <div class="move-task-btn" onclick="moveTaskUp(${plan.id}, ${task.id})" title="‰∏äÁßª‰ªªÂä°">
                                                ‚¨ÜÔ∏è
                                            </div>
                                        ` : `<div style="width: 25px;"></div>`}
                                        
                                        ${taskIndex < plan.tasks.length - 1 ? `
                                            <div class="move-task-btn" onclick="moveTaskDown(${plan.id}, ${task.id})" title="‰∏ãÁßª‰ªªÂä°">
                                                ‚¨áÔ∏è
                                            </div>
                                        ` : `<div style="width: 25px;"></div>`}
                                        
                                        <div class="delete-task-btn" onclick="deleteTask(${plan.id}, ${task.id})" title="Âà†Èô§‰ªªÂä°">
                                            üóëÔ∏è
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <div style="text-align: center; margin-top: 10px;">
                                <button class="btn btn-success" onclick="addTask(${plan.id})">+ Ê∑ªÂä†‰ªªÂä°</button>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #f8f9ff; text-align: center; font-size: 12px;">
                            ÂÆåÊàêÂ∫¶: ${plan.completionRate}% | ‰ªªÂä°: ${plan.completedTasks}/${plan.totalTasks} | ÁßØÂàÜ: ${plan.earnedPoints}/${plan.totalPoints}
                        </div>
                    </div>
                `).join('');
            }
            
            // Êõ¥Êñ∞ËØ≠Èü≥ÊèêÈÜí
            if (voiceReminder) {
                voiceReminder.updateAllTaskReminders(studyData, currentStudyDate);
                // ÂêåÊ≠•Âà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü‰ΩøÁî®
                window.studyData = studyData;
                window.currentStudyDate = currentStudyDate;
            }
        }

        function changeDate(delta) {
            currentStudyDate.setDate(currentStudyDate.getDate() + delta);
            updateStudyDisplay();
        }

        // ‰ªªÂä°Êìç‰ΩúÂáΩÊï∞
        function toggleTaskCompleted(planId, taskId) {
            console.log(`üéØ ÂàáÊç¢‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅ: ËÆ°Âàí${planId}, ‰ªªÂä°${taskId}`);
            
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey].find(p => p.id === planId);
            
            if (plan) {
                const task = plan.tasks.find(t => t.id === taskId);
                if (task) {
                    const wasCompleted = task.completed;
                    task.completed = !task.completed;
                    
                    console.log(`‚úÖ ‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞: ${task.name} = ${task.completed ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}`);
                    
                    // üÜï Êí≠Êîæ‰ªªÂä°ÂÆåÊàêËØ≠Èü≥ÊèêÈÜí
                    if (task.completed && window.voiceReminder && window.voiceReminder.canPlayReminder('taskComplete')) {
                        console.log('üîä Êí≠Êîæ‰ªªÂä°ÂÆåÊàêËØ≠Èü≥ÊèêÈÜí');
                        window.voiceReminder.playTaskCompleteReminder(task.name);
                    }
                    
                    saveStudyData();
                    renderStudyPlans();
                    updateTotalPoints();
                }
            }
        }

        // üÜï ‰øÆÂ§ç‰ªªÂä°ÊéåÊè°Áä∂ÊÄÅÂàáÊç¢ÂáΩÊï∞
        function toggleTaskMastered(planId, taskId) {
            console.log(`üéØ ÂàáÊç¢‰ªªÂä°ÊéåÊè°Áä∂ÊÄÅ: ËÆ°Âàí${planId}, ‰ªªÂä°${taskId}`);
            
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey].find(p => p.id === planId);
            
            if (plan) {
                const task = plan.tasks.find(t => t.id === taskId);
                if (task) {
                    const wasMastered = task.mastered;
                    task.mastered = !task.mastered;
                    
                    console.log(`üèÜ ‰ªªÂä°ÊéåÊè°Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞: ${task.name} = ${task.mastered ? 'Â∑≤ÊéåÊè°' : 'Êú™ÊéåÊè°'}`);
                    
                    // üÜï Êí≠Êîæ‰ªªÂä°ÊéåÊè°ËØ≠Èü≥ÊèêÈÜí
                    if (task.mastered && window.voiceReminder && window.voiceReminder.canPlayReminder('taskMaster')) {
                        console.log('üîä Êí≠Êîæ‰ªªÂä°ÊéåÊè°ËØ≠Èü≥ÊèêÈÜí');
                        window.voiceReminder.playTaskMasterReminder(task.name, task.points || 10);
                    }
                    
                    saveStudyData();
                    renderStudyPlans();
                    updateTotalPoints();
                }
            }
        }

        function updateTaskPoints(task) {
            let earned = 0;
            if (task.studyCompleted) earned += Math.floor(task.points * 0.5);
            if (task.masteredCompleted) earned += Math.floor(task.points * 0.5);
            task.earnedPoints = earned;
        }

        function updatePlanStats(plan) {
            const completedTasks = plan.tasks.filter(task => 
                task.studyCompleted && task.masteredCompleted
            ).length;
            
            plan.completedTasks = completedTasks;
            plan.completionRate = Math.round((completedTasks / plan.totalTasks) * 100);
            plan.earnedPoints = plan.tasks.reduce((sum, task) => sum + task.earnedPoints, 0);
        }

        function editTask(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            const task = plan?.tasks.find(t => t.id === taskId);
            
            if (task) {
                const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰ªªÂä°ÂêçÁß∞Ôºö', task.name);
                if (newName && newName !== task.name) {
                    task.name = newName;
                    saveData();
                    updateStudyDisplay();
                }
            }
        }

        function setTimeSlot(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            const task = plan?.tasks.find(t => t.id === taskId);
            
            if (task) {
                const timeSlot = prompt('ËØ∑ËæìÂÖ•Êó∂Èó¥ÊÆµÔºà‰æãÂ¶ÇÔºö21:00-21:15ÔºâÔºö', task.timeSlot || '');
                if (timeSlot !== null) {
                    task.timeSlot = timeSlot;
                    saveData();
                    updateStudyDisplay();
                    
                    // ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
                    if (timeSlot) {
                        console.log('Â∞ùËØïËÆæÁΩÆÊó∂Èó¥ÊÆµËØ≠Èü≥ÊèêÈÜí:', timeSlot);
                        if (voiceReminder) {
                            console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåËÆæÁΩÆ‰ªªÂä°ÊèêÈÜí');
                            voiceReminder.setTaskReminder(task, plan.name);
                            
                            // ËØ¢ÈóÆÊòØÂê¶Á´ãÂç≥ÊµãËØï
                            const testNow = confirm(`Êó∂Èó¥ÊÆµÂ∑≤ËÆæÁΩÆ‰∏∫Ôºö${timeSlot}\n\nÊòØÂê¶Á´ãÂç≥ÊµãËØïËØ≠Èü≥ÊèêÈÜíÔºü\nÁÇπÂáª"Á°ÆÂÆö"Â∞ÜÂú®5ÁßíÂêéÊí≠ÊîæÊµãËØïÊèêÈÜí`);
                            if (testNow) {
                                console.log('Áî®Êà∑ÈÄâÊã©Á´ãÂç≥ÊµãËØïÊó∂Èó¥ÊèêÈÜí');
                                voiceReminder.setTestReminder(task, plan.name, 5);
                            }
                            
                            if (voiceReminder.isEnabled && voiceReminder.reminderTypes.settingConfirm) {
                                console.log('Êí≠ÊîæËÆæÁΩÆÁ°ÆËÆ§ËØ≠Èü≥');
                                voiceReminder.playSettingConfirmReminder('timeSlot', {
                                    taskName: task.name,
                                    timeSlot: timeSlot
                                });
                            } else {
                                console.log('ËÆæÁΩÆÁ°ÆËÆ§ËØ≠Èü≥Ë¢´Á¶ÅÁî®');
                            }
                        } else {
                            console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
                        }
                    }
                }
            }
        }

        function setPoints(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            const task = plan?.tasks.find(t => t.id === taskId);
            
            if (task) {
                const points = prompt('ËØ∑ËæìÂÖ•ÁßØÂàÜÔºö', task.points || '');
                if (points !== null && !isNaN(points)) {
                    task.points = parseInt(points);
                    plan.totalPoints = plan.tasks.reduce((sum, task) => sum + task.points, 0);
                    updateTaskPoints(task);
                    updatePlanStats(plan);
                    saveData();
                    updateTotalPoints();
                    updateStudyDisplay();
                    
                    // Êí≠ÊîæËÆæÁΩÆÁ°ÆËÆ§ÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
                    console.log('Â∞ùËØïÊí≠ÊîæÁßØÂàÜËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí:', points);
                    if (voiceReminder) {
                        console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÊ£ÄÊü•ËÆæÁΩÆ:', voiceReminder.isEnabled, voiceReminder.reminderTypes.settingConfirm);
                        if (voiceReminder.isEnabled && voiceReminder.reminderTypes.settingConfirm) {
                            console.log('Êí≠ÊîæÁßØÂàÜËÆæÁΩÆÁ°ÆËÆ§ËØ≠Èü≥');
                            voiceReminder.playSettingConfirmReminder('points', points);
                        } else {
                            console.log('ËÆæÁΩÆÁ°ÆËÆ§ËØ≠Èü≥Ë¢´Á¶ÅÁî®');
                        }
                    } else {
                        console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
                    }
                }
            }
        }

        function addTask(planId) {
            const taskName = prompt('ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞Ôºö');
            if (taskName) {
                const dateKey = getDateKey(currentStudyDate);
                const plan = studyData[dateKey]?.find(p => p.id === planId);
                
                if (plan) {
                    const newTask = {
                        id: Date.now(),
                        name: taskName,
                        timeSlot: '',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 0,
                        earnedPoints: 0
                    };
                    
                    plan.tasks.push(newTask);
                    plan.totalTasks = plan.tasks.length;
                    updatePlanStats(plan);
                    saveData();
                    updateStudyDisplay();
                }
            }
        }

        /**
         * Âà†Èô§Âçï‰∏™‰ªªÂä°
         * @param {number} planId - ËÆ°ÂàíID
         * @param {number} taskId - ‰ªªÂä°ID
         */
        function deleteTask(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            const task = plan?.tasks.find(t => t.id === taskId);
            
            if (!plan || !task) {
                console.error('Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑ‰ªªÂä°');
                return;
            }
            
            // Á°ÆËÆ§Âà†Èô§
            const confirmMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§‰ªªÂä°"${task.name}"ÂêóÔºü\n\n‚ö†Ô∏è Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            console.log(`ÂáÜÂ§áÂà†Èô§‰ªªÂä°: ${task.name} (ID: ${taskId})`);
            
            // Â¶ÇÊûú‰ªªÂä°ËÆæÁΩÆ‰∫ÜËØ≠Èü≥ÊèêÈÜíÔºåÂÖàÊ∏ÖÈô§ÊèêÈÜí
            if (voiceReminder && task.timeSlot) {
                const reminderId = `${task.id}_${plan.name}`;
                voiceReminder.clearTaskReminder(reminderId);
                console.log('Â∑≤Ê∏ÖÈô§‰ªªÂä°ÁöÑËØ≠Èü≥ÊèêÈÜí');
            }
            
            // ‰ªé‰ªªÂä°Êï∞ÁªÑ‰∏≠Âà†Èô§‰ªªÂä°
            const taskIndex = plan.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                plan.tasks.splice(taskIndex, 1);
                console.log(`‰ªªÂä°Â∑≤‰ªéÊï∞ÁªÑ‰∏≠Âà†Èô§ÔºåÂâ©‰Ωô‰ªªÂä°Êï∞: ${plan.tasks.length}`);
            }
            
            // Â¶ÇÊûúËÆ°Âàí‰∏≠Ê≤°Êúâ‰ªªÂä°‰∫ÜÔºåËØ¢ÈóÆÊòØÂê¶Âà†Èô§Êï¥‰∏™ËÆ°Âàí
            if (plan.tasks.length === 0) {
                const deleteEmptyPlan = confirm(`ËÆ°Âàí"${plan.name}"‰∏≠Â∑≤ÁªèÊ≤°Êúâ‰ªªÂä°‰∫ÜÔºåÊòØÂê¶Âà†Èô§Êï¥‰∏™ËÆ°ÂàíÔºü`);
                if (deleteEmptyPlan) {
                    deletePlan(planId);
                    return; // Áõ¥Êé•ËøîÂõûÔºåÂõ†‰∏∫Êï¥‰∏™ËÆ°ÂàíÈÉΩË¢´Âà†Èô§‰∫Ü
                } else {
                    // Â¶ÇÊûú‰∏çÂà†Èô§ËÆ°ÂàíÔºåÊ∑ªÂä†‰∏Ä‰∏™ÊèêÁ§∫‰ªªÂä°
                    const placeholderTask = {
                        id: Date.now(),
                        name: 'ÁÇπÂáªÊ∑ªÂä†Êñ∞‰ªªÂä°',
                        timeSlot: '',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 0,
                        earnedPoints: 0
                    };
                    plan.tasks.push(placeholderTask);
                }
            }
            
            // Êõ¥Êñ∞ËÆ°ÂàíÁªüËÆ°‰ø°ÊÅØ
            plan.totalTasks = plan.tasks.length;
            plan.totalPoints = plan.tasks.reduce((sum, task) => sum + task.points, 0);
            updatePlanStats(plan);
            
            // ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
            saveData();
            updateTotalPoints();
            updateStudyDisplay();
            
            console.log('‰ªªÂä°Âà†Èô§ÂÆåÊàêÔºåÁïåÈù¢Â∑≤Êõ¥Êñ∞');
            
            // Êí≠ÊîæÂà†Èô§Á°ÆËÆ§ËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`‰ªªÂä°"${task.name}"Â∑≤Âà†Èô§`, null, 1);
            }
        }

        function deletePlan(planId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÆ°ÂàíÂêóÔºü')) {
                const dateKey = getDateKey(currentStudyDate);
                studyData[dateKey] = studyData[dateKey]?.filter(p => p.id !== planId) || [];
                saveData();
                updateTotalPoints();
                updateStudyDisplay();
            }
        }

        // Ê∑ªÂä†ËÆ°ÂàíÁõ∏ÂÖ≥ÂáΩÊï∞
        function showAddPlanModal() {
            document.getElementById('addPlanModal').style.display = 'block';
        }

        function hideAddPlanModal() {
            document.getElementById('addPlanModal').style.display = 'none';
            document.getElementById('addPlanForm').reset();
        }

        function addPlan(planName, tasksText) {
            const dateKey = getDateKey(currentStudyDate);
            
            if (!studyData[dateKey]) {
                studyData[dateKey] = [];
            }

            const tasks = tasksText.split('\n').filter(line => line.trim()).map((line, index) => {
                const parts = line.split('|');
                const taskName = parts[0]?.trim() || `‰ªªÂä°${index + 1}`;
                const points = parseInt(parts[1]?.trim()) || 0;
                
                return {
                    id: Date.now() + index,
                    name: taskName,
                    timeSlot: '',
                    studyCompleted: false,
                    masteredCompleted: false,
                    points: points,
                    earnedPoints: 0
                };
            });

            const plan = {
                id: Date.now(),
                name: planName,
                tasks: tasks,
                completionRate: 0,
                completedTasks: 0,
                totalTasks: tasks.length,
                earnedPoints: 0,
                totalPoints: tasks.reduce((sum, task) => sum + task.points, 0)
            };

            studyData[dateKey].push(plan);
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæËÆ°ÂàíÊ∑ªÂä†ÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Â∞ùËØïÊí≠ÊîæËÆ°ÂàíÊ∑ªÂä†ËØ≠Èü≥ÊèêÈÜí:', planName, '‰ªªÂä°Êï∞:', tasks.length);
            if (voiceReminder) {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÊ£ÄÊü•ËÆæÁΩÆ:', voiceReminder.isEnabled, voiceReminder.reminderTypes.planAdded);
                if (voiceReminder.isEnabled && voiceReminder.reminderTypes.planAdded) {
                    console.log('Êí≠ÊîæËÆ°ÂàíÊ∑ªÂä†ËØ≠Èü≥');
                    voiceReminder.playPlanAddedReminder(planName, tasks.length);
                } else {
                    console.log('ËÆ°ÂàíÊ∑ªÂä†ËØ≠Èü≥Ë¢´Á¶ÅÁî®');
                }
            } else {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
            }
        }

        document.getElementById('addPlanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const planName = document.getElementById('planName').value.trim();
            const tasksText = document.getElementById('planTasks').value.trim();
            
            if (planName && tasksText) {
                addPlan(planName, tasksText);
                hideAddPlanModal();
            }
        });

        // ÁßØÂàÜÈ°µÈù¢Áõ∏ÂÖ≥ÂáΩÊï∞
        function updatePointsDisplay() {
            const today = new Date();
            const todayKey = getDateKey(today);
            const todayPlans = studyData[todayKey] || [];
            const todayPoints = todayPlans.reduce((sum, plan) => sum + (plan.earnedPoints || 0), 0);
            
            document.getElementById('todayPoints').textContent = todayPoints;
            
            // ËÆ°ÁÆóÊú¨Âë®ÁßØÂàÜ
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            let weekPoints = 0;
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateKey = getDateKey(date);
                const plans = studyData[dateKey] || [];
                weekPoints += plans.reduce((sum, plan) => sum + (plan.earnedPoints || 0), 0);
            }
            
            document.getElementById('weekPoints').textContent = weekPoints;
            
            // ËÆ°ÁÆóÊú¨ÊúàÁßØÂàÜ
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            let monthPoints = 0;
            
            for (let date = new Date(monthStart); date <= monthEnd; date.setDate(date.getDate() + 1)) {
                const dateKey = getDateKey(date);
                const plans = studyData[dateKey] || [];
                monthPoints += plans.reduce((sum, plan) => sum + (plan.earnedPoints || 0), 0);
            }
            
            document.getElementById('monthPointsCenter').textContent = monthPoints;
            
            // üÜï Êõ¥Êñ∞Â•ñÂä±È¢ÑËßàÂíåÂàóË°®
            updateRewardPreview();
            renderRewardListInPoints();
        }

        /**
         * Ê∏≤ÊüìÁßØÂàÜÈ°µÈù¢‰∏≠ÁöÑÂ•ñÂä±ÂàóË°®ÔºàÁÆÄÊ¥ÅÁâàÔºâ
         */
        function renderRewardListInPoints() {
            const rewardListElement = document.getElementById('rewardListInPoints');
            if (!rewardListElement) return;
            
            if (rewardSettings.length === 0) {
                rewardListElement.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px; border: 2px dashed #e0e0e0; border-radius: 10px;">
                        <div style="font-size: 20px; margin-bottom: 8px;">üéØ</div>
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">ËøòÊ≤°ÊúâËÆæÁΩÆÂ•ñÂä±</div>
                        <div style="font-size: 12px; color: #666;">ÁÇπÂáª"ËÆæÁΩÆÂ•ñÂä±"ÊåâÈíÆÊ∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Â•ñÂä±ÂêßÔºÅ</div>
                    </div>
                `;
                return;
            }
            
            const sortedRewards = [...rewardSettings].sort((a, b) => a.requiredPoints - b.requiredPoints);
            
            const rewardItems = sortedRewards.map(reward => {
                const isAchieved = totalPoints >= reward.requiredPoints;
                const isClaimed = isRewardClaimed(reward.id);
                const progress = Math.min((totalPoints / reward.requiredPoints) * 100, 100);
                const remaining = Math.max(reward.requiredPoints - totalPoints, 0);
                
                return `
                    <div style="
                        background: ${isAchieved ? 'linear-gradient(135deg, #e7f5e7, #d4edda)' : 'linear-gradient(135deg, #f8f9ff, #e8eaff)'};
                        padding: 12px 15px;
                        border-radius: 12px;
                        margin-bottom: 10px;
                        border: 2px solid ${isAchieved ? '#51cf66' : '#e0e0e0'};
                        position: relative;
                    ">
                        ${isAchieved ? '<div style="position: absolute; top: 8px; right: 12px; color: #51cf66; font-size: 16px;">‚úÖ</div>' : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 15px; color: #333; margin-bottom: 3px;">
                                    üèÜ ${reward.rewardName}
                                </div>
                                <div style="color: #666; font-size: 13px;">
                                    ÁõÆÊ†áÔºö${reward.requiredPoints}ÂàÜ
                                    ${reward.description ? ` ‚Ä¢ ${reward.description}` : ''}
                                </div>
                            </div>
                            
                            ${isAchieved && !isClaimed ? `
                                <button onclick="claimReward('${reward.id}')" style="
                                    background: linear-gradient(135deg, #ffa726, #ff8f00);
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 12px;
                                    font-weight: bold;
                                    margin-left: 10px;
                                ">
                                    üéÅ È¢ÜÂèñ
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- ËøõÂ∫¶Êù° -->
                        <div style="margin-bottom: 5px;">
                            <div style="background: #f0f0f0; border-radius: 10px; height: 6px; overflow: hidden;">
                                <div style="
                                    background: ${isAchieved ? 'linear-gradient(135deg, #51cf66, #69db7c)' : 'linear-gradient(135deg, #667eea, #764ba2)'};
                                    height: 100%;
                                    width: ${progress}%;
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                        </div>
                        
                        <!-- Áä∂ÊÄÅ‰ø°ÊÅØ -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="
                                background: ${isAchieved ? '#51cf66' : (progress > 50 ? '#667eea' : '#868e96')};
                                color: white;
                                padding: 3px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: bold;
                            ">
                                ${isAchieved ? 'Â∑≤ËææÊàê' : (remaining > 0 ? `ËøòÈúÄ ${remaining} ÂàÜ` : 'Âç≥Â∞ÜËææÊàê')}
                            </span>
                            
                            <div style="font-size: 11px; color: #888;">
                                ${Math.round(progress)}% ÂÆåÊàê
                                ${isClaimed ? ' ‚Ä¢ Â∑≤È¢ÜÂèñ' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            rewardListElement.innerHTML = rewardItems;
        }

        /**
         * Âø´ÈÄüÈ¢ÜÂèñÂ•ñÂä±ÔºàÂú®ÁßØÂàÜÈ°µÈù¢Ôºâ
         * @param {string} rewardId - Â•ñÂä±ID
         */
        function claimReward(rewardId) {
            const reward = rewardSettings.find(r => r.id === rewardId);
            if (!reward) {
                alert('Êâæ‰∏çÂà∞Ë¶ÅÈ¢ÜÂèñÁöÑÂ•ñÂä±ÔºÅ');
                return;
            }
            
            if (totalPoints < reward.requiredPoints) {
                alert(`ÁßØÂàÜ‰∏çË∂≥ÔºÅËøòÈúÄË¶Å ${reward.requiredPoints - totalPoints} ÁßØÂàÜÊâçËÉΩÈ¢ÜÂèñÊ≠§Â•ñÂä±„ÄÇ`);
                return;
            }
            
            if (isRewardClaimed(reward.id)) {
                alert('ËØ•Â•ñÂä±Â∑≤ÁªèÈ¢ÜÂèñËøá‰∫ÜÔºÅ');
                return;
            }
            
            // Á°ÆËÆ§È¢ÜÂèñ
            if (confirm(`üéâ ÊÅ≠ÂñúËææÊàêÂ•ñÂä±ÔºÅ\n\nÂ•ñÂä±ÂêçÁß∞Ôºö${reward.rewardName}\nÊâÄÈúÄÁßØÂàÜÔºö${reward.requiredPoints}ÂàÜ\n\nÁ°ÆÂÆöË¶ÅÈ¢ÜÂèñËøô‰∏™Â•ñÂä±ÂêóÔºü`)) {
                // ËÆ∞ÂΩïÈ¢ÜÂèñ
                const claimedReward = {
                    id: reward.id,
                    rewardName: reward.rewardName,
                    requiredPoints: reward.requiredPoints,
                    description: reward.description,
                    claimedAt: new Date().toISOString()
                };
                
                claimedRewards.push(claimedReward);
                saveRewardData();
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                updateRewardPreview();
                renderRewardListInPoints();
                
                // Êí≠ÊîæÈ¢ÜÂèñÊàêÂäüËØ≠Èü≥
                if (voiceReminder && voiceReminder.isEnabled) {
                    voiceReminder.speak(`ÊÅ≠ÂñúÊÇ®ÊàêÂäüÈ¢ÜÂèñÂ•ñÂä±Ôºö${reward.rewardName}ÔºÅÁªßÁª≠Âä†Ê≤πÔºÅ`, 'taskComplete', 1);
                }
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showSuccessMessage(`üéâ Â•ñÂä±È¢ÜÂèñÊàêÂäüÔºÅ\n"${reward.rewardName}"\n\nÁªßÁª≠Âä™ÂäõÔºåËé∑ÂæóÊõ¥Â§öÂ•ñÂä±ÂêßÔºÅ`);
                
                console.log('üéÅ Â•ñÂä±È¢ÜÂèñÊàêÂäü:', claimedReward);
            }
        }

        // Ê®°ÊÄÅÊ°ÜÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('addPlanModal');
            if (event.target == modal) {
                hideAddPlanModal();
            }
        }

        // Â§çÂà∂Êò®Â§©ÁöÑÂ≠¶‰π†ËÆ°Âàí
        function copyYesterday() {
            const yesterday = new Date(currentStudyDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = getDateKey(yesterday);
            const yesterdayPlans = studyData[yesterdayKey] || [];
            
            if (yesterdayPlans.length === 0) {
                alert('Êò®Â§©Ê≤°ÊúâÂ≠¶‰π†ËÆ°ÂàíÂèØ‰ª•Â§çÂà∂');
                return;
            }
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂ§çÂà∂Êò®Â§©(${formatDate(yesterday)})ÁöÑ${yesterdayPlans.length}‰∏™Â≠¶‰π†ËÆ°ÂàíÂêóÔºü`)) {
                return;
            }
            
            const today = getDateKey(currentStudyDate);
            if (!studyData[today]) {
                studyData[today] = [];
            }
            
            // Â§çÂà∂Êò®Â§©ÁöÑËÆ°ÂàíÂà∞‰ªäÂ§©
            yesterdayPlans.forEach(plan => {
                const newPlan = {
                    id: Date.now() + Math.random(),
                    name: plan.name,
                    tasks: plan.tasks.map(task => ({
                        id: Date.now() + Math.random(),
                        name: task.name,
                        timeSlot: task.timeSlot,
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: task.points,
                        earnedPoints: 0
                    })),
                    completionRate: 0,
                    completedTasks: 0,
                    totalTasks: plan.totalTasks,
                    earnedPoints: 0,
                    totalPoints: plan.totalPoints
                };
                studyData[today].push(newPlan);
            });
            
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæÊàêÂäüÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Â∞ùËØïÊí≠ÊîæÂ§çÂà∂ËÆ°ÂàíÊàêÂäüËØ≠Èü≥ÊèêÈÜí');
            if (voiceReminder) {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÂº∫Âà∂Êí≠ÊîæËØ≠Èü≥');
                // Áõ¥Êé•Ë∞ÉÁî®speakÊñπÊ≥ïÔºå‰∏çÊ£ÄÊü•Á±ªÂûãÈôêÂà∂
                voiceReminder.speak('Â∑≤ÊàêÂäüÂ§çÂà∂Êò®Â§©ÁöÑÂ≠¶‰π†ËÆ°ÂàíÔºÅ‰ªäÂ§©ÁªßÁª≠Âä†Ê≤πÔºÅ', null, 3);
            } else {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
            }
        }

        // Âä†ËΩΩÂ≠¶‰π†Ê®°Êùø
        function loadTemplate() {
            const templates = [
                {
                    name: 'È´òÊïàÂ≠¶‰π†Ê®°Êùø',
                    tasks: [
                        { name: 'Êô®ËØªËã±ËØ≠', timeSlot: '7:00-7:30', points: 10 },
                        { name: 'Êï∞Â≠¶ÁªÉ‰π†', timeSlot: '9:00-10:00', points: 15 },
                        { name: '‰∏ì‰∏öËØæÂ≠¶‰π†', timeSlot: '14:00-16:00', points: 20 },
                        { name: 'Â§ç‰π†ÊÄªÁªì', timeSlot: '20:00-21:00', points: 15 }
                    ]
                },
                {
                    name: 'ËÄÉËØïÂÜ≤Âà∫Ê®°Êùø',
                    tasks: [
                        { name: 'ÈáçÁÇπÁü•ËØÜÂ§ç‰π†', timeSlot: '8:00-10:00', points: 25 },
                        { name: 'Âà∑È¢òÁªÉ‰π†', timeSlot: '14:00-16:00', points: 20 },
                        { name: 'ÈîôÈ¢òÊï¥ÁêÜ', timeSlot: '19:00-20:00', points: 15 },
                        { name: 'Áü•ËØÜÊ¢≥ÁêÜ', timeSlot: '21:00-22:00', points: 15 }
                    ]
                },
                {
                    name: 'ËØ≠Ë®ÄÂ≠¶‰π†Ê®°Êùø',
                    tasks: [
                        { name: 'ÂçïËØçËÆ∞ÂøÜ', timeSlot: '7:00-7:30', points: 10 },
                        { name: 'Âê¨ÂäõÁªÉ‰π†', timeSlot: '12:00-12:30', points: 10 },
                        { name: 'ÈòÖËØªÁêÜËß£', timeSlot: '15:00-16:00', points: 15 },
                        { name: 'Âè£ËØ≠ÁªÉ‰π†', timeSlot: '20:00-20:30', points: 10 }
                    ]
                },
                {
                    name: 'ÊäÄËÉΩÊèêÂçáÊ®°Êùø',
                    tasks: [
                        { name: 'ÁºñÁ®ãÂÆûË∑µ', timeSlot: '9:00-11:00', points: 20 },
                        { name: 'ÁêÜËÆ∫Â≠¶‰π†', timeSlot: '14:00-15:30', points: 15 },
                        { name: 'È°πÁõÆÁªÉ‰π†', timeSlot: '19:00-21:00', points: 25 },
                        { name: 'ÊäÄÊúØÊÄªÁªì', timeSlot: '21:30-22:00', points: 10 }
                    ]
                }
            ];
            
            const templateList = templates.map((template, index) => 
                `${index + 1}. ${template.name} (${template.tasks.length}‰∏™‰ªªÂä°)`
            ).join('\n');
            
            const choice = prompt(`ËØ∑ÈÄâÊã©Â≠¶‰π†Ê®°ÊùøÔºö\n\n${templateList}\n\nËØ∑ËæìÂÖ•Ê®°ÊùøÁºñÂè∑ (1-${templates.length}):`);
            
            if (!choice || isNaN(choice) || choice < 1 || choice > templates.length) {
                return;
            }
            
            const selectedTemplate = templates[choice - 1];
            const today = getDateKey(currentStudyDate);
            
            if (!studyData[today]) {
                studyData[today] = [];
            }
            
            // ÂàõÂª∫Âü∫‰∫éÊ®°ÊùøÁöÑÂ≠¶‰π†ËÆ°Âàí
            const newPlan = {
                id: Date.now(),
                name: selectedTemplate.name,
                tasks: selectedTemplate.tasks.map((task, index) => ({
                    id: Date.now() + index,
                    name: task.name,
                    timeSlot: task.timeSlot,
                    studyCompleted: false,
                    masteredCompleted: false,
                    points: task.points,
                    earnedPoints: 0
                })),
                completionRate: 0,
                completedTasks: 0,
                totalTasks: selectedTemplate.tasks.length,
                earnedPoints: 0,
                totalPoints: selectedTemplate.tasks.reduce((sum, task) => sum + task.points, 0)
            };
            
            studyData[today].push(newPlan);
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæÊàêÂäüÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Â∞ùËØïÊí≠ÊîæÊ®°ÊùøÂä†ËΩΩÊàêÂäüËØ≠Èü≥ÊèêÈÜí:', selectedTemplate.name);
            if (voiceReminder) {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÂº∫Âà∂Êí≠ÊîæËØ≠Èü≥');
                // Áõ¥Êé•Ë∞ÉÁî®speakÊñπÊ≥ïÔºå‰∏çÊ£ÄÊü•Á±ªÂûãÈôêÂà∂
                voiceReminder.speak(`Â∑≤ÊàêÂäüÂä†ËΩΩ${selectedTemplate.name}ÔºÅÂºÄÂßã‰ªäÂ§©ÁöÑÂ≠¶‰π†ÂêßÔºÅ`, null, 3);
            } else {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
            }
        }

        // Âä†ËΩΩÈªòËÆ§Â≠¶‰π†ËÆ°Âàí
        function loadDefaultPlan() {
            if (!confirm('Á°ÆÂÆöË¶ÅÂä†ËΩΩÈªòËÆ§Â≠¶‰π†ËÆ°ÂàíÂêóÔºüËøôÂ∞ÜÂàõÂª∫‰∏Ä‰∏™Âü∫Á°ÄÁöÑÊó•Â∏∏Â≠¶‰π†ÂÆâÊéí„ÄÇ')) {
                return;
            }
            
            const today = getDateKey(currentStudyDate);
            if (!studyData[today]) {
                studyData[today] = [];
            }
            
            // ÂàõÂª∫ÈªòËÆ§Â≠¶‰π†ËÆ°Âàí
            const defaultPlan = {
                id: Date.now(),
                name: 'ÈªòËÆ§Â≠¶‰π†ËÆ°Âàí',
                tasks: [
                    {
                        id: Date.now() + 1,
                        name: 'Êô®ËØªÊó∂ÂÖâ',
                        timeSlot: '7:30-8:00',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 10,
                        earnedPoints: 0
                    },
                    {
                        id: Date.now() + 2,
                        name: '‰∏äÂçàÂ≠¶‰π†',
                        timeSlot: '9:00-10:30',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 20,
                        earnedPoints: 0
                    },
                    {
                        id: Date.now() + 3,
                        name: '‰∏ãÂçàÂ§ç‰π†',
                        timeSlot: '14:30-16:00',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 20,
                        earnedPoints: 0
                    },
                    {
                        id: Date.now() + 4,
                        name: 'ÊôöÈó¥ÊÄªÁªì',
                        timeSlot: '20:00-21:00',
                        studyCompleted: false,
                        masteredCompleted: false,
                        points: 15,
                        earnedPoints: 0
                    }
                ],
                completionRate: 0,
                completedTasks: 0,
                totalTasks: 4,
                earnedPoints: 0,
                totalPoints: 65
            };
            
            studyData[today].push(defaultPlan);
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæÊàêÂäüÊèêÈÜí - Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log('Â∞ùËØïÊí≠ÊîæÈªòËÆ§ËÆ°ÂàíÂàõÂª∫ÊàêÂäüËØ≠Èü≥ÊèêÈÜí');
            if (voiceReminder) {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°Â≠òÂú®ÔºåÂº∫Âà∂Êí≠ÊîæËØ≠Èü≥');
                // Áõ¥Êé•Ë∞ÉÁî®speakÊñπÊ≥ïÔºå‰∏çÊ£ÄÊü•Á±ªÂûãÈôêÂà∂
                voiceReminder.speak('ÈªòËÆ§Â≠¶‰π†ËÆ°ÂàíÂ∑≤ÂàõÂª∫ÔºÅÂºÄÂßã‰Ω†ÁöÑÂ≠¶‰π†‰πãÊóÖÂêßÔºÅ', null, 3);
            } else {
                console.log('ËØ≠Èü≥ÊèêÈÜíÂØπË±°‰∏çÂ≠òÂú®');
            }
        }

        /**
         * È°µÈù¢Âà∑Êñ∞ÂäüËÉΩ
         * @param {string} pageType - È°µÈù¢Á±ªÂûã ('calendar', 'study', 'points', 'template')
         */
        function refreshPage(pageType) {
            console.log(`üîÑ ÂºÄÂßãÂà∑Êñ∞${pageType}È°µÈù¢...`);
            
            const refreshBtn = document.querySelector(`#${pageType}Page .refresh-btn`);
            
            // Ê∑ªÂä†ÊóãËΩ¨Âä®Áîª
            if (refreshBtn) {
                refreshBtn.classList.add('spinning');
                console.log('‚úÖ Âà∑Êñ∞ÊåâÈíÆÂä®ÁîªÂ∑≤ÂêØÂä®');
            } else {
                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞Âà∑Êñ∞ÊåâÈíÆ');
            }
            
            // Ê®°ÊãüÂà∑Êñ∞Âª∂ËøüÔºåËÆ©Áî®Êà∑ÁúãÂà∞Âà∑Êñ∞Âä®Áîª
            setTimeout(() => {
                try {
                    console.log('üì¶ ÂºÄÂßãÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ...');
                    
                    // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    if (typeof loadData === 'function') {
                        loadData();
                        console.log('‚úÖ loadData() ÊâßË°åÊàêÂäü');
                    } else {
                        console.error('‚ùå loadData ÂáΩÊï∞‰∏çÂ≠òÂú®');
                        throw new Error('loadData ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    }
                    
                    if (typeof updateTotalPoints === 'function') {
                        updateTotalPoints();
                        console.log('‚úÖ updateTotalPoints() ÊâßË°åÊàêÂäü');
                    } else {
                        console.error('‚ùå updateTotalPoints ÂáΩÊï∞‰∏çÂ≠òÂú®');
                        throw new Error('updateTotalPoints ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    }
                    
                    // Ê†πÊçÆÈ°µÈù¢Á±ªÂûãÊõ¥Êñ∞Áõ∏Â∫îÊòæÁ§∫
                    console.log(`üéØ ÂºÄÂßãÊõ¥Êñ∞ ${pageType} È°µÈù¢ÊòæÁ§∫...`);
                    switch (pageType) {
                        case 'calendar':
                            try {
                                // ÈáçÁΩÆÊó•ÂéÜÊòæÁ§∫
                                currentCalendarDate = new Date();
                                if (typeof updateCalendarDisplay === 'function') {
                                    updateCalendarDisplay();
                                    console.log('‚úÖ Êó•ÂéÜÈ°µÈù¢Âà∑Êñ∞ÂÆåÊàê');
                                } else {
                                    throw new Error('updateCalendarDisplay ÂáΩÊï∞‰∏çÂ≠òÂú®');
                                }
                            } catch (error) {
                                console.error('‚ùå Êó•ÂéÜÈ°µÈù¢Âà∑Êñ∞Â§±Ë¥•:', error);
                                throw error;
                            }
                            break;
                            
                        case 'study':
                            try {
                                // ÈáçÁΩÆÂ≠¶‰π†ËÆ°ÂàíÊòæÁ§∫
                                if (typeof updateStudyDisplay === 'function') {
                                    updateStudyDisplay();
                                    console.log('‚úÖ Â≠¶‰π†ËÆ°ÂàíÊòæÁ§∫Êõ¥Êñ∞ÂÆåÊàê');
                                } else {
                                    throw new Error('updateStudyDisplay ÂáΩÊï∞‰∏çÂ≠òÂú®');
                                }
                                
                                // ÈáçÊñ∞ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí
                                if (voiceReminder && typeof voiceReminder.updateAllTaskReminders === 'function') {
                                    console.log('üîä ÈáçÊñ∞ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí...');
                                    voiceReminder.updateAllTaskReminders(studyData, currentStudyDate);
                                    window.studyData = studyData;
                                    window.currentStudyDate = currentStudyDate;
                                    
                                    if (typeof updateVoiceIndicator === 'function') {
                                        updateVoiceIndicator();
                                        console.log('‚úÖ ËØ≠Èü≥ÊåáÁ§∫Âô®Êõ¥Êñ∞ÂÆåÊàê');
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™Â∞±Áª™ÔºåË∑≥ËøáËØ≠Èü≥ËÆæÁΩÆ');
                                }
                                console.log('‚úÖ Â≠¶‰π†ËÆ°ÂàíÈ°µÈù¢Âà∑Êñ∞ÂÆåÊàê');
                            } catch (error) {
                                console.error('‚ùå Â≠¶‰π†ËÆ°ÂàíÈ°µÈù¢Âà∑Êñ∞Â§±Ë¥•:', error);
                                throw error;
                            }
                            break;
                            
                        case 'points':
                            try {
                                // ÈáçÊñ∞ËÆ°ÁÆóÂíåÊòæÁ§∫ÁßØÂàÜ
                                if (typeof updatePointsDisplay === 'function') {
                                    updatePointsDisplay();
                                    console.log('‚úÖ ÁßØÂàÜÈ°µÈù¢Âà∑Êñ∞ÂÆåÊàê');
                                } else {
                                    throw new Error('updatePointsDisplay ÂáΩÊï∞‰∏çÂ≠òÂú®');
                                }
                            } catch (error) {
                                console.error('‚ùå ÁßØÂàÜÈ°µÈù¢Âà∑Êñ∞Â§±Ë¥•:', error);
                                throw error;
                            }
                            break;
                            
                        case 'template':
                            try {
                                // Ê®°ÊùøÈ°µÈù¢ÊöÇÊó∂Êó†ÈúÄÁâπÊÆäÂ§ÑÁêÜ
                                console.log('‚úÖ Ê®°ÊùøÈ°µÈù¢Âà∑Êñ∞ÂÆåÊàê');
                            } catch (error) {
                                console.error('‚ùå Ê®°ÊùøÈ°µÈù¢Âà∑Êñ∞Â§±Ë¥•:', error);
                                throw error;
                            }
                            break;
                            
                        default:
                            console.warn('‚ö†Ô∏è Êú™Áü•È°µÈù¢Á±ªÂûã:', pageType);
                    }
                    
                    // ÊòæÁ§∫Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫
                    console.log('üéâ ÊòæÁ§∫Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫...');
                    if (typeof showRefreshSuccess === 'function') {
                        showRefreshSuccess();
                    } else {
                        console.error('‚ùå showRefreshSuccess ÂáΩÊï∞‰∏çÂ≠òÂú®');
                    }
                    
                    // Êí≠ÊîæÂà∑Êñ∞ÊàêÂäüËØ≠Èü≥ÊèêÈÜí
                    if (voiceReminder && voiceReminder.isEnabled && typeof voiceReminder.speak === 'function') {
                        const pageNames = {
                            'calendar': 'Êó•ÂéÜ',
                            'study': 'Â≠¶‰π†ËÆ°Âàí',
                            'points': 'ÁßØÂàÜ‰∏≠ÂøÉ',
                            'template': 'Â≠¶‰π†Ê®°Êùø'
                        };
                        const pageName = pageNames[pageType] || 'È°µÈù¢';
                        voiceReminder.speak(`${pageName}È°µÈù¢Âà∑Êñ∞ÂÆåÊàêÔºÅ`, null, 1);
                        console.log('üîä ËØ≠Èü≥ÊèêÈÜíÊí≠ÊîæÂÆåÊàê');
                    }
                    
                    console.log(`üéä ${pageType}È°µÈù¢Âà∑Êñ∞ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ`);
                    
                } catch (error) {
                    console.error('üí• È°µÈù¢Âà∑Êñ∞ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', {
                        pageType: pageType,
                        error: error.message,
                        stack: error.stack
                    });
                    
                    // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
                    const errorMsg = `Âà∑Êñ∞Â§±Ë¥•ÔºÅ\n\nÈîôËØØËØ¶ÊÉÖÔºö\n${error.message}\n\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞Ëé∑ÂèñÊõ¥Â§ö‰ø°ÊÅØ`;
                    alert(errorMsg);
                    
                } finally {
                    // ÁßªÈô§ÊóãËΩ¨Âä®Áîª
                    if (refreshBtn) {
                        refreshBtn.classList.remove('spinning');
                        console.log('üîÑ Âà∑Êñ∞ÊåâÈíÆÂä®ÁîªÂ∑≤ÂÅúÊ≠¢');
                    }
                }
                
            }, 500); // Âª∂Ëøü500ÊØ´ÁßíËÆ©Áî®Êà∑ÁúãÂà∞Âä®ÁîªÊïàÊûú
        }

        /**
         * ÊòæÁ§∫Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫
         */
        function showRefreshSuccess() {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊèêÁ§∫
            const existingTip = document.querySelector('.refresh-success');
            if (existingTip) {
                existingTip.remove();
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÊàêÂäüÊèêÁ§∫
            const successTip = document.createElement('div');
            successTip.className = 'refresh-success';
            successTip.innerHTML = '‚úÖ È°µÈù¢Âà∑Êñ∞ÊàêÂäüÔºÅ';
            
            document.body.appendChild(successTip);
            
            // 2ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (successTip && successTip.parentNode) {
                    successTip.remove();
                }
            }, 2000);
        }

        /**
         * ÂÖ®Â±ÄÈ°µÈù¢Âà∑Êñ∞Âø´Êç∑ÈîÆ
         * Êåâ‰∏ã Ctrl+R Êàñ F5 Êó∂Âà∑Êñ∞ÂΩìÂâçÊøÄÊ¥ªÁöÑÈ°µÈù¢
         */
        document.addEventListener('keydown', function(event) {
            // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ã‰∫ÜÂà∑Êñ∞Âø´Êç∑ÈîÆ
            if ((event.ctrlKey && event.key === 'r') || event.key === 'F5') {
                event.preventDefault(); // ÈòªÊ≠¢ÊµèËßàÂô®ÈªòËÆ§Âà∑Êñ∞
                
                // ÊâæÂà∞ÂΩìÂâçÊøÄÊ¥ªÁöÑÈ°µÈù¢
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    const pageId = activePage.id;
                    const pageType = pageId.replace('Page', ''); // ÁßªÈô§'Page'ÂêéÁºÄ
                    
                    console.log('Âø´Êç∑ÈîÆËß¶ÂèëÈ°µÈù¢Âà∑Êñ∞:', pageType);
                    refreshPage(pageType);
                }
            }
        });

        /**
         * Êô∫ËÉΩÈ°µÈù¢Âà∑Êñ∞
         * Ê†πÊçÆÂΩìÂâçÈ°µÈù¢Áä∂ÊÄÅÂíåÊï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥ÔºåÂÜ≥ÂÆöÊòØÂê¶ÈúÄË¶ÅÂà∑Êñ∞
         */
        function smartRefresh() {
            const lastUpdateTime = localStorage.getItem('lastDataUpdate');
            const currentTime = Date.now();
            
            // Â¶ÇÊûúÊï∞ÊçÆË∂ÖËøá5ÂàÜÈíüÊ≤°ÊúâÊõ¥Êñ∞ÔºåÊèêÁ§∫Áî®Êà∑Âà∑Êñ∞
            if (lastUpdateTime && (currentTime - parseInt(lastUpdateTime)) > 5 * 60 * 1000) {
                const shouldRefresh = confirm('Ê£ÄÊµãÂà∞Êï∞ÊçÆÂèØËÉΩÂ∑≤ËøáÊó∂ÔºåÊòØÂê¶Âà∑Êñ∞È°µÈù¢Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÔºü');
                if (shouldRefresh) {
                    const activePage = document.querySelector('.page.active');
                    if (activePage) {
                        const pageType = activePage.id.replace('Page', '');
                        refreshPage(pageType);
                    }
                }
            }
        }

        /**
         * Êõ¥Êñ∞Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥Êà≥
         */
        function updateDataTimestamp() {
            localStorage.setItem('lastDataUpdate', Date.now().toString());
        }

        // ÈáçÊñ∞ÂÆö‰πâsaveDataÂáΩÊï∞ÔºåÊ∑ªÂä†Êó∂Èó¥Êà≥Êõ¥Êñ∞ÂäüËÉΩ
        const originalSaveData = saveData;
        if (typeof originalSaveData === 'function') {
            saveData = function() {
                try {
                    originalSaveData();
                    updateDataTimestamp();
                    console.log('üìù Êï∞ÊçÆ‰øùÂ≠òÂÆåÊàêÔºåÊó∂Èó¥Êà≥Â∑≤Êõ¥Êñ∞');
                } catch (error) {
                    console.error('üí• Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•:', error);
                    throw error;
                }
            };
            console.log('‚úÖ saveDataÂáΩÊï∞ÈáçÂÆö‰πâÂÆåÊàê');
        } else {
            console.error('‚ùå ÂéüÂßãsaveDataÂáΩÊï∞‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÈáçÂÆö‰πâ');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®Êô∫ËÉΩÂà∑Êñ∞Ê£ÄÊü•
        setTimeout(() => {
            smartRefresh();
        }, 2000);

        // ÂàùÂßãÂåñÂ∫îÁî®
        // document.addEventListener('DOMContentLoaded', init);

        /**
         * ÊµãËØïÂà∑Êñ∞ÂäüËÉΩ
         * Ëøô‰∏™ÂáΩÊï∞ÂèØ‰ª•Â∏ÆÂä©Áî®Êà∑ËØäÊñ≠Âà∑Êñ∞ÂäüËÉΩÊòØÂê¶Ê≠£Â∏∏Â∑•‰Ωú
         */
        function testRefreshFunction() {
            console.log('üß™ ÂºÄÂßãÊµãËØïÂà∑Êñ∞ÂäüËÉΩ...');
            
            // Ê£ÄÊü•ÊâÄÊúâÂøÖÈúÄÁöÑÂáΩÊï∞ÊòØÂê¶Â≠òÂú®
            const requiredFunctions = [
                'loadData',
                'updateTotalPoints', 
                'updateCalendarDisplay',
                'updateStudyDisplay',
                'updatePointsDisplay',
                'showRefreshSuccess'
            ];
            
            const missingFunctions = [];
            const existingFunctions = [];
            
            requiredFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    existingFunctions.push(funcName);
                    console.log(`‚úÖ ${funcName} - Â≠òÂú®`);
                } else {
                    missingFunctions.push(funcName);
                    console.error(`‚ùå ${funcName} - Áº∫Â§±`);
                }
            });
            
            // Ê£ÄÊü•ÂÖ®Â±ÄÂèòÈáè
            const globalVars = ['studyData', 'currentStudyDate', 'currentCalendarDate', 'totalPoints'];
            globalVars.forEach(varName => {
                if (typeof window[varName] !== 'undefined') {
                    console.log(`‚úÖ ÂÖ®Â±ÄÂèòÈáè ${varName} - Â≠òÂú®:`, window[varName]);
                } else {
                    console.warn(`‚ö†Ô∏è ÂÖ®Â±ÄÂèòÈáè ${varName} - Êú™ÂÆö‰πâ`);
                }
            });
            
            // Ê£ÄÊü•ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü
            if (typeof voiceReminder !== 'undefined' && voiceReminder !== null) {
                console.log('‚úÖ ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü - Â∑≤ÂàùÂßãÂåñ');
                if (typeof voiceReminder.updateAllTaskReminders === 'function') {
                    console.log('‚úÖ ËØ≠Èü≥ÊèêÈÜíÊõ¥Êñ∞ÂáΩÊï∞ - Â≠òÂú®');
                } else {
                    console.warn('‚ö†Ô∏è ËØ≠Èü≥ÊèêÈÜíÊõ¥Êñ∞ÂáΩÊï∞ - Áº∫Â§±');
                }
            } else {
                console.warn('‚ö†Ô∏è ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü - Êú™ÂàùÂßãÂåñ');
            }
            
            // ÁîüÊàêÊµãËØïÊä•Âëä
            const report = {
                functionsTotal: requiredFunctions.length,
                functionsExisting: existingFunctions.length,
                functionsMissing: missingFunctions.length,
                missingFunctionsList: missingFunctions,
                voiceReminderStatus: voiceReminder ? 'Â∑≤ÂàùÂßãÂåñ' : 'Êú™ÂàùÂßãÂåñ'
            };
            
            console.log('üìä Âà∑Êñ∞ÂäüËÉΩÊµãËØïÊä•Âëä:', report);
            
            if (missingFunctions.length === 0) {
                console.log('üéâ ÊâÄÊúâÂøÖÈúÄÂáΩÊï∞ÈÉΩÂ≠òÂú®ÔºåÂà∑Êñ∞ÂäüËÉΩÂ∫îËØ•ÂèØ‰ª•Ê≠£Â∏∏Â∑•‰ΩúÔºÅ');
                alert('‚úÖ Âà∑Êñ∞ÂäüËÉΩÊµãËØïÈÄöËøáÔºÅ\n\nÊâÄÊúâÂøÖÈúÄÁöÑÂáΩÊï∞ÈÉΩÂ≠òÂú®ÔºåÂà∑Êñ∞ÂäüËÉΩÂ∫îËØ•ÂèØ‰ª•Ê≠£Â∏∏Â∑•‰Ωú„ÄÇ\n\nÂ¶ÇÊûú‰ªçÁÑ∂ÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑËØ¶ÁªÜÊó•Âøó„ÄÇ');
                return true;
            } else {
                console.error('üí• ÂèëÁé∞Áº∫Â§±ÁöÑÂáΩÊï∞ÔºåÂà∑Êñ∞ÂäüËÉΩÂèØËÉΩÊó†Ê≥ïÊ≠£Â∏∏Â∑•‰ΩúÔºÅ');
                alert(`‚ùå Âà∑Êñ∞ÂäüËÉΩÊµãËØïÂ§±Ë¥•ÔºÅ\n\nÁº∫Â§±ÁöÑÂáΩÊï∞Ôºö${missingFunctions.join(', ')}\n\nËØ∑Âà∑Êñ∞È°µÈù¢ÊàñËÅîÁ≥ªÂºÄÂèëËÄÖ„ÄÇ`);
                return false;
            }
        }

        // Âú®ÊéßÂà∂Âè∞Êö¥Èú≤ÊµãËØïÂáΩÊï∞
        window.testRefreshFunction = testRefreshFunction;

        /**
         * Â§ÑÁêÜÂà∑Êñ∞ÊåâÈíÆÁöÑÊµãËØïÂäüËÉΩ
         * @param {Event} event - ‰∫ã‰ª∂ÂØπË±°
         * @param {string} pageType - È°µÈù¢Á±ªÂûã
         */
        function handleRefreshTest(event, pageType) {
            event.preventDefault(); // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçï
            
            const btn = event.target;
            btn.classList.add('testing');
            
            console.log(`üß™ ÂºÄÂßãÊµãËØï ${pageType} È°µÈù¢ÁöÑÂà∑Êñ∞ÂäüËÉΩ...`);
            
            // ËøêË°åÊµãËØï
            const testResult = testRefreshFunction();
            
            // ÁßªÈô§ÊµãËØïÊ†∑Âºè
            setTimeout(() => {
                btn.classList.remove('testing');
            }, 2000);
            
            // Â¶ÇÊûúÊµãËØïÈÄöËøáÔºåËØ¢ÈóÆÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞
            if (testResult) {
                setTimeout(() => {
                    const shouldRefresh = confirm(`‚úÖ ${pageType} È°µÈù¢Âà∑Êñ∞ÂäüËÉΩÊµãËØïÈÄöËøáÔºÅ\n\nÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞Ê≠§È°µÈù¢Ôºü`);
                    if (shouldRefresh) {
                        refreshPage(pageType);
                    }
                }, 500);
            }
            
            return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
        }

        // üÜï Â¢ûÂº∫ÁâàËØ≠Èü≥ÂäüËÉΩÂàùÂßãÂåñÔºåÁ°Æ‰øùÂº∫Âà∂Êõ¥Êñ∞ÂêéÊ≠£Â∏∏Â∑•‰Ωú
        function initializeVoiceReminderWithRetry() {
            console.log('üöÄ ÂºÄÂßãÂº∫ÂåñÁâàËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñ...');
            
            // Ê£ÄÊü•ÊµèËßàÂô®ÂÖºÂÆπÊÄß
            if (!('speechSynthesis' in window) || !('SpeechSynthesisUtterance' in window)) {
                console.error('‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêAPI');
                showVoiceUnsupportedMessage();
                return;
            }
            
            let initAttempts = 0;
            const maxAttempts = 3;
            
            function attemptInitialization() {
                initAttempts++;
                console.log(`üîÑ ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÂ∞ùËØï ${initAttempts}/${maxAttempts}`);
                
                try {
                    // ÂàõÂª∫ËØ≠Èü≥ÊèêÈÜíÂÆû‰æã
                    window.voiceReminder = new VoiceReminder();
                    
                    // üÜï ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáèÂà´ÂêçÔºåÊñπ‰æøÂÖ∂‰ªñÂú∞ÊñπÂºïÁî®
                    voiceReminder = window.voiceReminder;
                    
                    // Á≠âÂæÖÂàùÂßãÂåñÂÆåÊàê
                    setTimeout(() => {
                        if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                            console.log('‚úÖ ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
                            
                            // Êõ¥Êñ∞ËØ≠Èü≥ÊåáÁ§∫Âô®
                            updateVoiceIndicator();
                            
                            // Ê£ÄÊü•Âπ∂ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí
                            checkAndSetupVoiceReminders();
                            
                            // Êí≠ÊîæÈ°µÈù¢Âà∑Êñ∞ÊèêÈÜí
                            playPageRefreshReminder();
                            
                        } else {
                            console.warn(`‚ö†Ô∏è ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÊú™ÂÆåÊàêÔºåÂ∞ùËØï ${initAttempts}/${maxAttempts}`);
                            
                            if (initAttempts < maxAttempts) {
                                setTimeout(attemptInitialization, 1000 * initAttempts);
                            } else {
                                console.error('‚ùå ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•ÔºåËææÂà∞ÊúÄÂ§ßÂ∞ùËØïÊ¨°Êï∞');
                                showVoiceInitFailedMessage();
                            }
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error(`üí• ËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñÂºÇÂ∏∏ (Â∞ùËØï ${initAttempts}):`, error);
                    
                    if (initAttempts < maxAttempts) {
                        setTimeout(attemptInitialization, 1000 * initAttempts);
                    } else {
                        showVoiceInitFailedMessage();
                    }
                }
            }
            
            // ÂºÄÂßãÂàùÂßãÂåñ
            attemptInitialization();
        }

        // üÜï Êí≠ÊîæÈ°µÈù¢Âà∑Êñ∞ÊèêÈÜí
        function playPageRefreshReminder() {
            console.log('üîÑ ÂáÜÂ§áÊí≠ÊîæÈ°µÈù¢Âà∑Êñ∞ÊèêÈÜí...');
            
            if (!window.voiceReminder || !window.voiceReminder.speechSynthesis) {
                console.warn('‚ö†Ô∏è ËØ≠Èü≥Á≥ªÁªü‰∏çÂèØÁî®ÔºåË∑≥ËøáÈ°µÈù¢Âà∑Êñ∞ÊèêÈÜí');
                return;
            }
            
            if (!window.voiceReminder.isEnabled) {
                console.log('‚ÑπÔ∏è ËØ≠Èü≥ÊèêÈÜíÂ∑≤Á¶ÅÁî®ÔºåË∑≥ËøáÈ°µÈù¢Âà∑Êñ∞ÊèêÈÜí');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÈ°µÈù¢Âà∑Êñ∞ÔºàËÄå‰∏çÊòØÈ¶ñÊ¨°Âä†ËΩΩÔºâ
            const isPageRefresh = performance.navigation.type === 1;
            const hasExistingData = localStorage.getItem('studyData') !== null;
            
            if (isPageRefresh || hasExistingData) {
                console.log('üîä Êí≠ÊîæÈ°µÈù¢Âà∑Êñ∞ËØ≠Èü≥ÊèêÈÜí');
                
                const refreshMessages = [
                    'È°µÈù¢Â∑≤Âà∑Êñ∞ÔºåÂ≠¶‰π†ÊâìÂç°Á≥ªÁªüÂ∑≤ÂáÜÂ§áÂ∞±Áª™',
                    'Ê¨¢ËøéÂõûÊù•ÔºÅÁªßÁª≠‰Ω†ÁöÑÂ≠¶‰π†ËÆ°ÂàíÂêß',
                    'Á≥ªÁªüÂ∑≤ÈáçÊñ∞Âä†ËΩΩÔºåËØ≠Èü≥ÊèêÈÜíÂäüËÉΩÊ≠£Â∏∏',
                    'Â≠¶‰π†ÊâìÂç°Â∫îÁî®Â∑≤ÂêØÂä®ÔºåÂºÄÂßãÊñ∞ÁöÑ‰∏ÄÂ§©Âêß'
                ];
                
                const message = refreshMessages[Math.floor(Math.random() * refreshMessages.length)];
                
                // Âª∂ËøüÊí≠ÊîæÔºåÁ°Æ‰øùÁ≥ªÁªüÂÆåÂÖ®ÂáÜÂ§áÂ∞±Áª™
                setTimeout(() => {
                    window.voiceReminder.speak(message, 'encouragement');
                }, 1500);
            } else {
                console.log('üÜï È¶ñÊ¨°Âä†ËΩΩÈ°µÈù¢ÔºåÊí≠ÊîæÊ¨¢ËøéËØ≠Èü≥');
                
                setTimeout(() => {
                    window.voiceReminder.speak('Ê¨¢Ëøé‰ΩøÁî®Â≠¶‰π†ÊâìÂç°Â∫îÁî®ÔºÅÂºÄÂßãÂà∂ÂÆö‰Ω†ÁöÑÂ≠¶‰π†ËÆ°ÂàíÂêß', 'encouragement');
                }, 2000);
            }
        }

        // üÜï ÊòæÁ§∫ËØ≠Èü≥‰∏çÊîØÊåÅÊ∂àÊÅØ
        function showVoiceUnsupportedMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ff6b6b, #ee5a52);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
                animation: fadeInOut 10s ease-in-out;
            `;
            
            message.innerHTML = `
                üîá ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂäüËÉΩ<br>
                <span style="font-size: 12px; opacity: 0.9;">
                    Âª∫ËÆÆ‰ΩøÁî®Chrome„ÄÅFirefox„ÄÅSafariÊàñEdgeÊµèËßàÂô®
                </span>
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message && message.parentNode) {
                    message.remove();
                }
            }, 10000);
        }

        // üÜï ÊòæÁ§∫ËØ≠Èü≥ÂàùÂßãÂåñÂ§±Ë¥•Ê∂àÊÅØ
        function showVoiceInitFailedMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ffa726, #ff9800);
                color: white;
                padding: 15px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
                animation: fadeInOut 12s ease-in-out;
                cursor: pointer;
            `;
            
            message.innerHTML = `
                ‚ö†Ô∏è ËØ≠Èü≥ÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•<br>
                <span style="font-size: 12px; opacity: 0.9;">
                    ÁÇπÂáªÈáçËØïÊàñÂà∑Êñ∞È°µÈù¢<br>
                    ÂèØËÉΩÈúÄË¶ÅÊâãÂä®ÂÖÅËÆ∏Èü≥È¢ëÊí≠Êîæ
                </span>
            `;
            
            message.onclick = () => {
                message.remove();
                initializeVoiceReminderWithRetry();
            };
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                if (message && message.parentNode) {
                    message.remove();
                }
            }, 12000);
        }

        // üÜï ÂÖ≥Èó≠ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢
        function closeVoiceSettings() {
            console.log('üîí ÂÖ≥Èó≠ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢');
            
            const modal = document.getElementById('voiceSettingsModal');
            if (modal) {
                modal.style.display = 'none';
                
                // iPhone 6 ‰∏ìÁî®Á°ÆËÆ§
                if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                    setTimeout(() => {
                        window.voiceReminder.speak('ËÆæÁΩÆÁïåÈù¢Â∑≤ÂÖ≥Èó≠', null, 1);
                    }, 300);
                }
            }
        }

        // üÜï ÈíàÂØπiPhone 6ÁöÑËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ‰øÆÂ§ç
        function toggleVoiceSettings() {
            console.log('üéØ ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª - iPhone 6ÂÖºÂÆπÁâà');
            
            // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
            const isIPhone6 = /iPhone OS 9_|iPhone OS 10_|iPhone OS 11_|iPhone OS 12_/.test(navigator.userAgent);
            const isOldSafari = /Safari/.test(navigator.userAgent) && /Version\/[6-9]/.test(navigator.userAgent);
            
            console.log('üì± ËÆæÂ§áÊ£ÄÊµã:', {
                isIPhone6,
                isOldSafari,
                userAgent: navigator.userAgent
            });
            
            try {
                // üéØ Âº∫Âà∂ÊòæÁ§∫ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢
                const modal = document.getElementById('voiceSettingsModal');
                if (!modal) {
                    console.error('‚ùå ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàõÂª∫...');
                    createVoiceSettingsModal();
                    return;
                }
                
                // iPhone 6 ÁâπÊÆäÂ§ÑÁêÜ
                if (isIPhone6 || isOldSafari) {
                    console.log('üîß iPhone 6 ÁâπÊÆäÂ§ÑÁêÜÊ®°Âºè');
                    
                    // Âª∂ËøüÊòæÁ§∫ÔºåÁ°Æ‰øùÁïåÈù¢ÂÆåÂÖ®Âä†ËΩΩ
                    setTimeout(() => {
                        modal.style.display = 'block';
                        modal.style.visibility = 'visible';
                        modal.style.opacity = '1';
                        
                        // Âº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
                        modal.offsetHeight;
                        
                        console.log('‚úÖ iPhone 6 ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢Â∑≤ÊòæÁ§∫');
                    }, 100);
                } else {
                    // Ê†áÂáÜÊòæÁ§∫
                    modal.style.display = 'block';
                    console.log('‚úÖ Ê†áÂáÜËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢Â∑≤ÊòæÁ§∫');
                }
                
                // üîä Êí≠ÊîæÁïåÈù¢ÊâìÂºÄÊèêÁ§∫Èü≥ÔºàiPhone 6 ‰∏ìÁî®Ôºâ
                if (window.voiceReminder && window.voiceReminder.speechSynthesis) {
                    // üÜï ‰∏çÂú®ÁïåÈù¢ÊâìÂºÄÊó∂Á´ãÂç≥Êí≠ÊîæËØ≠Èü≥ÔºåÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢
                    // Âè™Âú®ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ª‰∏îÁî®Êà∑ÊòéÁ°ÆË¶ÅÊ±ÇÊó∂Êí≠Êîæ
                    if (window.voiceReminder.engineActivated && window.voiceReminder.isEnabled) {
                        console.log('üîä ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ªÔºåÊí≠ÊîæÁïåÈù¢ÊâìÂºÄÊèêÁ§∫Èü≥');
                        setTimeout(() => {
                            window.voiceReminder.speak('ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢Â∑≤ÊâìÂºÄ', null, 1);
                        }, 500);
                    } else {
                        console.log('‚ÑπÔ∏è ËØ≠Èü≥ÂºïÊìéÊú™ÊøÄÊ¥ªÊàñË¢´Á¶ÅÁî®ÔºåË∑≥ËøáÁïåÈù¢ÊâìÂºÄÊèêÁ§∫Èü≥');
                    }
                } else {
                    console.log('‚ö†Ô∏è ËØ≠Èü≥Á≥ªÁªü‰∏çÂèØÁî®ÔºåË∑≥ËøáÁïåÈù¢ÊâìÂºÄÊèêÁ§∫Èü≥');
                }
                
            } catch (error) {
                console.error('üí• ÊâìÂºÄËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢Â§±Ë¥•:', error);
                
                // iPhone 6 ÈîôËØØÂ§ÑÁêÜ
                if (isIPhone6) {
                    alert('ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢Âä†ËΩΩÂ§±Ë¥•ÔºåÊ≠£Âú®ÈáçÊñ∞ÂàõÂª∫...');
                    createVoiceSettingsModal();
                } else {
                    alert('ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢ÊâìÂºÄÂ§±Ë¥•: ' + error.message);
                }
            }
        }

        // üÜï ÂàõÂª∫ËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢ÔºàiPhone 6ÂÖºÂÆπÁâàÔºâ
        function createVoiceSettingsModal() {
            console.log('üõ†Ô∏è ÂàõÂª∫iPhone 6ÂÖºÂÆπÁâàËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢...');
            
            // Âà†Èô§Áé∞ÊúâÁïåÈù¢
            const existingModal = document.getElementById('voiceSettingsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑÊ®°ÊÄÅÁïåÈù¢
            const isVoiceEnabled = window.voiceReminder ? window.voiceReminder.isEnabled : false;
            const modalHTML = `
                <div id="voiceSettingsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                    <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <span class="modal-title" style="font-size: 18px; font-weight: bold; color: #333;">üîä ËØ≠Èü≥ËÆæÁΩÆ (iPhone 6Áâà)</span>
                            <button class="close-btn" onclick="closeVoiceSettings()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- ËÆæÂ§áÁä∂ÊÄÅÊòæÁ§∫ -->
                            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d0e7ff;">
                                <div style="font-size: 14px; color: #333; font-weight: bold; margin-bottom: 8px;">üì± ËÆæÂ§á‰ø°ÊÅØ</div>
                                <div id="deviceInfo" style="font-size: 12px; color: #666; line-height: 1.5;"></div>
                            </div>
                            
                            <!-- ‰∏ªÂºÄÂÖ≥ -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; font-size: 16px; font-weight: bold;">
                                    <input type="checkbox" id="voiceEnabled" ${isVoiceEnabled ? 'checked' : ''} style="margin-right: 10px; width: 20px; height: 20px;">
                                    ÂêØÁî®ËØ≠Èü≥ÊèêÈÜí
                                </label>
                            </div>
                            
                            <!-- ÊèêÈÜíÁ±ªÂûãÈÄâÊã© -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333;">ÊèêÈÜíÁ±ªÂûãÈÄâÊã©Ôºö</div>
                                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 14px;">
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="voiceStudyStart" style="margin-right: 8px; width: 18px; height: 18px;">
                                        üïê Â≠¶‰π†ÂºÄÂßãÊèêÈÜí
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="voiceStudyEnd" style="margin-right: 8px; width: 18px; height: 18px;">
                                        ‚è∞ Â≠¶‰π†ÁªìÊùüÊèêÈÜí
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="voiceTaskComplete" style="margin-right: 8px; width: 18px; height: 18px;">
                                        ‚úÖ ‰ªªÂä°ÂÆåÊàêÊèêÈÜí
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="voiceTaskMaster" style="margin-right: 8px; width: 18px; height: 18px;">
                                        üéØ ‰ªªÂä°ÊéåÊè°ÊèêÈÜí
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ËØ≠Èü≥ÂèÇÊï∞ËÆæÁΩÆ -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333;">ËØ≠Èü≥ÂèÇÊï∞Ôºö</div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">Èü≥Èáè</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="voiceVolume" min="0" max="1" step="0.1" value="0.8" style="flex: 1; height: 30px;">
                                        <span id="volumeValue" style="min-width: 40px; font-weight: bold;">80%</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">ËØ≠ÈÄü</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="voiceRate" min="0.5" max="2" step="0.1" value="1.0" style="flex: 1; height: 30px;">
                                        <span id="rateValue" style="min-width: 40px; font-weight: bold;">1.0x</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÊåâÈíÆÁªÑ -->
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="testVoiceForIPhone6()" style="flex: 1; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                                    ÊµãËØïËØ≠Èü≥
                                </button>
                                <button onclick="saveVoiceSettingsForIPhone6()" style="flex: 1; padding: 12px; background: #34C759; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                                    ‰øùÂ≠òËÆæÁΩÆ
                                </button>
                            </div>
                            
                            <!-- Âø´ÈÄüËÆæÁΩÆ -->
                            <div style="margin-top: 15px;">
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333;">Âø´ÈÄüËÆæÁΩÆÔºö</div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="selectAllRemindersForIPhone6()" style="padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">ÂÖ®ÈÄâ</button>
                                    <button onclick="selectNoneRemindersForIPhone6()" style="padding: 8px 12px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; cursor: pointer;">ÂÖ®‰∏çÈÄâ</button>
                                </div>
                            </div>
                            
                            <!-- ‰ΩøÁî®ËØ¥Êòé -->
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 12px; color: #666; line-height: 1.5;">
                                    <strong>üí° iPhone 6 ‰ΩøÁî®ËØ¥ÊòéÔºö</strong><br>
                                    ‚Ä¢ È¶ñÊ¨°‰ΩøÁî®ËØ∑ÂÖÅËÆ∏ÁΩëÈ°µÊí≠ÊîæÈü≥È¢ë<br>
                                    ‚Ä¢ Â¶ÇÊûúÊ≤°ÊúâÂ£∞Èü≥ÔºåËØ∑Ê£ÄÊü•ËÆæÂ§áÈùôÈü≥ÈîÆ<br>
                                    ‚Ä¢ Âª∫ËÆÆÂ∞ÜÈü≥ÈáèË∞ÉËá≥ÈÄÇ‰∏≠Ê∞¥Âπ≥<br>
                                    ‚Ä¢ ËØ≠Èü≥‰ºöËøûÁª≠Êí≠Êîæ3Ê¨°Á°Æ‰øùÂê¨Âà∞
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Êõ¥Êñ∞ËÆæÂ§á‰ø°ÊÅØ
            updateDeviceInfo();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            bindVoiceSettingsEventsForIPhone6();
            
            // Á´ãÂç≥ÊòæÁ§∫
            setTimeout(() => {
                document.getElementById('voiceSettingsModal').style.display = 'block';
            }, 100);
            
            console.log('‚úÖ iPhone 6ÂÖºÂÆπÁâàËØ≠Èü≥ËÆæÁΩÆÁïåÈù¢ÂàõÂª∫ÂÆåÊàê');
        }

        // üÜï Êõ¥Êñ∞ËÆæÂ§á‰ø°ÊÅØ
        function updateDeviceInfo() {
            const deviceInfoElement = document.getElementById('deviceInfo');
            if (!deviceInfoElement) return;
            
            const hasVoiceReminder = window.voiceReminder && window.voiceReminder.speechSynthesis;
            const speechSupported = 'speechSynthesis' in window;
            const voices = speechSupported ? window.speechSynthesis.getVoices() : [];
            
            deviceInfoElement.innerHTML = `
                ÊµèËßàÂô®: ${navigator.userAgent.includes('Safari') ? 'Safari' : 'Unknown'}<br>
                ËØ≠Èü≥ÂºïÊìé: ${speechSupported ? '‚úÖ ÊîØÊåÅ' : '‚ùå ‰∏çÊîØÊåÅ'}<br>
                ËØ≠Èü≥ÂàóË°®: ${voices.length} ‰∏™ÂèØÁî®<br>
                Á≥ªÁªüÁä∂ÊÄÅ: ${hasVoiceReminder ? '‚úÖ Ê≠£Â∏∏' : '‚ùå ÂºÇÂ∏∏'}<br>
                ÂΩìÂâçÊó∂Èó¥: ${new Date().toLocaleTimeString()}
            `;
        }

        // üÜï iPhone 6‰∏ìÁî®‰∫ã‰ª∂ÁªëÂÆö
        function bindVoiceSettingsEventsForIPhone6() {
            console.log('üîß ÁªëÂÆöiPhone 6‰∏ìÁî®‰∫ã‰ª∂...');
            
            // Èü≥ÈáèÊªëÂùó
            const volumeSlider = document.getElementById('voiceVolume');
            const volumeValue = document.getElementById('volumeValue');
            if (volumeSlider && volumeValue) {
                volumeSlider.addEventListener('input', (e) => {
                    const volume = parseFloat(e.target.value);
                    volumeValue.textContent = Math.round(volume * 100) + '%';
                    if (window.voiceReminder) {
                        window.voiceReminder.volume = volume;
                    }
                });
            }
            
            // ËØ≠ÈÄüÊªëÂùó
            const rateSlider = document.getElementById('voiceRate');
            const rateValue = document.getElementById('rateValue');
            if (rateSlider && rateValue) {
                rateSlider.addEventListener('input', (e) => {
                    const rate = parseFloat(e.target.value);
                    rateValue.textContent = rate + 'x';
                    if (window.voiceReminder) {
                        window.voiceReminder.rate = rate;
                    }
                });
            }
            
            // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
            if (window.voiceReminder) {
                const settings = window.voiceReminder;
                
                // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                if (volumeSlider) volumeSlider.value = settings.volume;
                if (volumeValue) volumeValue.textContent = Math.round(settings.volume * 100) + '%';
                if (rateSlider) rateSlider.value = settings.rate;
                if (rateValue) rateValue.textContent = settings.rate + 'x';
                
                // Êõ¥Êñ∞Â§çÈÄâÊ°Ü
                const checkboxes = {
                    'voiceEnabled': settings.isEnabled,
                    'voiceStudyStart': settings.reminderTypes.studyStart,
                    'voiceStudyEnd': settings.reminderTypes.studyEnd,
                    'voiceTaskComplete': settings.reminderTypes.taskComplete,
                    'voiceTaskMaster': settings.reminderTypes.taskMaster
                };
                
                Object.entries(checkboxes).forEach(([id, checked]) => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) checkbox.checked = checked;
                });
            }
            
            console.log('‚úÖ iPhone 6‰∏ìÁî®‰∫ã‰ª∂ÁªëÂÆöÂÆåÊàê');
        }

        // üÜï iPhone 6‰∏ìÁî®ËØ≠Èü≥ÊµãËØï
        function testVoiceForIPhone6() {
            console.log('üß™ iPhone 6‰∏ìÁî®ËØ≠Èü≥ÊµãËØïÂºÄÂßã...');
            
            try {
                if (!window.voiceReminder) {
                    alert('‚ùå ËØ≠Èü≥Á≥ªÁªüÊú™ÂàùÂßãÂåñÔºåËØ∑ÂÖàÂà∑Êñ∞È°µÈù¢');
                    return;
                }
                
                // Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìé
                console.log('üí™ Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìé...');
                window.voiceReminder.activateSpeechSynthesis();
                
                // ÁâπÂà´ÈíàÂØπiPhone 6ÁöÑÊøÄÊ¥ª
                if (window.voiceReminder.activateForIPhone6) {
                    console.log('üì± ‰ΩøÁî®iPhone 6‰∏ìÁî®ÊøÄÊ¥ªÊñπÊ≥ï...');
                    window.voiceReminder.activateForIPhone6();
                }
                
                // Âª∂ËøüÊµãËØïÔºåÁ°Æ‰øùÊøÄÊ¥ªÂÆåÊàê
                setTimeout(() => {
                    console.log('üéµ ÂºÄÂßãiPhone 6ËØ≠Èü≥ÊµãËØï...');
                    
                    const testMessages = [
                        'iPhone 6 ËØ≠Èü≥ÊµãËØïÊàêÂäüÔºÅÁ≥ªÁªüÂ∑•‰ΩúÊ≠£Â∏∏ÔºÅ',
                        'ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ªÔºåÊó∂Èó¥ËäÇÁÇπÊèêÈÜíÂäüËÉΩÊ≠£Â∏∏ÔºÅ',
                        'ÊÇ®ÁöÑËØ≠Èü≥ËÆæÁΩÆÂ∑≤ÁîüÊïàÔºåÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®Â≠¶‰π†ÊèêÈÜíÂäüËÉΩÔºÅ'
                    ];
                    
                    const message = testMessages[Math.floor(Math.random() * testMessages.length)];
                    
                    // Êí≠ÊîæÊµãËØïËØ≠Èü≥
                    window.voiceReminder.speak(message, null, 1);
                    
                    // Ê†áËÆ∞ÂºïÊìéÂ∑≤ÊøÄÊ¥ª
                    window.voiceReminder.engineActivated = true;
                    
                    console.log('‚úÖ iPhone 6ËØ≠Èü≥ÊµãËØïÂÆåÊàê');
                    
                }, 500);
                
            } catch (error) {
                console.error('üí• iPhone 6ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•:', error);
                alert('‚ùå ËØ≠Èü≥ÊµãËØïÂ§±Ë¥•: ' + error.message + '\n\nËØ∑Ê£ÄÊü•ËÆæÂ§áÈü≥ÈáèËÆæÁΩÆÂíåÊµèËßàÂô®ÊùÉÈôê');
            }
        }

        // üÜï iPhone 6ÊïÖÈöúÊéíÈô§
        function showIPhone6TroubleShooting() {
            const troubleShootingMessage = `
üîß iPhone 6 ËØ≠Èü≥ÊïÖÈöúÊéíÈô§

ËØ∑‰æùÊ¨°Ê£ÄÊü•‰ª•‰∏ãÈ°πÁõÆÔºö

1. üì± ËÆæÂ§áËÆæÁΩÆ
   ‚Ä¢ Ê£ÄÊü•ËÆæÂ§áÊòØÂê¶ÈùôÈü≥
   ‚Ä¢ Ë∞ÉÈ´òÈü≥ÈáèÂà∞ÈÄÇ‰∏≠Ê∞¥Âπ≥
   ‚Ä¢ ÂÖ≥Èó≠‰ΩéÁîµÈáèÊ®°Âºè

2. üåê ÊµèËßàÂô®ËÆæÁΩÆ
   ‚Ä¢ Á°Æ‰øùSafariÂÖÅËÆ∏Èü≥È¢ëÊí≠Êîæ
   ‚Ä¢ Ê∏ÖÈô§ÊµèËßàÂô®ÁºìÂ≠ò
   ‚Ä¢ ÂÖ≥Èó≠ÂÖ∂‰ªñÈü≥È¢ëÂ∫îÁî®

3. üìÑ ÁΩëÈ°µËÆæÁΩÆ
   ‚Ä¢ ÂÖàÁÇπÂáªÈ°µÈù¢‰ªªÊÑè‰ΩçÁΩÆ
   ‚Ä¢ Âà∑Êñ∞È°µÈù¢ÈáçËØï
   ‚Ä¢ ‰ΩøÁî®SafariÊµèËßàÂô®

4. üîÑ ÈáçÁΩÆÊ≠•È™§
   ‚Ä¢ ÂÖ≥Èó≠ÊâÄÊúâSafariÊ†áÁ≠æ
   ‚Ä¢ ÈáçÊñ∞ÊâìÂºÄÁΩëÈ°µ
   ‚Ä¢ ÈáçÊñ∞ÊµãËØïËØ≠Èü≥ÂäüËÉΩ

Â¶ÇÊûúÈóÆÈ¢ò‰ªçÁÑ∂Â≠òÂú®ÔºåËØ∑Â∞ùËØïÈáçÂêØËÆæÂ§á„ÄÇ
            `;
            
            alert(troubleShootingMessage);
        }

        // üÜï iPhone 6‰∏ìÁî®‰øùÂ≠òËÆæÁΩÆ
        function saveVoiceSettingsForIPhone6() {
            console.log('üíæ ‰øùÂ≠òiPhone 6ËØ≠Èü≥ËÆæÁΩÆ...');
            
            try {
                if (!window.voiceReminder) {
                    alert('‚ùå ËØ≠Èü≥Á≥ªÁªüÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ï‰øùÂ≠òËÆæÁΩÆ');
                    return;
                }
                
                // Ëé∑ÂèñËÆæÁΩÆÂÄº
                const isEnabled = document.getElementById('voiceEnabled').checked;
                const volume = parseFloat(document.getElementById('voiceVolume').value);
                const rate = parseFloat(document.getElementById('voiceRate').value);
                
                // Ëé∑ÂèñÊèêÈÜíÁ±ªÂûãËÆæÁΩÆ
                const reminderTypes = {
                    studyStart: document.getElementById('voiceStudyStart').checked,
                    studyEnd: document.getElementById('voiceStudyEnd').checked,
                    taskComplete: document.getElementById('voiceTaskComplete').checked,
                    taskMaster: document.getElementById('voiceTaskMaster').checked
                };
                
                // ‰øùÂ≠òËÆæÁΩÆ
                window.voiceReminder.isEnabled = isEnabled;
                window.voiceReminder.volume = volume;
                window.voiceReminder.rate = rate;
                Object.assign(window.voiceReminder.reminderTypes, reminderTypes);
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('voiceReminder_voiceReminderEnabled', JSON.stringify(isEnabled));
                localStorage.setItem('voiceReminder_voiceReminderVolume', JSON.stringify(volume));
                localStorage.setItem('voiceReminder_voiceReminderRate', JSON.stringify(rate));
                
                Object.entries(reminderTypes).forEach(([type, enabled]) => {
                    const key = `voiceReminder_voice${type.charAt(0).toUpperCase() + type.slice(1)}`;
                    localStorage.setItem(key, JSON.stringify(enabled));
                });
                
                // üÜï Âè™Âú®ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ª‰∏îÁî®Êà∑ÊòéÁ°ÆÂêØÁî®ËØ≠Èü≥Êó∂Êí≠ÊîæÁ°ÆËÆ§ÊèêÈÜí
                if (isEnabled && window.voiceReminder.engineActivated) {
                    console.log('üîä ËØ≠Èü≥ÂºïÊìéÂ∑≤ÊøÄÊ¥ªÔºåÊí≠ÊîæËÆæÁΩÆ‰øùÂ≠òÁ°ÆËÆ§');
                    window.voiceReminder.speak('iPhone 6 ËØ≠Èü≥ËÆæÁΩÆÂ∑≤‰øùÂ≠òÊàêÂäü', null, 1);
                } else {
                    console.log('‚ÑπÔ∏è ËØ≠Èü≥Êú™ÂêØÁî®ÊàñÂºïÊìéÊú™ÊøÄÊ¥ªÔºåË∑≥ËøáËÆæÁΩÆ‰øùÂ≠òËØ≠Èü≥Á°ÆËÆ§');
                }
                
                // Êõ¥Êñ∞ÊåáÁ§∫Âô®
                updateVoiceIndicator();
                
                // ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊó∂Èó¥ÊèêÈÜí
                if (isEnabled && window.studyData && window.currentStudyDate) {
                    console.log('üîÑ ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊó∂Èó¥ËäÇÁÇπÊèêÈÜí...');
                    window.voiceReminder.updateAllTaskReminders(window.studyData, window.currentStudyDate);
                }
                
                // ÂÖ≥Èó≠ËÆæÁΩÆÁïåÈù¢
                setTimeout(() => {
                    closeVoiceSettings();
                }, 1000);
                
                console.log('‚úÖ iPhone 6ËØ≠Èü≥ËÆæÁΩÆ‰øùÂ≠òÂÆåÊàê');
                
            } catch (error) {
                console.error('üí• ‰øùÂ≠òiPhone 6ËØ≠Èü≥ËÆæÁΩÆÂ§±Ë¥•:', error);
                alert('‚ùå ‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // üÜï iPhone 6Âø´ÈÄüËÆæÁΩÆ
        function selectAllRemindersForIPhone6() {
            ['voiceStudyStart', 'voiceStudyEnd', 'voiceTaskComplete', 'voiceTaskMaster'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = true;
            });
        }

        function selectNoneRemindersForIPhone6() {
            ['voiceStudyStart', 'voiceStudyEnd', 'voiceTaskComplete', 'voiceTaskMaster'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
        }

        // DOMContentLoaded ‰∫ã‰ª∂Â§ÑÁêÜ - iPhone 6‰∏ìÁî®Áâà
        // document.addEventListener('DOMContentLoaded', function() {
        //     console.log('üöÄ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãiPhone 6‰∏ìÁî®ÂàùÂßãÂåñ...');
        //     
        //     // Âä†ËΩΩÂ≠òÂÇ®ÁöÑÊï∞ÊçÆ
        //     loadStudyData();
        //     
        //     // Ê∏≤ÊüìÂ≠¶‰π†ËÆ°Âàí
        //     renderStudyPlans();
        //     
        //     // Êõ¥Êñ∞ÊÄªÁßØÂàÜ
        //     updateTotalPoints();
        //     
        //     // üÜï ‰ΩøÁî®Âº∫ÂåñÁâàËØ≠Èü≥Á≥ªÁªüÂàùÂßãÂåñ
        //     console.log('üîä ÂêØÂä®iPhone 6‰∏ìÁî®ËØ≠Èü≥Á≥ªÁªü...');
        //     setTimeout(() => {
        //         initializeVoiceReminderWithRetry();
        //     }, 500);
        //     
        //     console.log('‚úÖ iPhone 6‰∏ìÁî®È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        // });

        // DOMContentLoaded ‰∫ã‰ª∂Â§ÑÁêÜ - Êô∫ËÉΩÁéØÂ¢ÉÈÄÇÈÖçÁâà
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÊô∫ËÉΩÁéØÂ¢ÉÊ£ÄÊµã...');
            
            // Âä†ËΩΩÂ≠òÂÇ®ÁöÑÊï∞ÊçÆ
            loadData();
            
            // Êõ¥Êñ∞Â≠¶‰π†ËÆ°ÂàíÊòæÁ§∫
            updateStudyDisplay();
            
            // Êõ¥Êñ∞ÊÄªÁßØÂàÜ
            updateTotalPoints();
            
            // üÜï Êô∫ËÉΩÁéØÂ¢ÉÊ£ÄÊµãÂíåÂàùÂßãÂåñ
            detectEnvironmentAndInit();
            
            // üÜï Âª∂ËøüÊµãËØïËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ
            setTimeout(() => {
                console.log('üß™ ÊµãËØïËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ...');
                const voiceButton = document.querySelector('#voiceReminderSettings');
                if (voiceButton) {
                    console.log('‚úÖ ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆÂ≠òÂú®:', voiceButton);
                } else {
                    console.warn('‚ö†Ô∏è ËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆÊú™ÊâæÂà∞ÔºåÂ∞ùËØïÈáçÊñ∞ÂàõÂª∫...');
                    if (typeof updateVoiceIndicator === 'function') {
                        updateVoiceIndicator();
                    }
                }
            }, 3000);
            
            console.log('‚úÖ Êô∫ËÉΩÁéØÂ¢ÉÈÄÇÈÖçÂàùÂßãÂåñÂÆåÊàê');
        });

        // üÜï Ê£ÄÊü•Âπ∂ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí
        function checkAndSetupVoiceReminders() {
            console.log('üîß Ê£ÄÊü•Âπ∂ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜí...');
            
            try {
                // Ê£ÄÊü•ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊòØÂê¶ÂèØÁî®
                if (!window.voiceReminder || !window.voiceReminder.speechSynthesis) {
                    console.warn('‚ö†Ô∏è ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªü‰∏çÂèØÁî®ÔºåË∑≥ËøáËÆæÁΩÆ');
                    return false;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠¶‰π†Êï∞ÊçÆ
                if (!window.studyData || !window.currentStudyDate) {
                    console.log('‚ÑπÔ∏è Â≠¶‰π†Êï∞ÊçÆ‰∏çÂèØÁî®ÔºåË∑≥ËøáËØ≠Èü≥ÊèêÈÜíËÆæÁΩÆ');
                    return false;
                }
                
                // Êõ¥Êñ∞ÊâÄÊúâ‰ªªÂä°ÊèêÈÜí
                if (typeof window.voiceReminder.updateAllTaskReminders === 'function') {
                    console.log('üìù Êõ¥Êñ∞ÊâÄÊúâ‰ªªÂä°ÁöÑËØ≠Èü≥ÊèêÈÜí...');
                    window.voiceReminder.updateAllTaskReminders(window.studyData, window.currentStudyDate);
                    console.log('‚úÖ ËØ≠Èü≥ÊèêÈÜíËÆæÁΩÆÂÆåÊàê');
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è updateAllTaskRemindersÊñπÊ≥ï‰∏çÂ≠òÂú®');
                    return false;
                }
                
            } catch (error) {
                console.error('üí• ËÆæÁΩÆËØ≠Èü≥ÊèêÈÜíÂ§±Ë¥•:', error);
                return false;
            }
        }

        // üÜï ÊòæÁ§∫È´òÁ∫ßËØ≠Èü≥Ë∞ÉËØï‰ø°ÊÅØ
        function showAdvancedVoiceDebugInfo() {
            console.log('üîß ÊòæÁ§∫È´òÁ∫ßËØ≠Èü≥Ë∞ÉËØï‰ø°ÊÅØ');
            
            const hasVoiceReminder = window.voiceReminder && window.voiceReminder.speechSynthesis;
            const isEnabled = hasVoiceReminder ? window.voiceReminder.isEnabled : false;
            const stats = hasVoiceReminder ? window.voiceReminder.getEnabledReminderStats() : { enabled: 0, total: 0 };
            
            // Ëé∑ÂèñÊõ¥ËØ¶ÁªÜÁöÑÁ≥ªÁªü‰ø°ÊÅØ
            const voices = 'speechSynthesis' in window ? window.speechSynthesis.getVoices() : [];
            const timers = hasVoiceReminder ? window.voiceReminder.timers : new Map();
            
            const debugInfo = `
üîß È´òÁ∫ßËØ≠Èü≥Ë∞ÉËØï‰ø°ÊÅØ

üìä Á≥ªÁªüÁä∂ÊÄÅ:
‚Ä¢ ÂΩìÂâçÊó∂Èó¥: ${new Date().toLocaleString()}
‚Ä¢ È°µÈù¢ÂçèËÆÆ: ${window.location.protocol}
‚Ä¢ È°µÈù¢ÂèØËßÅÊÄß: ${document.visibilityState}
‚Ä¢ ËØ≠Èü≥ÂºïÊìéÊøÄÊ¥ª: ${hasVoiceReminder ? window.voiceReminder.engineActivated : 'Êú™Áü•'}
‚Ä¢ ËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅ: ${hasVoiceReminder ? window.voiceReminder.isPlaying : 'Êú™Áü•'}

üé§ ËØ≠Èü≥ÂºïÊìéËØ¶ÊÉÖ:
‚Ä¢ ËØ≠Èü≥ÊîØÊåÅ: ${'speechSynthesis' in window ? '‚úÖ ÊîØÊåÅ' : '‚ùå ‰∏çÊîØÊåÅ'}
‚Ä¢ ÂèØÁî®ËØ≠Èü≥Êï∞: ${voices.length}
‚Ä¢ ËØ≠Èü≥ÂêàÊàêÁä∂ÊÄÅ: ${window.speechSynthesis ? (window.speechSynthesis.speaking ? 'üîä Êí≠Êîæ‰∏≠' : 'üîá Á©∫Èó≤') : '‚ùå ‰∏çÂèØÁî®'}
‚Ä¢ ËØ≠Èü≥ÈòüÂàó: ${window.speechSynthesis ? (window.speechSynthesis.pending ? 'üìã ÊúâÈòüÂàó' : 'üìã Êó†ÈòüÂàó') : '‚ùå ‰∏çÂèØÁî®'}
‚Ä¢ ËØ≠Èü≥ÊöÇÂÅú: ${window.speechSynthesis ? (window.speechSynthesis.paused ? '‚è∏Ô∏è Â∑≤ÊöÇÂÅú' : '‚ñ∂Ô∏è Ê≠£Â∏∏') : '‚ùå ‰∏çÂèØÁî®'}

‚è∞ ÊèêÈÜíÂÆöÊó∂Âô®:
‚Ä¢ Ê¥ªË∑ÉÂÆöÊó∂Âô®Êï∞Èáè: ${timers.size}
‚Ä¢ ÂÆöÊó∂Âô®ËØ¶ÊÉÖ: ${Array.from(timers.keys()).join(', ') || 'Êó†'}

üì± ËÆæÂ§á‰ø°ÊÅØ:
‚Ä¢ Áî®Êà∑‰ª£ÁêÜ: ${navigator.userAgent}
‚Ä¢ Âπ≥Âè∞: ${navigator.platform}
‚Ä¢ ËØ≠Ë®Ä: ${navigator.language}
‚Ä¢ Âú®Á∫øÁä∂ÊÄÅ: ${navigator.onLine ? '‚úÖ Âú®Á∫ø' : '‚ùå Á¶ªÁ∫ø'}

üîß ÊïÖÈöúÊéíÈô§:
‚Ä¢ ÁÇπÂáª"Á°ÆÂÆö"ËøõË°åËØ≠Èü≥ÂºïÊìéÂº∫Âà∂ÊøÄÊ¥ª
‚Ä¢ ÁÇπÂáª"ÂèñÊ∂à"Êü•ÁúãÊó∂Èó¥ËäÇÁÇπÊèêÈÜíÁä∂ÊÄÅ
            `;
            
            const userChoice = confirm(debugInfo);
            
            if (userChoice) {
                // Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìé
                forceActivateVoiceEngine();
            } else {
                // Ê£ÄÊü•Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÁä∂ÊÄÅ
                checkTimeReminderStatus();
            }
        }
        
        // üÜï Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìé
        function forceActivateVoiceEngine() {
            console.log('üí™ ÂºÄÂßãÂº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìé...');
            
            if (!window.voiceReminder) {
                alert('‚ùå ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™ÂàùÂßãÂåñÔºåÊ≠£Âú®ÈáçÊñ∞ÂàùÂßãÂåñ...');
                setTimeout(() => {
                    initializeVoiceReminderWithRetry();
                }, 500);
                return;
            }
            
            try {
                // Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂêàÊàê
                if (window.voiceReminder.activateSpeechSynthesis) {
                    window.voiceReminder.activateSpeechSynthesis();
                }
                
                // Âº∫Âà∂ÊøÄÊ¥ª‰∏çÂêåÊµèËßàÂô®ÁöÑËØ≠Èü≥ÂºïÊìé
                if (window.voiceReminder.activateForStrictBrowsers) {
                    window.voiceReminder.activateForStrictBrowsers();
                }
                
                // Êí≠ÊîæÊµãËØïËØ≠Èü≥
                setTimeout(() => {
                    const testMessage = 'ËØ≠Èü≥ÂºïÊìéÂº∫Âà∂ÊøÄÊ¥ªÊàêÂäüÔºÅÁ≥ªÁªüÊ≠£Âú®ÊµãËØïËØ≠Èü≥Êí≠ÊîæÂäüËÉΩÔºÅ';
                    window.voiceReminder.speak(testMessage, null, 1);
                    
                    // ËÆæÁΩÆ‰∏Ä‰∏™ÊµãËØïÊèêÈÜí
                    setTimeout(() => {
                        const testTask = {
                            id: 'test_activation',
                            name: 'ËØ≠Èü≥ÊøÄÊ¥ªÊµãËØï',
                            timeSlot: 'ÂΩìÂâçÊó∂Èó¥'
                        };
                        
                        const testReminder = 'ËØ≠Èü≥ÂºïÊìéÊøÄÊ¥ªÊµãËØïÂÆåÊàêÔºåÁé∞Âú®ÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÂäüËÉΩ‰∫ÜÔºÅ';
                        window.voiceReminder.speak(testReminder, null, 1);
                        
                        // Êõ¥Êñ∞ÊâÄÊúâÊó∂Èó¥ÊèêÈÜí
                        if (window.studyData && window.currentStudyDate) {
                            window.voiceReminder.updateAllTaskReminders(window.studyData, window.currentStudyDate);
                            console.log('‚úÖ Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÂ∑≤ÈáçÊñ∞ËÆæÁΩÆ');
                        }
                        
                    }, 2000);
                    
                }, 1000);
                
            } catch (error) {
                console.error('üí• Âº∫Âà∂ÊøÄÊ¥ªËØ≠Èü≥ÂºïÊìéÂ§±Ë¥•:', error);
                alert('‚ùå ËØ≠Èü≥ÂºïÊìéÊøÄÊ¥ªÂ§±Ë¥•: ' + error.message);
            }
        }
        
        // üÜï Ê£ÄÊü•Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÁä∂ÊÄÅ
        function checkTimeReminderStatus() {
            console.log('üîç Ê£ÄÊü•Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÁä∂ÊÄÅ...');
            
            if (!window.voiceReminder) {
                alert('‚ùå ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            const timers = window.voiceReminder.timers;
            const currentTime = new Date().toLocaleString();
            
            let statusInfo = `‚è∞ Êó∂Èó¥ËäÇÁÇπÊèêÈÜíÁä∂ÊÄÅÊä•Âëä\n\n`;
            statusInfo += `üìÖ ÂΩìÂâçÊó∂Èó¥: ${currentTime}\n`;
            statusInfo += `üîä ËØ≠Èü≥ÂºïÊìé: ${window.voiceReminder.engineActivated ? '‚úÖ Â∑≤ÊøÄÊ¥ª' : '‚ùå Êú™ÊøÄÊ¥ª'}\n`;
            statusInfo += `üìã Ê¥ªË∑ÉÂÆöÊó∂Âô®: ${timers.size} ‰∏™\n\n`;
            
            if (timers.size > 0) {
                statusInfo += `üìù ÂÆöÊó∂Âô®ËØ¶ÊÉÖ:\n`;
                for (const [reminderId, timerInfo] of timers) {
                    statusInfo += `‚Ä¢ ${reminderId}: ${timerInfo.task.name}\n`;
                    statusInfo += `  Êó∂Èó¥ÊÆµ: ${timerInfo.task.timeSlot}\n`;
                    statusInfo += `  ËÆ°Âàí: ${timerInfo.planName}\n\n`;
                }
            } else {
                statusInfo += `‚ö†Ô∏è Ê≤°ÊúâÊ¥ªË∑ÉÁöÑÊó∂Èó¥ËäÇÁÇπÊèêÈÜí\n\n`;
                statusInfo += `ÂèØËÉΩÂéüÂõ†:\n`;
                statusInfo += `‚Ä¢ Ê≤°ÊúâËÆæÁΩÆÊó∂Èó¥ÊÆµ\n`;
                statusInfo += `‚Ä¢ Êó∂Èó¥ÊÆµÊ†ºÂºè‰∏çÊ≠£Á°Æ\n`;
                statusInfo += `‚Ä¢ Êó∂Èó¥Â∑≤ËøáÊúü\n`;
                statusInfo += `‚Ä¢ ËØ≠Èü≥ÊèêÈÜíË¢´Á¶ÅÁî®\n\n`;
            }
            
            statusInfo += `üîß Ëß£ÂÜ≥ÊñπÊ°à:\n`;
            statusInfo += `‚Ä¢ Á°ÆÂÆö: Á´ãÂç≥ËÆæÁΩÆÊµãËØïÊèêÈÜí\n`;
            statusInfo += `‚Ä¢ ÂèñÊ∂à: ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊèêÈÜí\n`;
            
            const userChoice = confirm(statusInfo);
            
            if (userChoice) {
                // ËÆæÁΩÆÊµãËØïÊèêÈÜí
                setTestReminderNow();
            } else {
                // ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊèêÈÜí
                resetAllTimeReminders();
            }
        }
        
        // üÜï Á´ãÂç≥ËÆæÁΩÆÊµãËØïÊèêÈÜí
        function setTestReminderNow() {
            console.log('üß™ ËÆæÁΩÆÁ´ãÂç≥ÊµãËØïÊèêÈÜí...');
            
            if (!window.voiceReminder) {
                alert('‚ùå ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            const testTask = {
                id: 'test_immediate',
                name: 'Á´ãÂç≥ÊµãËØïÊèêÈÜí',
                timeSlot: 'Á´ãÂç≥Êí≠Êîæ'
            };
            
            const testPlan = 'ÊµãËØïËÆ°Âàí';
            
            // Êí≠ÊîæÊµãËØïÂºÄÂßãÊèêÈÜí
            setTimeout(() => {
                window.voiceReminder.playStartReminder(testTask, testPlan, {
                    start: { hour: new Date().getHours(), minute: new Date().getMinutes() },
                    end: { hour: new Date().getHours(), minute: new Date().getMinutes() + 5 }
                });
            }, 1000);
            
            // 5ÁßíÂêéÊí≠ÊîæÊµãËØïÁªìÊùüÊèêÈÜí
            setTimeout(() => {
                window.voiceReminder.playEndReminder(testTask, testPlan);
            }, 6000);
            
            alert('‚úÖ ÊµãËØïÊèêÈÜíÂ∑≤ËÆæÁΩÆ\n\n1ÁßíÂêéÊí≠ÊîæÂºÄÂßãÊèêÈÜí\n6ÁßíÂêéÊí≠ÊîæÁªìÊùüÊèêÈÜí');
        }
        
        // üÜï ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊèêÈÜí
        function resetAllTimeReminders() {
            console.log('üîÑ ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊó∂Èó¥ËäÇÁÇπÊèêÈÜí...');
            
            if (!window.voiceReminder) {
                alert('‚ùå ËØ≠Èü≥ÊèêÈÜíÁ≥ªÁªüÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            try {
                // Ê∏ÖÈô§ÊâÄÊúâÁé∞ÊúâÊèêÈÜí
                window.voiceReminder.clearAllReminders();
                
                // ÈáçÊñ∞ËÆæÁΩÆÊâÄÊúâÊèêÈÜí
                if (window.studyData && window.currentStudyDate) {
                    window.voiceReminder.updateAllTaskReminders(window.studyData, window.currentStudyDate);
                    console.log('‚úÖ ÊâÄÊúâÊó∂Èó¥ËäÇÁÇπÊèêÈÜíÂ∑≤ÈáçÊñ∞ËÆæÁΩÆ');
                    
                    // Êí≠ÊîæÁ°ÆËÆ§ÊèêÈÜí
                    setTimeout(() => {
                        window.voiceReminder.speak('ÊâÄÊúâÊó∂Èó¥ËäÇÁÇπÊèêÈÜíÂ∑≤ÈáçÊñ∞ËÆæÁΩÆÂÆåÊàêÔºÅ', null, 1);
                    }, 1000);
                    
                    alert('‚úÖ ÊâÄÊúâÊó∂Èó¥ËäÇÁÇπÊèêÈÜíÂ∑≤ÈáçÊñ∞ËÆæÁΩÆÂÆåÊàêÔºÅ');
                } else {
                    alert('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞Â≠¶‰π†Êï∞ÊçÆÔºåÊó†Ê≥ïËÆæÁΩÆÊèêÈÜí');
                }
                
            } catch (error) {
                console.error('üí• ÈáçÊñ∞ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•:', error);
                alert('‚ùå ÈáçÊñ∞ËÆæÁΩÆÊèêÈÜíÂ§±Ë¥•: ' + error.message);
            }
        }

        // üÜï ==================== Â•ñÂä±Á≥ªÁªüÂäüËÉΩÂáΩÊï∞ ====================

        /**
         * Ê£ÄÊü•Âπ∂Ëß¶ÂèëÂ•ñÂä±
         * @param {number} previousPoints - ‰πãÂâçÁöÑÁßØÂàÜ
         * @param {number} currentPoints - ÂΩìÂâçÁßØÂàÜ
         */
        function checkAndTriggerRewards(previousPoints, currentPoints) {
            console.log(`üéÅ Ê£ÄÊü•Â•ñÂä±ËææÊàêÊÉÖÂÜµ: ${previousPoints} ‚Üí ${currentPoints}`);
            
            // ÊâæÂà∞Êñ∞ËææÊàêÁöÑÂ•ñÂä±
            const newRewards = rewardSettings.filter(reward => {
                return reward.requiredPoints > previousPoints && 
                       reward.requiredPoints <= currentPoints &&
                       !isRewardClaimed(reward.id);
            });
            
            // ÊåâÁßØÂàÜË¶ÅÊ±ÇÊéíÂ∫è
            newRewards.sort((a, b) => a.requiredPoints - b.requiredPoints);
            
            // ‰æùÊ¨°ÊòæÁ§∫Â•ñÂä±ÂºπÁ™ó
            newRewards.forEach((reward, index) => {
                setTimeout(() => {
                    showRewardPopup(reward);
                    
                    // Êí≠ÊîæÂ•ñÂä±ËææÊàêËØ≠Èü≥
                    if (voiceReminder && voiceReminder.isEnabled) {
                        voiceReminder.speak(`ÊÅ≠ÂñúÔºÅËææÂà∞${reward.requiredPoints}ÁßØÂàÜÔºåËé∑ÂæóÂ•ñÂä±Ôºö${reward.rewardName}`, 'encouragement');
                    }
                }, index * 1000); // ÊØè‰∏™Â•ñÂä±Èó¥Èöî1ÁßíÊòæÁ§∫
            });
            
            console.log(`üéâ ÊâæÂà∞ ${newRewards.length} ‰∏™Êñ∞Â•ñÂä±`);
        }

        /**
         * Ê£ÄÊü•Â•ñÂä±ÊòØÂê¶Â∑≤È¢ÜÂèñ
         * @param {string} rewardId - Â•ñÂä±ID
         * @returns {boolean}
         */
        function isRewardClaimed(rewardId) {
            return claimedRewards.some(claimed => claimed.rewardId === rewardId);
        }

        /**
         * ÊòæÁ§∫Â•ñÂä±ÂºπÁ™ó
         * @param {Object} reward - Â•ñÂä±ÂØπË±°
         */
        function showRewardPopup(reward) {
            const popup = document.createElement('div');
            popup.className = 'reward-popup-overlay';
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-in-out;
            `;
            
            popup.innerHTML = `
                <div class="reward-popup" style="
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    transform: scale(0.8);
                    animation: popupShow 0.3s ease-out forwards;
                ">
                    <div style="font-size: 48px; margin-bottom: 15px;">üéâ</div>
                    <h2 style="margin: 0 0 10px 0; font-size: 24px;">ÊÅ≠ÂñúËé∑ÂæóÂ•ñÂä±ÔºÅ</h2>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 15px; margin: 20px 0;">
                        <div style="font-size: 16px; margin-bottom: 8px;">ËææÊàêÁßØÂàÜÔºö<strong>${reward.requiredPoints}ÂàÜ</strong></div>
                        <div style="font-size: 18px; font-weight: bold; color: #FFD700;">üèÜ ${reward.rewardName}</div>
                        ${reward.description ? `<div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">${reward.description}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="claimReward('${reward.id}', this.parentElement.parentElement.parentElement)" 
                                style="
                                    background: linear-gradient(135deg, #51cf66, #69db7c);
                                    color: white;
                                    border: none;
                                    padding: 12px 25px;
                                    border-radius: 25px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    font-size: 16px;
                                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                                    transition: all 0.3s ease;
                                " 
                                onmouseover="this.style.transform='scale(1.05)'" 
                                onmouseout="this.style.transform='scale(1)'">
                            üéÅ È¢ÜÂèñÂ•ñÂä±
                        </button>
                        <button onclick="closeRewardPopup(this.parentElement.parentElement.parentElement)" 
                                style="
                                    background: rgba(255,255,255,0.2);
                                    color: white;
                                    border: 2px solid rgba(255,255,255,0.3);
                                    padding: 12px 25px;
                                    border-radius: 25px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    font-size: 16px;
                                    transition: all 0.3s ease;
                                " 
                                onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            Á®çÂêéÈ¢ÜÂèñ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            if (!document.querySelector('#rewardPopupStyle')) {
                const style = document.createElement('style');
                style.id = 'rewardPopupStyle';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes popupShow {
                        from { 
                            transform: scale(0.8) translateY(20px);
                            opacity: 0;
                        }
                        to { 
                            transform: scale(1) translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        /**
         * È¢ÜÂèñÂ•ñÂä±
         * @param {string} rewardId - Â•ñÂä±ID
         * @param {HTMLElement} popupElement - ÂºπÁ™óÂÖÉÁ¥†
         */
        function claimReward(rewardId, popupElement) {
            const reward = rewardSettings.find(r => r.id === rewardId);
            if (!reward) return;
            
            // ËÆ∞ÂΩïÂ∑≤È¢ÜÂèñÁöÑÂ•ñÂä±
            const claimedReward = {
                rewardId: rewardId,
                claimedAt: new Date().toISOString(),
                requiredPoints: reward.requiredPoints,
                rewardName: reward.rewardName
            };
            
            claimedRewards.push(claimedReward);
            saveRewardData();
            
            // ÊòæÁ§∫È¢ÜÂèñÊàêÂäüÊèêÁ§∫
            popupElement.querySelector('.reward-popup').innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                <h2 style="margin: 0 0 20px 0; font-size: 24px;">Â•ñÂä±È¢ÜÂèñÊàêÂäüÔºÅ</h2>
                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 25px;">
                    "${reward.rewardName}" Â∑≤Ê∑ªÂä†Âà∞ÊÇ®ÁöÑÂ•ñÂä±ËÆ∞ÂΩï‰∏≠
                </div>
                <button onclick="closeRewardPopup(this.parentElement.parentElement)" 
                        style="
                            background: linear-gradient(135deg, #51cf66, #69db7c);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-weight: bold;
                            cursor: pointer;
                            font-size: 16px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        ">
                    Á°ÆÂÆö
                </button>
            `;
            
            // Êí≠ÊîæÈ¢ÜÂèñÊàêÂäüËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`Â•ñÂä±"${reward.rewardName}"È¢ÜÂèñÊàêÂäüÔºÅ`, 'encouragement', 1);
            }
            
            // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                closeRewardPopup(popupElement);
            }, 3000);
            
            console.log('üéÅ Â•ñÂä±È¢ÜÂèñÊàêÂäü:', claimedReward);
        }

        /**
         * ÂÖ≥Èó≠Â•ñÂä±ÂºπÁ™ó
         * @param {HTMLElement} popupElement - ÂºπÁ™óÂÖÉÁ¥†
         */
        function closeRewardPopup(popupElement) {
            popupElement.style.animation = 'fadeOut 0.3s ease-in-out';
            setTimeout(() => {
                if (popupElement && popupElement.parentNode) {
                    popupElement.remove();
                }
            }, 300);
            
            // Ê∑ªÂä†fadeOutÂä®Áîª
            if (!document.querySelector('#rewardPopupFadeOut')) {
                const style = document.createElement('style');
                style.id = 'rewardPopupFadeOut';
                style.textContent = `
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        /**
         * ÊòæÁ§∫Â•ñÂä±ËÆæÁΩÆÁïåÈù¢
         */
        function showRewardSettings() {
            const modal = document.createElement('div');
            modal.className = 'reward-settings-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-in-out;
            `;
            
            modal.innerHTML = `
                <div class="reward-settings-content" style="
                    background: white;
                    border-radius: 20px;
                    padding: 25px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">üéÅ ÁßØÂàÜÂ•ñÂä±ËÆæÁΩÆ</h2>
                        <button onclick="closeRewardSettings()" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #999;
                        ">‚úï</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #666; font-size: 16px; margin-bottom: 15px;">Ê∑ªÂä†Êñ∞Â•ñÂä±</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">ÊâÄÈúÄÁßØÂàÜÔºö</label>
                                <input type="number" id="newRewardPoints" placeholder="‰æãÂ¶ÇÔºö100" min="1" style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    outline: none;
                                    transition: border-color 0.3s ease;
                                " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Â•ñÂä±ÂêçÁß∞Ôºö</label>
                                <input type="text" id="newRewardName" placeholder="‰æãÂ¶ÇÔºö‰∏Ä‰∏™Â∞èÁ§ºÂìÅ" style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    outline: none;
                                    transition: border-color 0.3s ease;
                                " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">ÊèèËø∞ÔºàÂèØÈÄâÔºâÔºö</label>
                                <input type="text" id="newRewardDescription" placeholder="‰æãÂ¶ÇÔºö‰Ω†ÊúÄÂñúÊ¨¢ÁöÑÈõ∂È£ü" style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    outline: none;
                                    transition: border-color 0.3s ease;
                                " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                            </div>
                            <button onclick="addNewReward()" style="
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 10px;
                                font-weight: bold;
                                cursor: pointer;
                                font-size: 16px;
                                transition: transform 0.2s ease;
                            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                ‚ûï Ê∑ªÂä†Â•ñÂä±
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #666; font-size: 16px; margin-bottom: 15px;">ÂΩìÂâçÂ•ñÂä±ËÆæÁΩÆ</h3>
                        <div id="rewardSettingsList" style="max-height: 300px; overflow-y: auto;">
                            ${renderRewardSettingsList()}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <h3 style="color: #666; font-size: 16px; margin-bottom: 15px;">Â∑≤È¢ÜÂèñÂ•ñÂä±ËÆ∞ÂΩï</h3>
                        <div id="claimedRewardsList" style="max-height: 200px; overflow-y: auto;">
                            ${renderClaimedRewardsList()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        /**
         * Ê∏≤ÊüìÂ•ñÂä±ËÆæÁΩÆÂàóË°®
         * @returns {string} Â•ñÂä±ÂàóË°®HTML
         */
        function renderRewardSettingsList() {
            if (rewardSettings.length === 0) {
                return '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Â•ñÂä±ËÆæÁΩÆÔºåÂø´Êù•Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Â•ñÂä±ÂêßÔºÅ</div>';
            }
            
            const sortedRewards = [...rewardSettings].sort((a, b) => a.requiredPoints - b.requiredPoints);
            
            return sortedRewards.map(reward => `
                <div style="
                    background: linear-gradient(135deg, #f8f9ff, #e8eaff);
                    padding: 15px;
                    border-radius: 15px;
                    margin-bottom: 10px;
                    border: 2px solid ${totalPoints >= reward.requiredPoints ? '#51cf66' : '#e0e0e0'};
                    position: relative;
                ">
                    ${totalPoints >= reward.requiredPoints ? '<div style="position: absolute; top: 10px; right: 15px; color: #51cf66; font-size: 20px;">‚úÖ</div>' : ''}
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px;">
                                üèÜ ${reward.rewardName}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                ÊâÄÈúÄÁßØÂàÜÔºö${reward.requiredPoints}ÂàÜ
                            </div>
                            ${reward.description ? `<div style="color: #888; font-size: 13px;">${reward.description}</div>` : ''}
                            <div style="margin-top: 8px;">
                                <span style="
                                    background: ${totalPoints >= reward.requiredPoints ? '#51cf66' : '#667eea'};
                                    color: white;
                                    padding: 4px 12px;
                                    border-radius: 15px;
                                    font-size: 12px;
                                    font-weight: bold;
                                ">
                                    ${totalPoints >= reward.requiredPoints ? 'Â∑≤ËææÊàê' : `ËøòÈúÄ ${reward.requiredPoints - totalPoints} ÂàÜ`}
                                </span>
                                ${isRewardClaimed(reward.id) ? '<span style="background: #ffa726; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 8px;">Â∑≤È¢ÜÂèñ</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 15px;">
                            <button onclick="editReward('${reward.id}')" style="
                                background: #4dabf7;
                                color: white;
                                border: none;
                                padding: 8px 12px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            " title="ÁºñËæëÊ≠§Â•ñÂä±">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteReward('${reward.id}')" style="
                                background: #ff6b6b;
                                color: white;
                                border: none;
                                padding: 8px 12px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                            " title="Âà†Èô§Ê≠§Â•ñÂä±">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Ê∏≤ÊüìÂ∑≤È¢ÜÂèñÂ•ñÂä±ÂàóË°®
         */
        function renderClaimedRewardsList() {
            if (claimedRewards.length === 0) {
                return '<div style="text-align: center; color: #999; padding: 20px;">ËøòÊ≤°ÊúâÈ¢ÜÂèñËøá‰ªª‰ΩïÂ•ñÂä±</div>';
            }
            
            const sortedClaimed = [...claimedRewards].sort((a, b) => new Date(b.claimedAt) - new Date(a.claimedAt));
            
            return sortedClaimed.map(claimed => `
                <div style="
                    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
                    padding: 12px 15px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                    border-left: 4px solid #ffa726;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; color: #333; font-size: 15px;">
                                üéÅ ${claimed.rewardName}
                            </div>
                            <div style="color: #666; font-size: 13px;">
                                ${claimed.requiredPoints}ÂàÜ ‚Ä¢ ${new Date(claimed.claimedAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <div style="color: #ffa726; font-size: 18px;">‚ú®</div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Ê∑ªÂä†Êñ∞Â•ñÂä±
         */
        function addNewReward() {
            const pointsInput = document.getElementById('newRewardPoints');
            const nameInput = document.getElementById('newRewardName');
            const descriptionInput = document.getElementById('newRewardDescription');
            
            const points = parseInt(pointsInput.value);
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();
            
            // È™åËØÅËæìÂÖ•
            if (!points || points <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁßØÂàÜÊï∞ÈáèÔºàÂ§ß‰∫é0Ôºâ');
                pointsInput.focus();
                return;
            }
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Â•ñÂä±ÂêçÁß∞');
                nameInput.focus();
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÁßØÂàÜÁöÑÂ•ñÂä±
            if (rewardSettings.some(reward => reward.requiredPoints === points)) {
                alert(`ÁßØÂàÜ ${points} ÂàÜÂ∑≤Â≠òÂú®Â•ñÂä±ËÆæÁΩÆÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑÁßØÂàÜÊï∞Èáè`);
                pointsInput.focus();
                return;
            }
            
            // ÂàõÂª∫Êñ∞Â•ñÂä±
            const newReward = {
                id: Date.now().toString(),
                requiredPoints: points,
                rewardName: name,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            rewardSettings.push(newReward);
            saveRewardData();
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            pointsInput.value = '';
            nameInput.value = '';
            descriptionInput.value = '';
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('rewardSettingsList').innerHTML = renderRewardSettingsList();
            
            // üÜï ÂêåÊó∂Êõ¥Êñ∞ÁßØÂàÜÈ°µÈù¢ÁöÑÂ•ñÂä±ÊòæÁ§∫
            updateRewardPreview();
            renderRewardListInPoints();
            
            // Êí≠ÊîæÊ∑ªÂä†ÊàêÂäüËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`Êñ∞Â•ñÂä±"${name}"Ê∑ªÂä†ÊàêÂäüÔºåËææÂà∞${points}ÂàÜÂç≥ÂèØËé∑Âæó`, 'settingConfirm', 1);
            }
            
            console.log('üéÅ Êñ∞Â•ñÂä±Ê∑ªÂä†ÊàêÂäü:', newReward);
        }

        /**
         * Âà†Èô§Â•ñÂä±
         * @param {string} rewardId - Â•ñÂä±ID
         */
        function deleteReward(rewardId) {
            const reward = rewardSettings.find(r => r.id === rewardId);
            if (!reward) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â•ñÂä±"${reward.rewardName}"ÂêóÔºü\n\n‚ö†Ô∏è Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`)) {
                rewardSettings = rewardSettings.filter(r => r.id !== rewardId);
                saveRewardData();
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('rewardSettingsList').innerHTML = renderRewardSettingsList();
                
                // üÜï ÂêåÊó∂Êõ¥Êñ∞ÁßØÂàÜÈ°µÈù¢ÁöÑÂ•ñÂä±ÊòæÁ§∫
                updateRewardPreview();
                renderRewardListInPoints();
                
                console.log('üóëÔ∏è Â•ñÂä±Âà†Èô§ÊàêÂäü:', reward);
            }
        }

        /**
         * ÂÖ≥Èó≠Â•ñÂä±ËÆæÁΩÆÁïåÈù¢
         */
        function closeRewardSettings() {
            const modal = document.querySelector('.reward-settings-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        /**
         * ‰øùÂ≠òÂ•ñÂä±Êï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
         */
        function saveRewardData() {
            localStorage.setItem('rewardSettings', JSON.stringify(rewardSettings));
            localStorage.setItem('claimedRewards', JSON.stringify(claimedRewards));
            console.log('üíæ Â•ñÂä±Êï∞ÊçÆÂ∑≤‰øùÂ≠ò');
        }

        /**
         * ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÂ•ñÂä±Êï∞ÊçÆ
         */
        function loadRewardData() {
            try {
                const savedRewardSettings = localStorage.getItem('rewardSettings');
                const savedClaimedRewards = localStorage.getItem('claimedRewards');
                
                if (savedRewardSettings) {
                    rewardSettings = JSON.parse(savedRewardSettings);
                    console.log('üì• Â•ñÂä±ËÆæÁΩÆÂ∑≤Âä†ËΩΩ:', rewardSettings.length, '‰∏™Â•ñÂä±');
                }
                
                if (savedClaimedRewards) {
                    claimedRewards = JSON.parse(savedClaimedRewards);
                    console.log('üì• Â∑≤È¢ÜÂèñÂ•ñÂä±ËÆ∞ÂΩïÂ∑≤Âä†ËΩΩ:', claimedRewards.length, '‰∏™ËÆ∞ÂΩï');
                }
                
                // ÂàùÂßãÂåñÈªòËÆ§Â•ñÂä±Ôºà‰ªÖÂú®È¶ñÊ¨°‰ΩøÁî®Êó∂Ôºâ
                if (rewardSettings.length === 0) {
                    initializeDefaultRewards();
                }
                
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÂ•ñÂä±Êï∞ÊçÆÂ§±Ë¥•:', error);
                rewardSettings = [];
                claimedRewards = [];
                initializeDefaultRewards();
            }
        }

        /**
         * ÂàùÂßãÂåñÈªòËÆ§Â•ñÂä±ËÆæÁΩÆ
         */
        function initializeDefaultRewards() {
            const defaultRewards = [
                {
                    id: 'default_100',
                    requiredPoints: 100,
                    rewardName: 'Á¨¨‰∏Ä‰∏™Â∞èÁõÆÊ†á',
                    description: 'ÈÄâÊã©‰∏Ä‰∏™‰Ω†ÂñúÊ¨¢ÁöÑÂ∞èÁ§ºÂìÅÂ•ñÂä±Ëá™Â∑±',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'default_300',
                    requiredPoints: 300,
                    rewardName: 'Â≠¶‰π†Â∞èËææ‰∫∫',
                    description: '‰∏ÄÈ°øÁæéÂë≥ÁöÑÂ§ßÈ§êÊàñËÄÖÂøÉ‰ª™ÁöÑÊñáÂÖ∑',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'default_500',
                    requiredPoints: 500,
                    rewardName: 'ÂùöÊåÅ‰∏çÊáàÂ•ñ',
                    description: '‰∏ÄÊú¨‰Ω†ÊÉ≥Ë¶ÅÁöÑ‰π¶ÊàñËÄÖ‰∏Ä‰ª∂Ë°£Êúç',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'default_1000',
                    requiredPoints: 1000,
                    rewardName: 'Â≠¶‰π†Â§ßÂ∏à',
                    description: '‰∏ÄÊ¨°Â∞èÊóÖË°åÊàñËÄÖ‰∏Ä‰∏™Â§ß‰∏ÄÁÇπÁöÑÊÑøÊúõ',
                    createdAt: new Date().toISOString()
                }
            ];
            
            rewardSettings = defaultRewards;
            saveRewardData();
            
            console.log('üéÅ ÈªòËÆ§Â•ñÂä±ËÆæÁΩÆÂ∑≤ÂàùÂßãÂåñ');
        }

        /**
         * Êõ¥Êñ∞Â•ñÂä±È¢ÑËßàÊòæÁ§∫
         */
        function updateRewardPreview() {
            const previewElement = document.getElementById('nextRewardPreview');
            if (!previewElement) return;
            
            // ÊâæÂà∞‰∏ã‰∏Ä‰∏™Êú™ËææÊàêÁöÑÂ•ñÂä±
            const unclaimedRewards = rewardSettings
                .filter(reward => !isRewardClaimed(reward.id))
                .sort((a, b) => a.requiredPoints - b.requiredPoints);
            
            const nextReward = unclaimedRewards.find(reward => reward.requiredPoints > totalPoints);
            
            if (nextReward) {
                const progress = Math.min((totalPoints / nextReward.requiredPoints) * 100, 100);
                const remaining = nextReward.requiredPoints - totalPoints;
                
                previewElement.innerHTML = `
                    <div style="margin-bottom: 8px; font-weight: bold; color: #333;">
                        üéØ ‰∏ã‰∏Ä‰∏™ÁõÆÊ†áÔºö${nextReward.rewardName}
                    </div>
                    <div style="margin-bottom: 8px; color: #666;">
                        ËøòÈúÄ ${remaining} ÁßØÂàÜÔºà${nextReward.requiredPoints}ÂàÜÔºâ
                    </div>
                    <div style="background: #e0e6ff; border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 5px;">
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            height: 100%;
                            width: ${progress}%;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    <div style="font-size: 12px; color: #888;">
                        ËøõÂ∫¶Ôºö${Math.round(progress)}%
                    </div>
                `;
            } else {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤ËææÊàê‰ΩÜÊú™È¢ÜÂèñÁöÑÂ•ñÂä±
                const unclaimedAchieved = unclaimedRewards.filter(reward => reward.requiredPoints <= totalPoints);
                
                if (unclaimedAchieved.length > 0) {
                    previewElement.innerHTML = `
                        <div style="color: #51cf66; font-weight: bold; margin-bottom: 8px;">
                            üéâ ÊÅ≠ÂñúÔºÅÊÇ®Êúâ ${unclaimedAchieved.length} ‰∏™Â•ñÂä±ÂèØ‰ª•È¢ÜÂèñ
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            ÁÇπÂáª"ËÆæÁΩÆÁßØÂàÜÂ•ñÂä±"Êü•ÁúãËØ¶ÊÉÖ
                        </div>
                    `;
                } else {
                    previewElement.innerHTML = `
                        <div style="color: #51cf66; font-weight: bold; margin-bottom: 8px;">
                            üèÜ Â§™Ê£í‰∫ÜÔºÅÊÇ®Â∑≤ÁªèËææÊàê‰∫ÜÊâÄÊúâÂ•ñÂä±ÁõÆÊ†á
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            ÂèØ‰ª•Ê∑ªÂä†Êñ∞ÁöÑÂ•ñÂä±ÁõÆÊ†áÁªßÁª≠ÊøÄÂä±Ëá™Â∑±
                        </div>
                    `;
                }
            }
        }

        /**
         * ÁºñËæëÂ•ñÂä± - ÊâìÂºÄÁºñËæëÁïåÈù¢
         * @param {string} rewardId - Ë¶ÅÁºñËæëÁöÑÂ•ñÂä±ID
         */
        function editReward(rewardId) {
            const reward = rewardSettings.find(r => r.id === rewardId);
            if (!reward) {
                alert('Êâæ‰∏çÂà∞Ë¶ÅÁºñËæëÁöÑÂ•ñÂä±ÔºÅ');
                return;
            }

            // ÂàõÂª∫ÁºñËæëÁïåÈù¢
            const editModal = document.createElement('div');
            editModal.className = 'edit-reward-modal';
            editModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-in-out;
            `;

            editModal.innerHTML = `
                <div style="
                    background: white;
                    padding: 25px;
                    border-radius: 15px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                    animation: slideInUp 0.3s ease-out;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333; font-size: 18px;">‚úèÔ∏è ÁºñËæëÂ•ñÂä±</h3>
                        <button onclick="closeEditReward()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Â•ñÂä±ÂêçÁß∞Ôºö</label>
                        <input type="text" id="editRewardName" value="${reward.rewardName}" style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            box-sizing: border-box;
                        " placeholder="ËØ∑ËæìÂÖ•Â•ñÂä±ÂêçÁß∞">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ÊâÄÈúÄÁßØÂàÜÔºö</label>
                        <input type="number" id="editRewardPoints" value="${reward.requiredPoints}" min="1" style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            box-sizing: border-box;
                        " placeholder="ËØ∑ËæìÂÖ•ÊâÄÈúÄÁßØÂàÜ">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Â•ñÂä±ÊèèËø∞Ôºö</label>
                        <textarea id="editRewardDescription" style="
                            width: 100%;
                            padding: 10px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            font-size: 14px;
                            min-height: 60px;
                            resize: vertical;
                            box-sizing: border-box;
                        " placeholder="ËØ∑ËæìÂÖ•Â•ñÂä±ÊèèËø∞ÔºàÂèØÈÄâÔºâ">${reward.description || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveEditedReward('${rewardId}')" style="
                            flex: 1;
                            padding: 12px;
                            background: #51cf66;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                            font-weight: bold;
                        ">
                            üíæ ‰øùÂ≠ò‰øÆÊîπ
                        </button>
                        <button onclick="closeEditReward()" style="
                            flex: 1;
                            padding: 12px;
                            background: #868e96;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                        ">
                            ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);
            
            // ËÅöÁÑ¶Âà∞ÂêçÁß∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('editRewardName').focus();
            }, 100);
            
            console.log('‚úèÔ∏è ÊâìÂºÄÁºñËæëÂ•ñÂä±ÁïåÈù¢:', reward);
        }

        /**
         * ‰øùÂ≠òÁºñËæëÂêéÁöÑÂ•ñÂä±
         * @param {string} rewardId - Ë¶Å‰øùÂ≠òÁöÑÂ•ñÂä±ID
         */
        function saveEditedReward(rewardId) {
            const nameInput = document.getElementById('editRewardName');
            const pointsInput = document.getElementById('editRewardPoints');
            const descriptionInput = document.getElementById('editRewardDescription');
            
            const name = nameInput.value.trim();
            const points = parseInt(pointsInput.value);
            const description = descriptionInput.value.trim();
            
            // È™åËØÅËæìÂÖ•
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Â•ñÂä±ÂêçÁß∞ÔºÅ');
                nameInput.focus();
                return;
            }
            
            if (!points || points <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁßØÂàÜÊï∞ÈáèÔºàÂ§ß‰∫é0ÔºâÔºÅ');
                pointsInput.focus();
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏éÂÖ∂‰ªñÂ•ñÂä±ÁöÑÁßØÂàÜÈáçÂ§çÔºàÊéíÈô§ÂΩìÂâçÁºñËæëÁöÑÂ•ñÂä±Ôºâ
            const existingReward = rewardSettings.find(r => r.id !== rewardId && r.requiredPoints === points);
            if (existingReward) {
                alert(`ÁßØÂàÜ ${points} ÂàÜÂ∑≤Ë¢´Â•ñÂä±"${existingReward.rewardName}"‰ΩøÁî®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑÁßØÂàÜÊï∞ÈáèÔºÅ`);
                pointsInput.focus();
                return;
            }
            
            // ÊâæÂà∞Ë¶ÅÁºñËæëÁöÑÂ•ñÂä±
            const rewardIndex = rewardSettings.findIndex(r => r.id === rewardId);
            if (rewardIndex === -1) {
                alert('Êâæ‰∏çÂà∞Ë¶ÅÁºñËæëÁöÑÂ•ñÂä±ÔºÅ');
                closeEditReward();
                return;
            }
            
            // ‰øùÂ≠òÊóßÁöÑ‰ø°ÊÅØÁî®‰∫éÊèêÁ§∫
            const oldReward = { ...rewardSettings[rewardIndex] };
            
            // Êõ¥Êñ∞Â•ñÂä±‰ø°ÊÅØ
            rewardSettings[rewardIndex] = {
                ...rewardSettings[rewardIndex],
                rewardName: name,
                requiredPoints: points,
                description: description,
                updatedAt: new Date().toISOString()
            };
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveRewardData();
            
            // Êõ¥Êñ∞Â•ñÂä±ÂàóË°®ÊòæÁ§∫
            document.getElementById('rewardSettingsList').innerHTML = renderRewardSettingsList();
            
            // ÂÖ≥Èó≠ÁºñËæëÁïåÈù¢
            closeEditReward();
            
            // üÜï ÂêåÊó∂Êõ¥Êñ∞ÁßØÂàÜÈ°µÈù¢ÁöÑÂ•ñÂä±ÊòæÁ§∫
            updateRewardPreview();
            renderRewardListInPoints();
            
            // Êí≠Êîæ‰øùÂ≠òÊàêÂäüËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`Â•ñÂä±"${name}"‰øÆÊîπÊàêÂäü`, 'settingConfirm', 1);
            }
            
            console.log('üíæ Â•ñÂä±‰øÆÊîπÊàêÂäü:', {
                old: oldReward,
                new: rewardSettings[rewardIndex]
            });
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showSuccessMessage(`üéâ Â•ñÂä±‰øÆÊîπÊàêÂäüÔºÅ\n"${oldReward.rewardName}" ‚Üí "${name}"`);
        }

        /**
         * ÂÖ≥Èó≠ÁºñËæëÂ•ñÂä±ÁïåÈù¢
         */
        function closeEditReward() {
            const editModal = document.querySelector('.edit-reward-modal');
            if (editModal) {
                editModal.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    editModal.remove();
                }, 300);
            }
        }

        /**
         * ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
         * @param {string} message - Ë¶ÅÊòæÁ§∫ÁöÑÊ∂àÊÅØ
         */
        function showSuccessMessage(message) {
            // ÂàõÂª∫ÊàêÂäüÊèêÁ§∫
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #51cf66;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-size: 16px;
                font-weight: bold;
                z-index: 10001;
                box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
                animation: bounceIn 0.5s ease-out;
                text-align: center;
                white-space: pre-line;
            `;
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            // 2ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                successDiv.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 300);
            }, 2000);
        }

        // üÜï ==================== Â•ñÂä±Á≥ªÁªüÂäüËÉΩÂáΩÊï∞ÁªìÊùü ====================

        /**
         * ‰∏äÁßª‰ªªÂä° - Â∞Ü‰ªªÂä°Âêë‰∏äÁßªÂä®‰∏Ä‰∏™‰ΩçÁΩÆ
         * @param {number} planId - ËÆ°ÂàíID 
         * @param {number} taskId - ‰ªªÂä°ID
         */
        function moveTaskUp(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            
            if (!plan) {
                console.error('Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑËÆ°Âàí');
                return;
            }
            
            const taskIndex = plan.tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) {
                console.error('Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰ªªÂä°');
                return;
            }
            
            if (taskIndex === 0) {
                // Â∑≤ÁªèÊòØÁ¨¨‰∏Ä‰∏™‰ªªÂä°ÔºåÊó†Ê≥ï‰∏äÁßª
                return;
            }
            
            // ‰∫§Êç¢ÂΩìÂâç‰ªªÂä°Âíå‰∏ä‰∏Ä‰∏™‰ªªÂä°ÁöÑ‰ΩçÁΩÆ
            const temp = plan.tasks[taskIndex];
            plan.tasks[taskIndex] = plan.tasks[taskIndex - 1];
            plan.tasks[taskIndex - 1] = temp;
            
            // ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæÊìç‰ΩúÁ°ÆËÆ§ËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`‰ªªÂä°"${temp.name}"Â∑≤‰∏äÁßª`, 'settingConfirm', 1);
            }
            
            console.log(`‚úÖ ‰ªªÂä°"${temp.name}"Â∑≤‰∏äÁßª`);
        }

        /**
         * ‰∏ãÁßª‰ªªÂä° - Â∞Ü‰ªªÂä°Âêë‰∏ãÁßªÂä®‰∏Ä‰∏™‰ΩçÁΩÆ
         * @param {number} planId - ËÆ°ÂàíID
         * @param {number} taskId - ‰ªªÂä°ID  
         */
        function moveTaskDown(planId, taskId) {
            const dateKey = getDateKey(currentStudyDate);
            const plan = studyData[dateKey]?.find(p => p.id === planId);
            
            if (!plan) {
                console.error('Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑËÆ°Âàí');
                return;
            }
            
            const taskIndex = plan.tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) {
                console.error('Êâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰ªªÂä°');
                return;
            }
            
            if (taskIndex === plan.tasks.length - 1) {
                // Â∑≤ÁªèÊòØÊúÄÂêé‰∏Ä‰∏™‰ªªÂä°ÔºåÊó†Ê≥ï‰∏ãÁßª
                return;
            }
            
            // ‰∫§Êç¢ÂΩìÂâç‰ªªÂä°Âíå‰∏ã‰∏Ä‰∏™‰ªªÂä°ÁöÑ‰ΩçÁΩÆ
            const temp = plan.tasks[taskIndex];
            plan.tasks[taskIndex] = plan.tasks[taskIndex + 1];
            plan.tasks[taskIndex + 1] = temp;
            
            // ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
            saveData();
            updateStudyDisplay();
            
            // Êí≠ÊîæÊìç‰ΩúÁ°ÆËÆ§ËØ≠Èü≥
            if (voiceReminder && voiceReminder.isEnabled) {
                voiceReminder.speak(`‰ªªÂä°"${temp.name}"Â∑≤‰∏ãÁßª`, 'settingConfirm', 1);
            }
            
            console.log(`‚úÖ ‰ªªÂä°"${temp.name}"Â∑≤‰∏ãÁßª`);
        }
    </script>
</body>
</html> 

